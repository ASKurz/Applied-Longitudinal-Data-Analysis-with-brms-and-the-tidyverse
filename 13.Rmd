---
title: 'Chapter 13. Describing Continuous-Time Event Occurrence Data'
author: "A Solomon Kurz"
date: "`r format(Sys.Date())`"
output:
  github_document
---

```{r, echo = FALSE, cache = FALSE}
options(width = 100)
```

# Describing Continuous-Time Event Occurrence Data

## 13.3 The Kaplan-Meier method of estimating the continuous-time survivor function

> The Kaplan-Meier method is a simple extension of the discrete-time method with a fundamental change: instead of rounding event times to construct the intervals, capitalize on the raw event times and construct intervals so that each contains just *one observed event time* (as shown in table 13.3). Each Kaplan-Meier interval begins at one observed event time and ends just before the next. (p. 483, *emphasis* in the original)

Load the horn honking data.

```{r, warning = F, message = F}
library(tidyverse)

honking <- 
  read_csv("data/honking.csv") %>%
  # make all names lower case
  rename_all(str_to_lower) %>% 
  mutate(censor_1 = abs(censor - 1))

glimpse(honking)
```

As discussed in the prose in the middle of page 483, here are the first three event times.

```{r}
honking %>% 
  filter(censor == 0) %>% 
  top_n(-3, seconds)
```

> The Kaplan-Meier estimate of the survivor function is obtained by applying the discrete-time estimator of section 13.2.2 to the data of these intervals. [MOst] statistical packages include a routine for computing and plotting the estimates. Numerically, the process is simple: first compute the conditional probability of event occurrence (column 7) and then successively multiply the complements of these probabilities together to obtain the Kaplan-Meier estimate of the survivor function (column 8). Because the Kaplan-Meier estimator of the survivor function is identical to the discrete-time estimator of chapter 10, its standard errors (column 9) are estimated using the same formula (pp. 483â€”485).

Load the **survival** and **broom** packages.

```{r, warning = F, message = F}
library(survival)
library(broom)
library(survminer)
```

Fit the unconditional model with the Kaplan-Meier estimator.

```{r}
kap1 <-
  survfit(data = honking,
          Surv(seconds, censor_1) ~ 1)
```

Here are the results.

```{r}
summary(kap1)
```

We can use the `broom::tidy()` function to convert that to a tidy tibble.

```{r}
k <-
  tidy(kap1)

k
```

Unlike in the text, this output does not contain the 0 interval, $[0, 1.41)$. The `time` column is the same as the "[Start" column of Table 13.3. The `n.risk` column is a direct analogue to the "n at risk" column. The `n.event` column is similar to the "n events" column in the text, but whereas the latter is cumulative, the former is not. We do not get a "$\hat p (t)$" column like in the text, but that's just a straight algebraic transform of the `estimate` column subtracted from 1. Speaking of which, our `estimate` column is an analogue of the "$\hat S(t)$" column in the text. It appears the values in our `std.error` column are a bit different from those in the text. Our last two columns mark off the 95% intervals. 

We can get a quick base **R** plot of the Kaplan-Meier survivor function with `plot()`.

```{r, fig.width = 6, fig.height = 4}
plot(kap1,
     xlab = "seconds after light turns green",
     ylab = "Kaplan-Meier survivor function")
```

With the **ggplot2** paradigm, one can make a Kaplan-Meier survivor function with the `survminer::ggsurvplot()` function.

```{r, fig.width = 6, fig.height = 4, warning = F}
ggsurvplot(kap1, data = honking,
           color = "grey25",
           size = 1/2,
           xlim = c(0, 20),
           break.time.by = 5,
           legend = "none",
           ggtheme = theme_gray() + 
             theme(panel.grid = element_blank())) +
  labs(x = "seconds after light turns green",
       y = "Kaplan-Meier survivor function")
```











## Reference {-}

[Singer, J. D., & Willett, J. B. (2003). *Applied longitudinal data analysis: Modeling change and event occurrence*. New York, NY, US: Oxford University Press.](https://www.oxfordscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968)

## Session info {-}

```{r}
sessionInfo()
```

```{r, echo = F, eval = F}
# here we'll remove our objects
rm()

theme_set(theme_grey())
```

