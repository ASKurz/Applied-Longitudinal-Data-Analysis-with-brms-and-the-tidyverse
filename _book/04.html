<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Doing Data Analysis with the Multilevel Model for Change – *Applied longitudinal data analysis* in brms and the tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05.html" rel="next">
<link href="./03.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d082c015fa132ca880f975003d7bf2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="4&nbsp; Doing Data Analysis with the Multilevel Model for Change – Applied longitudinal data analysis in brms and the tidyverse">
<meta property="og:description" content="">
<meta property="og:image" content="https://solomon.quarto.pub/alda/04_files/figure-html/unnamed-chunk-3-1.png">
<meta property="og:site_name" content="*Applied longitudinal data analysis* in brms and the tidyverse">
<meta property="og:image:height" content="768">
<meta property="og:image:width" content="1344">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Doing Data Analysis with the Multilevel Model for Change</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Applied longitudinal data analysis</em> in brms and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What and why</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">A Framework for Investigating Change over Time</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploring Longitudinal Data on Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introducing the Multilevel Model for Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Doing Data Analysis with the Multilevel Model for Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Treating Time More Flexibly</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modeling Discontinuous and Nonlinear Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Examining the Multilevel Model’s Error Covariance Structure</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modeling Change Using Covariance Structure Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">A Framework for Investigating Event Occurrence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Describing Discrete-Time Event Occurrence Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fitting Basic Discrete-Time Hazard Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Extending the Discrete-Time Hazard Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Describing Continuous-Time Event Occurrence Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#example-changes-in-adolescent-alcohol-use" id="toc-example-changes-in-adolescent-alcohol-use" class="nav-link active" data-scroll-target="#example-changes-in-adolescent-alcohol-use"><span class="header-section-number">4.1</span> Example: Changes in adolescent alcohol use</a></li>
  <li><a href="#the-composite-specification-of-the-multilevel-model-for-change" id="toc-the-composite-specification-of-the-multilevel-model-for-change" class="nav-link" data-scroll-target="#the-composite-specification-of-the-multilevel-model-for-change"><span class="header-section-number">4.2</span> The composite specification of the multilevel model for change</a>
  <ul>
  <li><a href="#the-structural-component-of-the-composite-model" id="toc-the-structural-component-of-the-composite-model" class="nav-link" data-scroll-target="#the-structural-component-of-the-composite-model"><span class="header-section-number">4.2.1</span> The structural component of the composite model</a></li>
  <li><a href="#the-stochastic-component-of-the-composite-model" id="toc-the-stochastic-component-of-the-composite-model" class="nav-link" data-scroll-target="#the-stochastic-component-of-the-composite-model"><span class="header-section-number">4.2.2</span> The stochastic component of the composite model</a></li>
  </ul></li>
  <li><a href="#sec-Methods-of-estimation-revisited" id="toc-sec-Methods-of-estimation-revisited" class="nav-link" data-scroll-target="#sec-Methods-of-estimation-revisited"><span class="header-section-number">4.3</span> Methods of estimation, revisited</a></li>
  <li><a href="#first-steps-fitting-two-unconditional-multilevel-models-for-change" id="toc-first-steps-fitting-two-unconditional-multilevel-models-for-change" class="nav-link" data-scroll-target="#first-steps-fitting-two-unconditional-multilevel-models-for-change"><span class="header-section-number">4.4</span> First steps: Fitting two unconditional multilevel models for change</a>
  <ul>
  <li><a href="#the-unconditional-means-model" id="toc-the-unconditional-means-model" class="nav-link" data-scroll-target="#the-unconditional-means-model"><span class="header-section-number">4.4.1</span> The unconditional means model</a></li>
  <li><a href="#the-unconditional-growth-model" id="toc-the-unconditional-growth-model" class="nav-link" data-scroll-target="#the-unconditional-growth-model"><span class="header-section-number">4.4.2</span> The unconditional growth model</a></li>
  <li><a href="#quantifying-the-proportion-of-outcome-variation-explained" id="toc-quantifying-the-proportion-of-outcome-variation-explained" class="nav-link" data-scroll-target="#quantifying-the-proportion-of-outcome-variation-explained"><span class="header-section-number">4.4.3</span> Quantifying the proportion of outcome variation “explained”</a>
  <ul>
  <li><a href="#an-overall-summary-of-total-outcome-variability-explained" id="toc-an-overall-summary-of-total-outcome-variability-explained" class="nav-link" data-scroll-target="#an-overall-summary-of-total-outcome-variability-explained"><span class="header-section-number">4.4.3.1</span> An overall summary of total outcome variability explained</a></li>
  <li><a href="#pseudo-r2-statistics-computed-from-the-variance-components" id="toc-pseudo-r2-statistics-computed-from-the-variance-components" class="nav-link" data-scroll-target="#pseudo-r2-statistics-computed-from-the-variance-components"><span class="header-section-number">4.4.3.2</span> Pseudo-<span class="math inline">\(R^2\)</span> statistics computed from the variance components</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#practical-data-analytic-strategies-for-model-building" id="toc-practical-data-analytic-strategies-for-model-building" class="nav-link" data-scroll-target="#practical-data-analytic-strategies-for-model-building"><span class="header-section-number">4.5</span> Practical data analytic strategies for model building</a>
  <ul>
  <li><a href="#a-taxonomy-of-statistical-models" id="toc-a-taxonomy-of-statistical-models" class="nav-link" data-scroll-target="#a-taxonomy-of-statistical-models"><span class="header-section-number">4.5.1</span> A taxonomy of statistical models</a></li>
  <li><a href="#interpreting-fitted-models" id="toc-interpreting-fitted-models" class="nav-link" data-scroll-target="#interpreting-fitted-models"><span class="header-section-number">4.5.2</span> Interpreting fitted models</a>
  <ul>
  <li><a href="#model-c-the-uncontrolled-effects-of-coa" id="toc-model-c-the-uncontrolled-effects-of-coa" class="nav-link" data-scroll-target="#model-c-the-uncontrolled-effects-of-coa"><span class="header-section-number">4.5.2.1</span> Model C: The uncontrolled effects of COA</a></li>
  <li><a href="#model-d-the-controlled-effects-of-coa" id="toc-model-d-the-controlled-effects-of-coa" class="nav-link" data-scroll-target="#model-d-the-controlled-effects-of-coa"><span class="header-section-number">4.5.2.2</span> Model D: The controlled effects of COA</a></li>
  <li><a href="#model-e-a-tentative-final-model-for-the-controlled-effects-of-coa" id="toc-model-e-a-tentative-final-model-for-the-controlled-effects-of-coa" class="nav-link" data-scroll-target="#model-e-a-tentative-final-model-for-the-controlled-effects-of-coa"><span class="header-section-number">4.5.2.3</span> Model E: A tentative “final model” for the controlled effects of <code>coa</code></a></li>
  </ul></li>
  <li><a href="#displaying-prototypical-change-trajectories" id="toc-displaying-prototypical-change-trajectories" class="nav-link" data-scroll-target="#displaying-prototypical-change-trajectories"><span class="header-section-number">4.5.3</span> Displaying prototypical change trajectories</a></li>
  <li><a href="#recentering-predictors-to-improve-interpretation" id="toc-recentering-predictors-to-improve-interpretation" class="nav-link" data-scroll-target="#recentering-predictors-to-improve-interpretation"><span class="header-section-number">4.5.4</span> Recentering predictors to improve interpretation</a></li>
  </ul></li>
  <li><a href="#comparing-models-using-deviance-statistics" id="toc-comparing-models-using-deviance-statistics" class="nav-link" data-scroll-target="#comparing-models-using-deviance-statistics"><span class="header-section-number">4.6</span> Comparing models using deviance statistics</a>
  <ul>
  <li><a href="#the-deviance-statistic" id="toc-the-deviance-statistic" class="nav-link" data-scroll-target="#the-deviance-statistic"><span class="header-section-number">4.6.1</span> The deviance statistic</a></li>
  <li><a href="#when-and-how-can-you-compare-deviance-statistics" id="toc-when-and-how-can-you-compare-deviance-statistics" class="nav-link" data-scroll-target="#when-and-how-can-you-compare-deviance-statistics"><span class="header-section-number">4.6.2</span> When and how can you compare deviance statistics?</a></li>
  <li><a href="#implementing-deviance-based-hypothesis-tests" id="toc-implementing-deviance-based-hypothesis-tests" class="nav-link" data-scroll-target="#implementing-deviance-based-hypothesis-tests"><span class="header-section-number">4.6.3</span> Implementing deviance-based hypothesis tests</a></li>
  <li><a href="#aic-and-bic-waic-and-loo-statistics-comparing-nonnested-models-using-information-criteria-and-cross-validation" id="toc-aic-and-bic-waic-and-loo-statistics-comparing-nonnested-models-using-information-criteria-and-cross-validation" class="nav-link" data-scroll-target="#aic-and-bic-waic-and-loo-statistics-comparing-nonnested-models-using-information-criteria-and-cross-validation"><span class="header-section-number">4.6.4</span> <del>AIC and BIC</del> WAIC and LOO statistics: Comparing nonnested models using information criteria [and cross validation]</a>
  <ul>
  <li><a href="#the-widely-applicable-information-criterion-waic" id="toc-the-widely-applicable-information-criterion-waic" class="nav-link" data-scroll-target="#the-widely-applicable-information-criterion-waic"><span class="header-section-number">4.6.4.1</span> The Widely Applicable Information Criterion (WAIC)</a></li>
  <li><a href="#leave-one-out-cross-validation-loo-cv" id="toc-leave-one-out-cross-validation-loo-cv" class="nav-link" data-scroll-target="#leave-one-out-cross-validation-loo-cv"><span class="header-section-number">4.6.4.2</span> Leave-one-out cross-validation (LOO-CV)</a></li>
  <li><a href="#you-can-compare-bayesian-models-with-the-waic-and-loo" id="toc-you-can-compare-bayesian-models-with-the-waic-and-loo" class="nav-link" data-scroll-target="#you-can-compare-bayesian-models-with-the-waic-and-loo"><span class="header-section-number">4.6.4.3</span> You can compare Bayesian models with the WAIC and LOO</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#using-wald-statistics-to-test-composite-hypotheses-about-fixed-effects" id="toc-using-wald-statistics-to-test-composite-hypotheses-about-fixed-effects" class="nav-link" data-scroll-target="#using-wald-statistics-to-test-composite-hypotheses-about-fixed-effects"><span class="header-section-number">4.7</span> Using Wald statistics to test composite hypotheses about fixed effects</a></li>
  <li><a href="#evaluating-the-tenability-of-a-models-assumptions" id="toc-evaluating-the-tenability-of-a-models-assumptions" class="nav-link" data-scroll-target="#evaluating-the-tenability-of-a-models-assumptions"><span class="header-section-number">4.8</span> Evaluating the tenability of a model’s assumptions</a>
  <ul>
  <li><a href="#checking-functional-form" id="toc-checking-functional-form" class="nav-link" data-scroll-target="#checking-functional-form"><span class="header-section-number">4.8.1</span> Checking functional form</a></li>
  <li><a href="#checking-normality" id="toc-checking-normality" class="nav-link" data-scroll-target="#checking-normality"><span class="header-section-number">4.8.2</span> Checking normality</a></li>
  <li><a href="#checking-homoscedasticity" id="toc-checking-homoscedasticity" class="nav-link" data-scroll-target="#checking-homoscedasticity"><span class="header-section-number">4.8.3</span> Checking homoscedasticity</a></li>
  </ul></li>
  <li><a href="#model-based-empirical-bayes-estimates-of-the-individual-growth-parameters" id="toc-model-based-empirical-bayes-estimates-of-the-individual-growth-parameters" class="nav-link" data-scroll-target="#model-based-empirical-bayes-estimates-of-the-individual-growth-parameters"><span class="header-section-number">4.9</span> Model-based (Empirical Bayes) estimates of the individual growth parameters</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Doing Data Analysis with the Multilevel Model for Change</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>“We now delve deeper into the specification, estimation, and interpretation of the multilevel model for change” <span class="citation" data-cites="singerAppliedLongitudinalData2003">(<a href="references.html#ref-singerAppliedLongitudinalData2003" role="doc-biblioref">Singer &amp; Willett, 2003, p. 75</a>)</span>.</p>
<section id="example-changes-in-adolescent-alcohol-use" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="example-changes-in-adolescent-alcohol-use"><span class="header-section-number">4.1</span> Example: Changes in adolescent alcohol use</h2>
<p>Load the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/alcohol1_pp.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(alcohol1_pp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
     id   age   coa  male age_14 alcuse  peer  cpeer  ccoa
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     1    14     1     0      0   1.73 1.26   0.247 0.549
2     1    15     1     0      1   2    1.26   0.247 0.549
3     1    16     1     0      2   2    1.26   0.247 0.549
4     2    14     1     1      0   0    0.894 -0.124 0.549
5     2    15     1     1      1   0    0.894 -0.124 0.549
6     2    16     1     1      2   1    0.894 -0.124 0.549</code></pre>
</div>
</div>
<p>Do note we already have an <span class="math inline">\((\text{age} - 14)\)</span> variable in the data, <code>age_14</code>.</p>
<p>Here’s our version of Figure 4.1, using <code>stat_smooth()</code> to get the exploratory OLS trajectories.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">14</span>, <span class="dv">23</span>, <span class="dv">32</span>, <span class="dv">41</span>, <span class="dv">56</span>, <span class="dv">65</span>, <span class="dv">82</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> alcuse)) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> F) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>By this figure, Singer and Willett suggested the simple linear level-1 submodel following the form</p>
<p><span class="math display">\[\begin{align}
\text{alcuse}_{ij} &amp; = \pi_{0i} + \pi_{1i} (\text{age}_{ij} - 14) + \epsilon_{ij}\\
\epsilon_{ij}      &amp; \sim \operatorname{Normal}(0, \sigma_\epsilon^2),
\end{align}\]</span></p>
<p>where <span class="math inline">\(\pi_{0i}\)</span> is the initial status of participant <span class="math inline">\(i\)</span>, <span class="math inline">\(\pi_{1i}\)</span> is participant <span class="math inline">\(i\)</span>’s rate of change, and <span class="math inline">\(\epsilon_{ij}\)</span> is the variation in participant <span class="math inline">\(i\)</span>’s data not accounted for in the model.</p>
<p>Singer and Willett made their Figure 4.2 “with a random sample of 32 of the adolescents” (p.&nbsp;78). If we just wanted a random sample of rows, the <code>sample_n()</code> function would do the job. But since we’re working with long data, we’ll need some <code>group_by()</code> + <code>nest()</code> mojo. I got the trick from <a href="https://jennybryan.org/">Jenny Bryan</a>’s vignette, <a href="https://jennybc.github.io/purrr-tutorial/ls12_different-sized-samples.html"><em>Sample from groups, n varies by group</em></a>. Setting the seed makes the results from <code>sample_n()</code> reproducible. Here are the top panels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="dv">32</span>, <span class="at">replace =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">coa =</span> <span class="fu">ifelse</span>(coa <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"coa = 0"</span>, <span class="st">"coa = 1"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> alcuse, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> F, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> coa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We have similar data wrangling needs for the bottom panels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="dv">32</span>, <span class="at">replace =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hp =</span> <span class="fu">ifelse</span>(peer <span class="sc">&lt;</span> <span class="fu">mean</span>(peer), <span class="st">"low peer"</span>, <span class="st">"high peer"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hp =</span> <span class="fu">factor</span>(hp, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"low peer"</span>, <span class="st">"high peer"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> alcuse, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> F, <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> hp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Based on the exploratory analyses, Singer and Willett posited the initial level-2 submodel might take the form</p>
<p><span class="math display">\[\begin{align}
\pi_{0i} &amp; = \gamma_{00} + \gamma_{01} \text{coa}_i + \zeta_{0i}\\
\pi_{1i} &amp; = \gamma_{10} + \gamma_{11} \text{coa}_i + \zeta_{1i} \\

\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \operatorname{Normal} \begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0^2 &amp; \sigma_{01}\\ \sigma_{01} &amp; \sigma_1^2 \end{bmatrix}
\end{pmatrix},
\end{align}\]</span></p>
<p>where <span class="math inline">\(\gamma_{00}\)</span> and <span class="math inline">\(\gamma_{10}\)</span> are the level-2 intercepts, the population averages when <span class="math inline">\(\text{coa} = 0\)</span>, <span class="math inline">\(\gamma_{10}\)</span> and <span class="math inline">\(\gamma_{11}\)</span> are the level-2 slopes expressing the difference when <span class="math inline">\(\text{coa} = 1\)</span> and <span class="math inline">\(\zeta_{0i}\)</span> and <span class="math inline">\(\zeta_{1i}\)</span> are the unexplained variation across the <span class="math inline">\(\text{id}\)</span>-level intercepts and slopes. Since we’ll be fitting the model with <code>brms::brm()</code>, the <span class="math inline">\(\Sigma\)</span> matrix will be parameterized in terms of standard deviations and their correlation. So we might re-express the model as</p>
<p><span class="math display">\[\begin{align}
\pi_{0i} &amp; = \gamma_{00} + \gamma_{01} \text{coa}_i + \zeta_{0i}\\
\pi_{1i} &amp; = \gamma_{10} + \gamma_{11} \text{coa}_i + \zeta_{1i} \\

\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \operatorname{Normal} \begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0 &amp; \rho_{01}\\ \rho_{01} &amp; \sigma_1 \end{bmatrix}
\end{pmatrix}.
\end{align}\]</span></p>
</section>
<section id="the-composite-specification-of-the-multilevel-model-for-change" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="the-composite-specification-of-the-multilevel-model-for-change"><span class="header-section-number">4.2</span> The composite specification of the multilevel model for change</h2>
<p>With a little algebra, we can combine the level-1 and level-2 submodels into the composite multilevel model for change, which follows the form</p>
<p><span class="math display">\[\begin{align}
\text{alcuse}_{ij} &amp; = \big [ \gamma_{00} + \gamma_{10} \text{age\_14}_{ij} + \gamma_{01} \text{coa}_i + \gamma_{11} (\text{coa}_i \times \text{age\_14}_{ij}) \big ] \\
&amp; \;\;\;\;\; + [ \zeta_{0i} + \zeta_{1i} \text{age\_14}_{ij} + \epsilon_{ij} ] \\
\epsilon_{ij} &amp; \sim \operatorname{Normal} (0, \sigma_\epsilon^2) \\

\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \operatorname{Normal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0^2 &amp; \sigma_{01} \\ \sigma_{01} &amp; \sigma_1^2 \end{bmatrix}
\end{pmatrix},
\end{align}\]</span></p>
<p>where the brackets in the first line partition the structural model (i.e., the model for <span class="math inline">\(\mu\)</span>) and the stochastic components (i.e., the <span class="math inline">\(\sigma\)</span> terms). We should note that this is the format that most closely mirrors what we use in the <code>formula</code> argument in <code>brms::brm()</code>. As long as <code>age</code> is not centered on the mean, our <strong>brms</strong> syntax would be: <code>formula = alcuse ~ 0 + Intercept + age_c + coa + age_c:coa + (1 + age_c | id)</code>.</p>
<section id="the-structural-component-of-the-composite-model" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="the-structural-component-of-the-composite-model"><span class="header-section-number">4.2.1</span> The structural component of the composite model</h3>
<blockquote class="blockquote">
<p>Although their interpretation is identical, the <span class="math inline">\(\gamma\)</span>s in the composite model describe patterns of change in a different way. Rather than postulating first how <em>ALCUSE</em> is related to <em>TIME</em> and the individual growth parameters, and second how the individual growth parameters are related to <em>COA</em>, the composite specification in equation 4.3 postulates that <em>ALCUSE</em> depends <em>simultaneously</em> on: (1) the level-1 predictor, <em>TIME</em>; (2) the level-2 predictor, <em>COA</em>; and (3) the <em>cross-level</em> interaction, <em>COA</em> by <em>TIME</em>. From this perspective, the composite model’s structural portion strongly resembles a regular regression model with predictors, <em>TIME</em> and <em>COA</em>, appearing as main effects (associated with <span class="math inline">\(\gamma_{10}\)</span> and <span class="math inline">\(\gamma_{01}\)</span>, respectively) and in a <em>cross-level</em> interaction (associated with <span class="math inline">\(\gamma_{11}\)</span>). (p.&nbsp;82, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
<section id="the-stochastic-component-of-the-composite-model" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="the-stochastic-component-of-the-composite-model"><span class="header-section-number">4.2.2</span> The stochastic component of the composite model</h3>
<blockquote class="blockquote">
<p>A distinctive feature of the composite multilevel model is its composite residual, the three terms in the second set of brackets on the right of equation 4.3 that combine together the level-1 residual and the two level-2 residuals:</p>
<p><span class="math display">\[\text{Composite residual: } [ \zeta_{0i} +  \zeta_{1i} \text{age\_14}_{ij} + \epsilon_{ij} ].\]</span> The composite residual is not a simple sum. Instead, the second level-2 residual, <span class="math inline">\(\zeta_{1i}\)</span>, is multiplied by the level-1 predictor, <span class="math inline">\([\text{age\_14}_{ij}]\)</span>, before joining its siblings. Despite its unusual construction, the interpretation of the composite residual is straightforward: it describes the difference between the observed and expected value of <span class="math inline">\([\text{alcuse}]\)</span> for individual <span class="math inline">\(i\)</span> on occasion <span class="math inline">\(j\)</span>.</p>
<p>The mathematical form of the composite residual reveals two important properties about the occasion-specific residuals not readily apparent in the level-1/level-2 specification: they can be both <em>autocorrelated</em> and <em>heteroscedastic</em> within person. (p.&nbsp;84, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
</section>
<section id="sec-Methods-of-estimation-revisited" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-Methods-of-estimation-revisited"><span class="header-section-number">4.3</span> Methods of estimation, revisited</h2>
<p>In this section, the authors introduced generalized least squares (GLS) estimation and iterative generalized least squares (IGLS) estimation and then distinguished between full and restricted maximum likelihood estimation. Since our goal is to fit these models as Bayesians, we won’t be using or discussing any of these in this project. There are, of course, different ways to approach Bayesian estimation. Though we’re using Hamiltonian Monte Carlo, we could use other algorithms, such as the Gibbs sampler. However, all that is outside of the scope of this project.</p>
<p>I suppose the only thing to add is that whereas GLS estimates come from minimizing a weighted function of the residuals and maximum likelihood estimates come from maximizing the log-likelihood function, the results of our Bayesian analyses (i.e., the posterior distribution) come from the consequences of Bayes’ theorem,</p>
<p><span class="math display">\[
p(\theta \mid d) = \frac{p(d \mid \theta)\ p(\theta)}{p(d)}.
\]</span></p>
<p>If you really want to dive into the details of this, I suggest referencing a proper introductory Bayesian textbook, such as McElreath <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2015 mcelreathStatisticalRethinkingBayesian2020">(<a href="references.html#ref-mcelreathStatisticalRethinkingBayesian2015" role="doc-biblioref">2015</a>, <a href="references.html#ref-mcelreathStatisticalRethinkingBayesian2020" role="doc-biblioref">2020</a>)</span>, Kruschke <span class="citation" data-cites="kruschkeDoingBayesianData2015">(<a href="references.html#ref-kruschkeDoingBayesianData2015" role="doc-biblioref">2015</a>)</span>, or <span class="citation" data-cites="gelman2013bayesian">Gelman et al. (<a href="references.html#ref-gelman2013bayesian" role="doc-biblioref">2013</a>)</span>. I haven’t had time to check it out, but I’ve heard Labmert’s <span class="citation" data-cites="lambertAStudentsGuidetoBayes2018">(<a href="references.html#ref-lambertAStudentsGuidetoBayes2018" role="doc-biblioref">2018</a>)</span> text is good, too. And for details specific to Stan, and thus <strong>brms</strong>, you might check out the documentation resources at <a href="https://mc-stan.org/users/documentation/">https://mc-stan.org/users/documentation/</a>.</p>
</section>
<section id="first-steps-fitting-two-unconditional-multilevel-models-for-change" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="first-steps-fitting-two-unconditional-multilevel-models-for-change"><span class="header-section-number">4.4</span> First steps: Fitting two unconditional multilevel models for change</h2>
<p>Singer and Willett recommended that before you fit your full theoretical multilevel model of change–the one with all the interesting covariates–you should fit two simpler preliminary models. The first is the <em>unconditional means model</em>. The second is the <em>unconditional growth model</em>.</p>
<p>I agree. In addition to the reasons they cover in the text, this is just good pragmatic data analysis. Start simple and build up to the more complicated models only after you’re confident you understand what’s going on with the simpler ones. And if you’re new to them, you’ll discover this is especially so with Bayesian methods.</p>
<section id="the-unconditional-means-model" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="the-unconditional-means-model"><span class="header-section-number">4.4.1</span> The unconditional means model</h3>
<p>The likelihood for the unconditional means model follows the formula</p>
<p><span class="math display">\[
\begin{align}
\text{alcuse}_{ij} &amp; =  \gamma_{00} +  \zeta_{0i} + \epsilon_{ij} \\
\epsilon_{ij}      &amp; \sim \operatorname{Normal}(0, \sigma_\epsilon^2) \\
\zeta_{0i}         &amp; \sim \operatorname{Normal}(0, \sigma_0^2).
\end{align}
\]</span></p>
<p>Let’s open <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Up till this point, we haven’t focused on priors. It would have been reasonable to wonder if we’d been using them at all. Yes, we have. Even if you don’t specify priors in the <code>brm()</code> function, it’ll compute default weakly-informative priors for you. You might be wondering, <em>What might these default priors look like?</em> The <code>get_prior()</code> function let us take a look.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(<span class="at">data =</span> alcohol1_pp, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> gaussian,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>          alcuse <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub tag       source
 student_t(3, 1, 2.5) Intercept                                                default
 student_t(3, 0, 2.5)        sd                                  0             default
 student_t(3, 0, 2.5)        sd              id                  0        (vectorized)
 student_t(3, 0, 2.5)        sd Intercept    id                  0        (vectorized)
 student_t(3, 0, 2.5)     sigma                                  0             default</code></pre>
</div>
</div>
<p>For this model, all three priors are based on Student’s <span class="math inline">\(t\)</span>-distribution. In case you’re rusty, the normal distribution is just a special case of Student’s <span class="math inline">\(t\)</span>-distribution. Whereas the normal is defined by two parameters (<span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>), the <span class="math inline">\(t\)</span> distribution is defined by <span class="math inline">\(\nu\)</span>, <span class="math inline">\(\mu\)</span>, and <span class="math inline">\(\sigma\)</span>. In frequentist circles, <span class="math inline">\(\nu\)</span> is often called the <em>degrees of freedom</em>. More generally, it’s also referred to as a <em>normality</em> parameter. We’ll examine the prior more closely in a bit.</p>
<p>For now, let’s practice setting our priors by manually specifying them within <code>brm()</code>. You do with the <code>prior</code> argument. There are actually several ways to do this. To explore all the options, check out the <code>set_prior</code> section of the <a href="https://CRAN.R-project.org/package=brms/brms.pdf"><strong>brms</strong> reference manual</a> <span class="citation" data-cites="brms2021RM">(<a href="references.html#ref-brms2021RM" role="doc-biblioref">Bürkner, 2021</a>)</span>. I typically define my individual priors with the <code>prior()</code> function. When there are more than one priors to define, I typically bind them together within <code>c(...)</code>.</p>
<p>Other than the addition of our fancy <code>prior</code> statement, the rest of the settings within <code>brm()</code> are much like those in prior chapters. Let’s fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="fl">2.5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sd),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: alcuse ~ 1 + (1 | id) 
   Data: alcohol1_pp (Number of observations: 246) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 82) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.77      0.08     0.62     0.94 1.00     1435     1909

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.92      0.10     0.73     1.11 1.00     2339     2661

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.76      0.04     0.68     0.84 1.00     3111     3184

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Compare the results to those listed under “Model A” in Table 4.1. It’s important to keep in mind that <strong>brms</strong> returns ‘sigma’ and ‘sd(Intercept)’ in the standard deviation metric rather than the variance metric. “<em>But I want them in the variance metric like in the text!</em>”, you say. Okay fine. The best way to do the transformations is after saving the results from <code>as_draws_df()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.1</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># first 12 columns</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws[, <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 12
$ b_Intercept         &lt;dbl&gt; 0.9260752, 0.8988015, 0.7792639, 0.9267970, 1.0072838, 1.0562188, 1.0780959, 0.9407926, 0.8587646, 1…
$ sd_id__Intercept    &lt;dbl&gt; 0.6292301, 0.8677994, 0.7717634, 0.7467758, 0.8470288, 0.7486265, 0.8325376, 0.8884310, 0.7528115, 0…
$ sigma               &lt;dbl&gt; 0.7599271, 0.8144932, 0.7414686, 0.7462817, 0.7440307, 0.7267132, 0.7605753, 0.7747775, 0.7484712, 0…
$ Intercept           &lt;dbl&gt; 0.9260752, 0.8988015, 0.7792639, 0.9267970, 1.0072838, 1.0562188, 1.0780959, 0.9407926, 0.8587646, 1…
$ `r_id[1,Intercept]` &lt;dbl&gt; 0.56563626, 1.05765351, 0.32009632, 1.01302426, 1.12657098, 0.73703012, 0.61667144, 0.70950858, 0.57…
$ `r_id[2,Intercept]` &lt;dbl&gt; 0.14035689, -1.04326905, 0.20125180, -1.04240101, -0.96516047, -0.38975280, -0.32878521, -0.64058597…
$ `r_id[3,Intercept]` &lt;dbl&gt; 0.71379397, 1.08655936, 0.46016312, 1.20593498, 1.02992133, 0.53444476, 0.85255220, 0.72442600, 1.22…
$ `r_id[4,Intercept]` &lt;dbl&gt; 0.65146382, -0.18945701, 0.36695755, 0.12656534, 0.44032227, -0.52046316, -0.32618081, 0.54323995, -…
$ `r_id[5,Intercept]` &lt;dbl&gt; -0.57232307, -0.71108942, -1.13825886, -0.28109246, 0.03749920, -0.08587860, -0.85565527, -0.3308069…
$ `r_id[6,Intercept]` &lt;dbl&gt; 1.2239650, 1.9661097, 1.6771725, 1.4380018, 1.5282743, 1.9311362, 1.4623721, 1.2316318, 1.3831150, 1…
$ `r_id[7,Intercept]` &lt;dbl&gt; 0.4836527, 0.8445632, 0.1372376, 0.9000158, 1.1413053, 0.7295728, 0.4994844, 0.6001993, 0.8965447, 0…
$ `r_id[8,Intercept]` &lt;dbl&gt; -0.3678699, -0.8601715, -0.3067060, -1.0642781, -1.0739491, -0.6637780, -0.4680221, -1.0934336, -0.6…</code></pre>
</div>
</div>
<p>Since all we’re interested in are the variance components, we’ll <code>select()</code> out the relevant columns from <code>draws</code>, compute the squared versions, and save the results in a mini data frame, <code>v</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sigma, sd_id__Intercept) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">sigma_2_0       =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  sigma sd_id__Intercept sigma_2_epsilon sigma_2_0
  &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;
1 0.760            0.629           0.577     0.396
2 0.814            0.868           0.663     0.753
3 0.741            0.772           0.550     0.596
4 0.746            0.747           0.557     0.558
5 0.744            0.847           0.554     0.717
6 0.727            0.749           0.528     0.560</code></pre>
</div>
</div>
<p>We can view their distributions like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.25</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fl">1.25</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>In case it’s hard to follow what just happened, the estimates in the <strong>brms</strong>-default standard-deviation metric are the two panels on the top. Those on the bottom are in the Singer-and-Willett style variance metric. Like we discussed toward the end of last chapter, the variance parameters won’t often be Gaussian. In my experience, they’re typically skewed to the right. There’s nothing wrong with that. This is a recurrent pattern among distributions that are constrained to be zero and above.</p>
<p>If you’re interested, you can summarize those posteriors like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(value),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(value),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this last bit just rounds the output</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  name              mean median    sd    ll    ul
  &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 sd_id__Intercept 0.766  0.76  0.083 0.617 0.942
2 sigma            0.756  0.754 0.042 0.678 0.844
3 sigma_2_0        0.594  0.577 0.13  0.381 0.887
4 sigma_2_epsilon  0.573  0.569 0.065 0.46  0.713</code></pre>
</div>
</div>
<p>For this model, our posterior medians are closer to the estimates in the text (Table 4.1) than the means. However, our posterior standard deviations are pretty close to the standard errors in the text.</p>
<p>One of the advantages of our Bayesian method is that when we compute something like the intraclass correlation coefficient <span class="math inline">\(\rho\)</span>, we get an entire distribution for the parameter rather than a measly point estimates. This is always the case with Bayes. The algebraic transformations of the posterior distribution are themselves distributions. Before we compute <span class="math inline">\(\rho\)</span>, do pay close attention to the formula,</p>
<p><span class="math display">\[
\rho = \frac{\sigma_0^2}{\sigma_0^2 + \sigma_\epsilon^2}.
\]</span></p>
<p>Even though our <strong>brms</strong> output yields the variance parameters in the standard-deviation metric, the formula for <span class="math inline">\(\rho\)</span> demands we use variances. That’s nothing a little squaring can’t fix. Here’s what our <span class="math inline">\(\rho\)</span> looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">rho =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rho)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(rho), <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Though the posterior for <span class="math inline">\(\rho\)</span> is indeed centered around .5, look at how wide and uncertain that distribution is. The bulk of the posterior mass takes up almost half of the parameter space. If you wanted the summary statistics, you might do what we did for the variance parameters, above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">rho =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(rho),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(rho),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(rho),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(rho, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(rho, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
   mean median    sd    ll    ul
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 0.505  0.506 0.063  0.38 0.624</code></pre>
</div>
</div>
<p>Concerning <span class="math inline">\(\rho\)</span>, Singer and Willett pointed out</p>
<blockquote class="blockquote">
<p>it summarizes the size of the residual autocorrelation in the composite unconditional means mode….</p>
<p>Each person has a different composite residual on each occasion of measurement. But notice the difference in the subscripts of the pieces of the composite residual: while the level-1 residual, <span class="math inline">\(\epsilon_{ij}\)</span> has two subscripts (<span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>), the level-2 residual, <span class="math inline">\(\zeta_{0i}\)</span>, has only one (<span class="math inline">\(i\)</span>). Each person can have a different <span class="math inline">\(\epsilon_{ij}\)</span> on each occasion, but has only one <span class="math inline">\(\zeta_{0i}\)</span> across every occasion. The repeated presence of <span class="math inline">\(\zeta_{0i}\)</span> in individual <span class="math inline">\(i\)</span>’s composite residual links his or her composite residuals across occasions. The error autocorrelation coefficient quantifies the magnitude of this linkage; in the unconditional means model, the error autocorrelation coefficient <em>is</em> the intraclass correlation coefficient. Thus, we estimate that, for each person, the average correlation between any pair of composite residuals–between occasions 1 and 2, or 2 and 3, or 1 and 3–is [.5]. (pp.&nbsp;96–97, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Because of the differences in how they’re estimated with and presented by <code>brm()</code>, we focused right on the variance components. But before we move on to the next section, we should back up a bit. On page 93, Singer and Willett discussed their estimate for <span class="math inline">\(\gamma_{00}\)</span>. Here’s ours.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(fit4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Estimate  Est.Error     Q2.5    Q97.5
Intercept 0.9237214 0.09789998 0.734189 1.114758</code></pre>
</div>
</div>
<p>They talked about how squaring that value puts it back to the natural metric the data were originally collected in. [Recall that as discussed earlier in the text the <code>alcuse</code> variable was square-root transformed because of excessive skew.] If you want a quick and dirty look, you can square our results, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(fit4<span class="fl">.1</span>)<span class="sc">^</span><span class="dv">2</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Estimate   Est.Error      Q2.5    Q97.5
Intercept 0.8532612 0.009584406 0.5390335 1.242685</code></pre>
</div>
</div>
<p>However, I do not recommend this method. Though it did okay at transforming the posterior mean (i.e., Estimate), it’s not a great way to get the summary statistics correct. To do that, you’ll need to work with the posterior samples themselves. Remember how we saved them as <code>draws</code>? Let’s refresh ourselves and look at the first few columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_Intercept<span class="sc">:</span>sigma) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  b_Intercept sd_id__Intercept sigma
        &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt;
1       0.926            0.629 0.760
2       0.899            0.868 0.814
3       0.779            0.772 0.741
4       0.927            0.747 0.746
5       1.01             0.847 0.744
6       1.06             0.749 0.727</code></pre>
</div>
</div>
<p>See that <code>b_Intercept</code> column there? That contains our posterior draws from <span class="math inline">\(\gamma_{00}\)</span>. If you want proper summary statistics from the transformed estimate, get them after transforming that column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">gamma_00_squared =</span> b_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(gamma_00_squared),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(gamma_00_squared),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(gamma_00_squared),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(gamma_00_squared, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(gamma_00_squared, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  name   value
  &lt;chr&gt;  &lt;dbl&gt;
1 mean   0.863
2 median 0.855
3 sd     0.181
4 ll     0.539
5 ul     1.24 </code></pre>
</div>
</div>
<p>And one last bit before we move on to the next section. Remember how we discovered what the <code>brm()</code> default priors were for our model with the handy <code>get_prior()</code> function? Let’s refresh ourselves on how that worked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(<span class="at">data =</span> alcohol1_pp, </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> gaussian,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>          alcuse <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub tag       source
 student_t(3, 1, 2.5) Intercept                                                default
 student_t(3, 0, 2.5)        sd                                  0             default
 student_t(3, 0, 2.5)        sd              id                  0        (vectorized)
 student_t(3, 0, 2.5)        sd Intercept    id                  0        (vectorized)
 student_t(3, 0, 2.5)     sigma                                  0             default</code></pre>
</div>
</div>
<p>We inserted the data and the model and <code>get_prior()</code> returned the default priors. Especially for new Bayesians, or even for experienced Bayesians working with unfamiliar models, it can be handy to plot your priors to get a sense of them.</p>
<p>Base <strong>R</strong> has an array of functions based on the <span class="math inline">\(t\)</span> distribution (e.g., <code>rt()</code>, <code>dt()</code>). These functions are limited in that while they allow users to select the desired <span class="math inline">\(\nu\)</span> values (i.e., degrees of freedom), they fix <span class="math inline">\(\mu = 0\)</span> and <span class="math inline">\(\sigma = 1\)</span>. If you want to stick with the base <strong>R</strong> functions, you can find tricky ways around this. To avoid overwhelming anyone new to Bayes or the multilevel model or <strong>R</strong> or some exasperating combination, let’s just make things simpler and use a couple convenience functions from the <a href="https://CRAN.R-project.org/package=ggdist"><strong>ggdist</strong> package</a> <span class="citation" data-cites="R-ggdist">(<a href="references.html#ref-R-ggdist" role="doc-biblioref">Kay, 2021</a>)</span>.</p>
<p>We’ll start with the default intercept prior, <span class="math inline">\(t(\nu = 3, \mu = 1, \sigma = 2.5)\)</span>. Here’s the density in the range <span class="math inline">\([-20, 20]\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="fl">2.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_dist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> .dist_obj, <span class="at">y =</span> prior)) <span class="sc">+</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.95</span>, <span class="at">p_limits =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.999</span>)) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"prior for "</span>, gamma[<span class="dv">0</span>][<span class="dv">0</span>])),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"parameter space"</span>) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Though it’s centered on 1, the inner 95% of the density is well between -10 and 10. Given the model estimate ended up about 0.9, it looks like that was a pretty broad and minimally-informative prior. However, the prior isn’t flat and it does help guard against wasting time and HMC iterations sampling from ridiculous regions of the parameter space such as -10,000 or +500,000,000. No adolescent is drinking that much (or that little–how does one drink a negative value?).</p>
<p>Here’s the shape of the variance priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">lb =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_dist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">xdist =</span> .dist_obj, <span class="at">y =</span> prior)) <span class="sc">+</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.95</span>, <span class="at">p_limits =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.999</span>)) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"prior for both "</span>, sigma[<span class="dv">0</span>], <span class="st">" and "</span>, sigma[epsilon])),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"parameter space"</span>) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Recall that by <strong>brms</strong> default, the variance parameters have a lower-limit of 0. So specifying a Student’s <span class="math inline">\(t\)</span> or other Gaussian-like prior on them ends up cutting the distribution off at 0. Given that our estimates were both below 1, it appears that these priors were minimally informative. But again, they did help prevent <code>brm()</code> from sampling from negative values or from obscenely-large values.</p>
<p><em>These priors look kinda silly</em>, you might say. <em>Anyone with a little common sense can do better</em>. Well, sure. Probably. Maybe. But keep in mind we’re still getting the layout of the land. And plus, this was a pretty simple model. Selecting high-quality priors gets tricky as the models get more complicated. In other chapters, we’ll explore other ways to specify priors for our multilevel models. But to keep things simple for now, let’s keep practicing inspecting and using the defaults with <code>get_prior()</code> and so on.</p>
</section>
<section id="the-unconditional-growth-model" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="the-unconditional-growth-model"><span class="header-section-number">4.4.2</span> The unconditional growth model</h3>
<p>Using the composite formula, our next model, the unconditional growth model, follows the form</p>
<p><span class="math display">\[
\begin{align}
\text{alcuse}_{ij} &amp; = \gamma_{00} + \gamma_{10} \text{age\_14}_{ij} + \zeta_{0i} + \zeta_{1i} \text{age\_14}_{ij} + \epsilon_{ij} \\
\epsilon_{ij} &amp; \sim \operatorname{Normal} (0, \sigma_\epsilon^2) \\
\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \operatorname{Normal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0^2 &amp; \sigma_{01} \\ \sigma_{01} &amp; \sigma_1^2 \end{bmatrix}
\end{pmatrix}.
\end{align}
\]</span></p>
<p>With it, we now have a full composite stochastic model. Let’s query the <code>brms::brm()</code> default priors when we apply this model to our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior class      coef group resp dpar nlpar lb ub tag       source
               (flat)     b                                                default
               (flat)     b    age_14                                 (vectorized)
               (flat)     b Intercept                                 (vectorized)
               lkj(1)   cor                                                default
               lkj(1)   cor              id                           (vectorized)
 student_t(3, 0, 2.5)    sd                                  0             default
 student_t(3, 0, 2.5)    sd              id                  0        (vectorized)
 student_t(3, 0, 2.5)    sd    age_14    id                  0        (vectorized)
 student_t(3, 0, 2.5)    sd Intercept    id                  0        (vectorized)
 student_t(3, 0, 2.5) sigma                                  0             default</code></pre>
</div>
</div>
<p>Several things of note: First, notice how we continue to use the <code>student_t(3, 0, 2.5)</code> for all three of our standard-deviation-metric variance parameters. Since we’re now estimating <span class="math inline">\(\sigma_0\)</span> and <span class="math inline">\(\sigma_1\)</span>, which themselves have a correlation, <span class="math inline">\(\rho_{01}\)</span>, we have a prior of <code>class = cor</code>. I’m going to put off what is meant by the name <code>lkj</code>, but for the moment just realize that this prior is essentially noninformative within this context.</p>
<p>There’s a major odd development with this output. Notice how the <code>prior</code> column is <code>(flat)</code> for the rows for our two coefficients of class <code>b</code>. And if you’re a little confused, recall that because our predictor <code>age_14</code> is not mean-centered, we’ve used the <code>0 + Intercept</code> syntax, which switches the model intercept parameter to the class of <code>b</code>. From the <code>set_prior</code> section of the <a href="https://cran.r-project.org/web/packages/brms/brms.pdf">reference manual</a> for <strong>brms</strong> version 2.12.0, we read: “The default prior for population-level effects (including monotonic and category specific effects) is an improper flat prior over the reals” (p.&nbsp;179). At present, these priors are uniform across the entire parameter space. They’re not just weak, their entirely noninformative. That is, the likelihood dominates the posterior for those parameters.</p>
<p>Here’s how to fit the model with these priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sd),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sigma),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> cor)),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.9</span>),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.02"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How did we do?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4<span class="fl">.2</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: alcuse ~ 0 + Intercept + age_14 + (1 + age_14 | id) 
   Data: alcohol1_pp (Number of observations: 246) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 82) 
                      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sd(Intercept)            0.790     0.104    0.596    1.005 1.003      804     1329
sd(age_14)               0.360     0.097    0.121    0.528 1.014      241      255
cor(Intercept,age_14)   -0.108     0.276   -0.506    0.643 1.007      434      316

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
Intercept    0.649     0.108    0.437    0.855 1.001     1744     2522
age_14       0.272     0.064    0.146    0.397 1.000     3580     2964

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sigma    0.607     0.053    0.514    0.720 1.008      396      587

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>If your compare our results with those in the “Model B” column in Table 4.1, you’ll see our summary results match well with those in the text. Our <span class="math inline">\(\gamma\)</span>’s (i.e., ‘Population-Level Effects:’) are near identical. The leftmost panel in Figure 4.3 shows the prototypical trajectory, based on the <span class="math inline">\(\gamma\)</span>s. A quick way to get that within our <strong>brms</strong> framework is with the <code>conditional_effects()</code> function. Here’s the default output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(fit4<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Staying with <code>conditional_effects()</code> allows users some flexibility for customizing the plot(s). For example, the default behavior is to depict the trajectory in terms of its 95% intervals and posterior median. If you’d prefer the 80% intervals and the posterior mean, customize it like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(fit4<span class="fl">.2</span>,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">robust =</span> F,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prob =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We’ll explore more options with <code>brms::conditional_effects()</code> with Model C. For now, let’s turn our focus on the stochastic elements in the model. Here we extract the posterior samples and do the conversions to see how they compare with Singer and Willett’s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.2</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_0       =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_1       =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_01        =</span> sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  sigma_2_epsilon sigma_2_0 sigma_2_1 sigma_01
            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1           0.282     0.834     0.289   -0.220
2           0.336     0.772     0.263   -0.114
3           0.364     0.725     0.234   -0.173
4           0.269     0.889     0.250   -0.147
5           0.343     0.558     0.291   -0.124
6           0.342     1.04      0.178   -0.187</code></pre>
</div>
</div>
<p>This time, our <code>v</code> object only contains the stochastic components in the variance metric. Let’s plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>For each, their posterior mass is centered near the point estimates Singer and Willet reported in the text. Here are the summary statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(value),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(value),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  name              mean median    sd     ll    ul
  &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 sigma_01        -0.049 -0.043 0.076 -0.217 0.08 
2 sigma_2_0        0.635  0.618 0.167  0.355 1.01 
3 sigma_2_1        0.139  0.137 0.065  0.015 0.279
4 sigma_2_epsilon  0.371  0.363 0.066  0.264 0.519</code></pre>
</div>
</div>
<p>Happily, they’re quite comparable to those in the text.</p>
<p>We’ve been pulling the posterior samples for all parameters with <code>as_draws_df()</code> and subsetting to a few variables of interest, such as the variance parameters. But it our primary interest is just the iterations for the variance parameters, we can extract them in a more focused way with the <code>VarCorr()</code> function. Here’s how we’d do so for <code>fit4.2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>, <span class="at">summary =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ id        :List of 3
  ..$ sd : num [1:4000, 1:2] 0.913 0.879 0.852 0.943 0.747 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ draw    : chr [1:4000] "1" "2" "3" "4" ...
  .. .. ..$ variable: chr [1:2] "Intercept" "age_14"
  .. ..- attr(*, "nchains")= int 4
  ..$ cor: num [1:4000, 1:2, 1:2] 1 1 1 1 1 1 1 1 1 1 ...
  .. ..- attr(*, "dimnames")=List of 3
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] "Intercept" "age_14"
  .. .. ..$ : chr [1:2] "Intercept" "age_14"
  ..$ cov: num [1:4000, 1:2, 1:2] 0.834 0.772 0.725 0.889 0.558 ...
  .. ..- attr(*, "dimnames")=List of 3
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] "Intercept" "age_14"
  .. .. ..$ : chr [1:2] "Intercept" "age_14"
 $ residual__:List of 1
  ..$ sd: num [1:4000, 1] 0.531 0.579 0.603 0.518 0.586 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ draw    : chr [1:4000] "1" "2" "3" "4" ...
  .. .. ..$ variable: chr ""
  .. ..- attr(*, "nchains")= int 4</code></pre>
</div>
</div>
<p>That last part, the contents of the second higher-level list indexed by <code>$ residual</code>, contains the contents for <span class="math inline">\(\sigma_\epsilon\)</span>. On page 100 in the text, Singer and Willett compared <span class="math inline">\(\sigma_\epsilon^2\)</span> from the first model to that from the second. We might do that like so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">VarCorr</span>(fit4<span class="fl">.1</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]],</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="sc">~</span>.<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"fit4."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">fit4.1 - fit4.2</span><span class="st">`</span> <span class="ot">=</span> fit4<span class="fl">.1</span> <span class="sc">-</span> fit4<span class="fl">.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"fit4.1"</span>, <span class="st">"fit4.2"</span>, <span class="st">"fit4.1 - fit4.2"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(sigma[epsilon]<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>To compute a formal summary of the decline in <span class="math inline">\(\sigma_\epsilon^2\)</span> after adding time to the model, we might summarize like before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">VarCorr</span>(fit4<span class="fl">.1</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]],</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="sc">~</span> .<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"fit4."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">proportion_decline =</span> (fit4<span class="fl">.1</span> <span class="sc">-</span> fit4<span class="fl">.2</span>) <span class="sc">/</span> fit4<span class="fl">.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(proportion_decline),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(proportion_decline),</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(proportion_decline),</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(proportion_decline, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(proportion_decline, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mean median    sd    ll   ul
1 0.345   0.36 0.139 0.024 0.57</code></pre>
</div>
</div>
<p>In case it wasn’t clear, when we presented <code>fit4.1 – fit4.2</code> in the density plot, that was a simple difference score. However, we computed <code>proportion_decline</code> above by dividing that difference score by <code>fit4.1</code>; that’s what put the difference in a proportion metric. Anyway, Singer and Willett’s method led them to summarize the decline as .40. Our method was a more conservative .34-ish. And very happily, our method allows us to describe the proportion decline with summary statistics for the full posterior, such as with the <span class="math inline">\(\textit{SD}\)</span> and the 95% intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cor_id__Intercept__age_14)) <span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(rho[<span class="dv">0</span>][<span class="dv">1</span>]), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The estimate Singer and Willett hand-computed in the text, -.22, is near the mean of our posterior distribution for <span class="math inline">\(\rho_{01}\)</span>. However, our distribution provides a full expression of the uncertainty in the parameter. As are many other values within the parameter space, zero is indeed a credible value for <span class="math inline">\(\rho_{01}\)</span>.</p>
<p>On page 101, we get the generic formula for computing the residual variance for a given occasion <span class="math inline">\(j\)</span>,</p>
<p><span class="math display">\[
\sigma_{\text{Residual}_j}^2 = \sigma_0^2 + \sigma_1^2 \text{time}_j + 2 \sigma_{01} \text{time}_j + \sigma_\epsilon^2.
\]</span></p>
<p>If we were just interested in applying it to one of our <code>age</code> values, say 14, we might apply the formula to the posterior like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">sigma_2_residual_j =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>              sd_id__age_14<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>              <span class="dv">2</span> <span class="sc">*</span> sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>              sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  sigma_2_residual_j
               &lt;dbl&gt;
1              1.12 
2              1.11 
3              1.09 
4              1.16 
5              0.901
6              1.38 </code></pre>
</div>
</div>
<p>But given we’d like to do so over several values of <code>age</code>, it might be better to wrap the equation in a custom function. Let’s call it <code>make_s2rj()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>make_s2rj <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  draws <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">sigma_2_residual_j =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14 <span class="sc">*</span> x <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can put our custom <code>make_s2rj()</code> function to work within the <code>purrr::map()</code> paradigm. We’ll plot the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">age =</span> <span class="dv">14</span><span class="sc">:</span><span class="dv">16</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_c =</span> age <span class="sc">-</span> <span class="dv">14</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">s2rj =</span> <span class="fu">map</span>(age_c, make_s2rj)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(s2rj) <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"age = "</span>, age)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> s2rj)) <span class="sc">+</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># just for reference </span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"grey92"</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Behold the shape of longitudinal heteroscedasticity."</span>,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(sigma[<span class="fu">italic</span>(Residual[j])]<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> label, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We see a subtle increase over time, particularly from <code>age = 15</code> to <code>age = 16</code>. Yep, that’s heteroscedasticity. It is indeed “beyond the bland homoscedasticity we assume of residuals in cross-sectional data” (p.&nbsp;101).</p>
<p>We might also be interested in computing the autocorrelation between the composite residuals on occasions <span class="math inline">\(j\)</span> and <span class="math inline">\(j'\)</span>, which follows the formula</p>
<p><span class="math display">\[
\rho_{\text{Residual}_j, \text{Residual}_{j'}} = \frac{\sigma_0^2 + \sigma_{01} (\text{time}_j + \text{time}_{j'}) + \sigma_1^2 \text{time}_j \text{time}_{j'}} {\sqrt{\sigma_{\text{Residual}_j}^2 \sigma_{\text{Residual}_{j'}}^2 }}.
\]</span></p>
<p>We only want to do that by hand once. Let’s make a custom function following the formula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a> make_rho_rj_rjp <span class="ot">&lt;-</span> <span class="cf">function</span>(j, jp) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define the elements in the denominator  </span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  s2rj_j  <span class="ot">&lt;-</span> <span class="fu">make_s2rj</span>(j)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  s2rj_jp <span class="ot">&lt;-</span> <span class="fu">make_s2rj</span>(jp)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  draws <span class="sc">%&gt;%</span> </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">r =</span> (sd_id__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>                     sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14 <span class="sc">*</span> (j <span class="sc">+</span> jp) <span class="sc">+</span> </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                     sd_id__age_14<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> j <span class="sc">*</span> jp) <span class="sc">/</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sqrt</span>(s2rj_j <span class="sc">*</span> s2rj_jp)) <span class="sc">%&gt;%</span> </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you only cared about measures of central tendency, such as the posterior median, you could use the function like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_rho_rj_rjp</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">median</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5688327</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_rho_rj_rjp</span>(<span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">median</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7217349</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_rho_rj_rjp</span>(<span class="dv">0</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">median</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5158972</code></pre>
</div>
</div>
<p>Here are the full posteriors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">occasion =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_c =</span> occasion <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">j     =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">jp    =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r =</span> <span class="fu">map2</span>(j, jp, make_rho_rj_rjp)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(r) <span class="sc">%&gt;%</span> </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"occasions "</span>, j <span class="sc">+</span> <span class="dv">1</span>, <span class="st">" and "</span>, jp <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> r)) <span class="sc">+</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># just for reference</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>), <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(rho[Residual[<span class="fu">italic</span>(j)]][Residual[<span class="fu">italic</span>(j<span class="sc">*</span>minute)]]), <span class="at">limits =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Behold the shapes of our autocorrelations!"</span>) <span class="sc">+</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> label, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="quantifying-the-proportion-of-outcome-variation-explained" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="quantifying-the-proportion-of-outcome-variation-explained"><span class="header-section-number">4.4.3</span> Quantifying the proportion of outcome variation “explained”</h3>
<p>Because of the way the multilevel model partitions off variance into different sources (e.g., <span class="math inline">\(\sigma_0^2\)</span>, <span class="math inline">\(\sigma_1^2\)</span>, and <span class="math inline">\(\sigma_\epsilon^2\)</span> in the unconditional growth model), the conventional <span class="math inline">\(R^2\)</span> is not applicable for evaluating models in the traditional OLS sense of percent of variance explained. Several pseudo <span class="math inline">\(R^2\)</span> statistics are frequently used instead. Be warned, “statisticians have yet to agree on appropriate summaries <span class="citation" data-cites="kreftIntroducingMultilevelModeling1998 snijdersModeledVarianceTwolevel1994">(<a href="references.html#ref-kreftIntroducingMultilevelModeling1998" role="doc-biblioref">Kreft &amp; de Leeuw, 1998</a>; <a href="references.html#ref-snijdersModeledVarianceTwolevel1994" role="doc-biblioref">Snijders &amp; Bosker, 1994</a>)</span>” (p.&nbsp;102). See also <span class="citation" data-cites="jaegerR2StatisticFixed2017">Jaeger et al. (<a href="references.html#ref-jaegerR2StatisticFixed2017" role="doc-biblioref">2017</a>)</span>, <span class="citation" data-cites="rightsEffectSizeMeasures2018">Jason D. Rights &amp; Cole (<a href="references.html#ref-rightsEffectSizeMeasures2018" role="doc-biblioref">2018</a>)</span>, and <span class="citation" data-cites="rights2020NewRecommendations">Jason D. Rights &amp; Sterba (<a href="references.html#ref-rights2020NewRecommendations" role="doc-biblioref">2020</a>)</span>. To my eye, none of the solutions presented in this section are magic bullets.</p>
<section id="an-overall-summary-of-total-outcome-variability-explained" class="level4" data-number="4.4.3.1">
<h4 data-number="4.4.3.1" class="anchored" data-anchor-id="an-overall-summary-of-total-outcome-variability-explained"><span class="header-section-number">4.4.3.1</span> An overall summary of total outcome variability explained</h4>
<blockquote class="blockquote">
<p>In multiple regression, one simple way of computing a summary <span class="math inline">\(R^2\)</span> statistic is to square the sample correlation between observed and predicted values of the outcome. The same approach can be used in the multilevel model for change. All you need to do is: (1) compute the predicted outcome value for each person on each occasion of measurement; and (2) square the sample correlation between observed and predicted values. The resultant pseudo-<span class="math inline">\(R^2\)</span> statistic assesses the proportion of total outcome variation “explained” by the <em>multilevel model’s specific contribution of predictors</em>. (p.&nbsp;102, <em>emphasis</em> added)</p>
</blockquote>
<p>Singer and Willett called this <span class="math inline">\(R_{y, \hat y}^2\)</span>. They then walked through an example with their Model B (<code>fit4.2</code>), the unconditional growth model. Within our <strong>brms</strong> paradigm, we typically use the <code>fitted()</code> function to return predicted outcome values for cases within the data. The default option for the <code>fitted()</code> function is to return these predictions after accounting for the level-2 clustering. As we will see, Singer and Willett’s <span class="math inline">\(R_{y, \hat y}^2\)</span> statistic only accounts for predictors (i.e., <code>age_14</code>, in this case), not clustering variables (i.e., <code>id</code>, in this case). To follow Singer and Willett’s specification, we need to set <code>re_formula = NA</code>, which will instruct <code>fitted()</code> to return the expected values without reference to the level-2 clustering. Here’s a look at the first six rows of that output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit4<span class="fl">.2</span>, <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate  Est.Error      Q2.5     Q97.5
[1,] 0.6486449 0.10802024 0.4374269 0.8552847
[2,] 0.9205147 0.09986409 0.7215163 1.1174546
[3,] 1.1923845 0.12800296 0.9349210 1.4442575
[4,] 0.6486449 0.10802024 0.4374269 0.8552847
[5,] 0.9205147 0.09986409 0.7215163 1.1174546
[6,] 1.1923845 0.12800296 0.9349210 1.4442575</code></pre>
</div>
</div>
<p>Within our Bayesian/<strong>brms</strong> paradigm, out expected values come with expressions of uncertainty in terms of the posterior standard deviation and percentile-based 95% intervals. If we followed Singer and Willett’s method in the text, we’d only work with the posterior means as presented within the <code>Estimate</code> column. But since we’re Bayesians, we should attempt to work with the model uncertainty. One approach is to set <code>summary = F</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.2</span>,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">summary =</span> F,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"draw"</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4000  247</code></pre>
</div>
</div>
<p>With those settings, <code>fitted()</code> returned a <span class="math inline">\(4,000 \times 246\)</span> numeric array. The 4,000 rows corresponded to the 4,000 post-warmup HMC draws. Each of the 246 columns corresponded to one of the 246 rows in the original <code>alcohol1_pp</code> data. To make the output more useful, we converted it to a data frame, named the columns by the row numbers corresponding to the original <code>alcohol1_pp</code> data, and converted the row names to an <code>draw</code> column.</p>
<p>In the next code block, we’ll convert <code>f</code> to the long format and use <code>left_join()</code> to join it with the relevant subset of the <code>alcohol1_pp</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> f <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>draw,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"row"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"fitted"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> row <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(row, alcuse),</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"row"</span>) </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 984,000 × 4
   draw    row fitted alcuse
   &lt;chr&gt; &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 1         1  0.758   1.73
 2 1         2  0.945   2   
 3 1         3  1.13    2   
 4 1         4  0.758   0   
 5 1         5  0.945   0   
 6 1         6  1.13    1   
 7 1         7  0.758   1   
 8 1         8  0.945   2   
 9 1         9  1.13    3.32
10 1        10  0.758   0   
# ℹ 983,990 more rows</code></pre>
</div>
</div>
<p>If we collapse the distinction across the 4,000 HMC draws, here is the squared correlation between <code>fitted</code> and <code>alcuse</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">r  =</span> <span class="fu">cor</span>(fitted, alcuse),</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2 =</span> <span class="fu">cor</span>(fitted, alcuse)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
      r     r2
  &lt;dbl&gt;  &lt;dbl&gt;
1 0.186 0.0345</code></pre>
</div>
</div>
<p>This is close to the <span class="math inline">\(R_{y, \hat y}^2 = .043\)</span> Singer and Willett reported in the text. It might seem unsatisfying how this seemingly ignores model uncertainty by collapsing across HMC draws. Here’s a look at what happens is we compute the <span class="math inline">\(R_{y, \hat y}^2\)</span> separately for each iteration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">draw =</span> draw <span class="sc">%&gt;%</span> <span class="fu">as.double</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(draw) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">r  =</span> <span class="fu">cor</span>(fitted, alcuse),</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2 =</span> <span class="fu">cor</span>(fitted, alcuse)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,000 × 3
    draw     r     r2
   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1 0.208 0.0434
 2     2 0.208 0.0434
 3     3 0.208 0.0434
 4     4 0.208 0.0434
 5     5 0.208 0.0434
 6     6 0.208 0.0434
 7     7 0.208 0.0434
 8     8 0.208 0.0434
 9     9 0.208 0.0434
10    10 0.208 0.0434
# ℹ 3,990 more rows</code></pre>
</div>
</div>
<p>Now for every level of <code>draw</code>, <span class="math inline">\(R_{y, \hat y}^2 = .0434\)</span>, which matches up nicely with the text. But it seems odd that the value should be the same for each of the 4,000 HMC draws. Sadly, my efforts to debug my workflow have been unsuccessful. If you see a flaw in this method, please <a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse/issues">share on GitHub</a>.</p>
<p>Just for kicks, here’s a more compact alternative to our <code>fitted()</code> + <code>left_join()</code> approach that more closely resembles the work flow Singer and Willett showed on pages 102 and 103.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">age_14 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">map</span>(age_14, <span class="sc">~</span> draws<span class="sc">$</span>b_Intercept <span class="sc">+</span> draws<span class="sc">$</span>b_age_14 <span class="sc">*</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, age_14, alcuse),</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"age_14"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(fitted) <span class="sc">%&gt;%</span> </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">draw =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4000</span>, <span class="at">times =</span> alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">nrow</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(draw) <span class="sc">%&gt;%</span> </span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">r  =</span> <span class="fu">cor</span>(fitted, alcuse),</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">r2 =</span> <span class="fu">cor</span>(fitted, alcuse)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,000 × 3
    draw     r     r2
   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1 0.208 0.0434
 2     2 0.208 0.0434
 3     3 0.208 0.0434
 4     4 0.208 0.0434
 5     5 0.208 0.0434
 6     6 0.208 0.0434
 7     7 0.208 0.0434
 8     8 0.208 0.0434
 9     9 0.208 0.0434
10    10 0.208 0.0434
# ℹ 3,990 more rows</code></pre>
</div>
</div>
<p>Either way, our results agree with those in the text: about “4.3% of the total variability in <em>ALCUSE</em> is associated with linear time” (p.&nbsp;103, <em>emphasis</em> in the original).</p>
</section>
<section id="pseudo-r2-statistics-computed-from-the-variance-components" class="level4" data-number="4.4.3.2">
<h4 data-number="4.4.3.2" class="anchored" data-anchor-id="pseudo-r2-statistics-computed-from-the-variance-components"><span class="header-section-number">4.4.3.2</span> Pseudo-<span class="math inline">\(R^2\)</span> statistics computed from the variance components</h4>
<blockquote class="blockquote">
<p>Residual variation–that portion of the outcome variation unexplained by a model’s predictors–provides another criterion for comparison. When you fit a series of models, you hope that added predictors further explain unexplained outcome variation, causing residual variation to decline. The magnitude of this decline quantifies the improvement in fit. A large decline suggests that the predictors make a big difference; a small, or zero, decline suggests that they do not. To assess these declines on a common scale, we compute the <em>proportional reduction in residual variance</em> as we add predictors.</p>
<p>Each unconditional model yields residual variances that serve as yardsticks for comparison. The unconditional means model provides a baseline estimate of <span class="math inline">\(\sigma_\epsilon^2\)</span>; the unconditional growth model provides baseline estimates of <span class="math inline">\(\sigma_0^2\)</span> and <span class="math inline">\(\sigma_1^2\)</span>. Each leads to its own pseudo-<span class="math inline">\(R^2\)</span> statistic. (p.&nbsp;103, <em>emphasis</em> in the original)</p>
</blockquote>
<p>This provides three more pseudo-<span class="math inline">\(R^2\)</span> statistics: <span class="math inline">\(R_\epsilon^2\)</span>, <span class="math inline">\(R_0^2\)</span>, and <span class="math inline">\(R_1^2\)</span>. The formula for the first is</p>
<p><span class="math display">\[
R_\epsilon^2 = \frac{\sigma_\epsilon^2 (\text{unconditional means model}) - \sigma_\epsilon^2 (\text{unconditional growth model})}{\sigma_\epsilon^2 (\text{unconditional means model})}.
\]</span></p>
<p>We’ve actually already computed this one, above, under the name where we referred to it as the decline in <span class="math inline">\(\sigma_\epsilon^2\)</span> after adding time to the model. Here it is again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">VarCorr</span>(fit4<span class="fl">.1</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]],</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="sc">~</span> .<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"fit4."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r_2_epsilon =</span> (fit4<span class="fl">.1</span> <span class="sc">-</span> fit4<span class="fl">.2</span>) <span class="sc">/</span> fit4<span class="fl">.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(r_2_epsilon),</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(r_2_epsilon),</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(r_2_epsilon),</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(r_2_epsilon, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(r_2_epsilon, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mean median    sd    ll   ul
1 0.345   0.36 0.139 0.024 0.57</code></pre>
</div>
</div>
<p>Here’s a look at the full distribution for our <span class="math inline">\(\sigma_\epsilon^2\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">VarCorr</span>(fit4<span class="fl">.1</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]],</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>, <span class="at">summary =</span> F)[[<span class="dv">2</span>]][[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="sc">~</span> .<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">str_c</span>(<span class="st">"fit4."</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r_2_epsilon =</span> (fit4<span class="fl">.1</span> <span class="sc">-</span> fit4<span class="fl">.2</span>) <span class="sc">/</span> fit4<span class="fl">.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> r_2_epsilon)) <span class="sc">+</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="fu">expression</span>(Pseudo<span class="sc">~</span><span class="fu">italic</span>(R)[epsilon]<span class="sc">^</span><span class="dv">2</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>When we use the full posteriors of our two <span class="math inline">\(\epsilon_\epsilon^2\)</span> parameters, we end up with a slightly smaller statistic than the one in the text. So our conclusion is about 35% of the intraindividual variance is accounted for by time.</p>
<p>If we consider additional models with predictors for the <span class="math inline">\(\zeta\)</span>s, we can examine similar pseudo <span class="math inline">\(R^2\)</span> statistics following the generic form</p>
<p><span class="math display">\[
R_\zeta^2 = \frac{\sigma_\zeta^2 (\text{unconditional growth model}) - \sigma_\zeta^2 (\text{subsequent model})}{\sigma_\zeta^2 (\text{unconditional growth model})},
\]</span></p>
<p>where <span class="math inline">\(\zeta\)</span> could refer to <span class="math inline">\(\zeta_{0i}\)</span>, <span class="math inline">\(\zeta_{1i}\)</span>, and so on. If you look back up at the shape of the full posterior of <span class="math inline">\(R_\epsilon^2\)</span>, you’ll notice part of the left tail crosses zero. “Unlike traditional <span class="math inline">\(R^2\)</span> statistics, which will always be positive (or zero), some of these statistics can be negative” (p.&nbsp;104)! If you compute them, interpret pseudo-<span class="math inline">\(R^2\)</span> statistics with a grain of salt.</p>
</section>
</section>
</section>
<section id="practical-data-analytic-strategies-for-model-building" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="practical-data-analytic-strategies-for-model-building"><span class="header-section-number">4.5</span> Practical data analytic strategies for model building</h2>
<blockquote class="blockquote">
<p>A sound statistical model includes all necessary predictors and no unnecessary ones. But how do you separate the wheat from the chaff? We suggest you rely on a combination of substantive theory, research questions, and statistical evidence. <em>Never</em> let a computer select predictors mechanically. (pp.&nbsp;104–105, <em>emphasis</em> in the original)</p>
</blockquote>
<section id="a-taxonomy-of-statistical-models" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="a-taxonomy-of-statistical-models"><span class="header-section-number">4.5.1</span> A taxonomy of statistical models</h3>
<blockquote class="blockquote">
<p>We suggest that you base decisions to enter, retain, and remove predictors on a combination of logic, theory, and prior research, supplemented by judicious [parameter evaluation] and comparison of model fit. At the outset, you might examine the effect of each predictor individually. You might then focus on predictors of primary interest (while including others whose effects you want to control). As in regular regression, you can add predictors singly or in groups and you can address issues of functional form using interactions and transformations. As you develop the taxonomy, you will progress toward a “final model” whose interpretation addresses your research questions. We place quotes around this term to emphasize that we believe no statistical model is <em>ever</em> final; it is simply a placeholder until a better model is found. (p.&nbsp;105, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
<section id="interpreting-fitted-models" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="interpreting-fitted-models"><span class="header-section-number">4.5.2</span> Interpreting fitted models</h3>
<blockquote class="blockquote">
<p>You need not interpret every model you fit, especially those designed to guide interim decision making. When writing up findings for presentation and publication, we suggest that you identify a manageable subset of models that, taken together, tells a persuasive story parsimoniously. At a minimum, this includes the unconditional means model, the unconditional growth model, and a “final model”. You may also want to present intermediate models that either provide important building blocks or tell interesting stories in their own right. (p.&nbsp;106)</p>
</blockquote>
<p>In the dawn of the post-replication crisis era, it’s astonishing to reread and transcribe this section and the one above. I like a lot of what the authors had to say. Much of it seems like good pragmatic advice. But if they were to rewrite these sections again, I wonder what changes they’d make. Would they recommend researchers preregister their primary hypothesis, variables of interest, and perhaps their model building strategy <span class="citation" data-cites="nosekPreregistrationRevolution2018">(<a href="references.html#ref-nosekPreregistrationRevolution2018" role="doc-biblioref">Nosek et al., 2018</a>)</span>? Would they be interested in a multiverse analysis <span class="citation" data-cites="steegen2016increasing">(<a href="references.html#ref-steegen2016increasing" role="doc-biblioref">Steegen et al., 2016</a>)</span>? Would they still recommend sharing only a subset of one’s analyses in the era of sharing platforms like <a href="https://github.com">GitHub</a> and the <a href="https://osf.io">Open Science Framework</a>? Would they weigh in on developments in causal inference <span class="citation" data-cites="pearlCausalInferenceStatistics2016">(<a href="references.html#ref-pearlCausalInferenceStatistics2016" role="doc-biblioref">Pearl et al., 2016</a>)</span>?</p>
<section id="model-c-the-uncontrolled-effects-of-coa" class="level4" data-number="4.5.2.1">
<h4 data-number="4.5.2.1" class="anchored" data-anchor-id="model-c-the-uncontrolled-effects-of-coa"><span class="header-section-number">4.5.2.1</span> Model C: The uncontrolled effects of COA</h4>
<p>The default priors for Model C are the same as for the unconditional growth model. All we’ve done is add parameters of <code>class = b</code>. As these default to improper flat priors, we have nothing to add to the <code>prior</code> argument to include them. Feel free to check with <code>get_prior()</code>. For the sake of practice, this model follows the form</p>
<p><span class="math display">\[
\begin{align}
\text{alcuse}_{ij} &amp; = \gamma_{00} + \gamma_{01} \text{coa}_i + \gamma_{10} \text{age\_14}_{ij} + \gamma_{11} \text{coa}_i \times \text{age\_14}_{ij} + \zeta_{0i} + \zeta_{1i} \text{age\_14}_{ij} + \epsilon_{ij} \\
\epsilon_{ij} &amp; \sim \text{Normal} (0, \sigma_\epsilon^2) \\
\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \text{Normal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0^2 &amp; \sigma_{01} \\ \sigma_{01} &amp; \sigma_1^2 \end{bmatrix}
\end{pmatrix}.
\end{align}
\]</span></p>
<p>Fit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> coa <span class="sc">+</span> age_14<span class="sc">:</span>coa <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sd),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sigma),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> cor)),</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.03"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4<span class="fl">.3</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: alcuse ~ 0 + Intercept + age_14 + coa + age_14:coa + (1 + age_14 | id) 
   Data: alcohol1_pp (Number of observations: 246) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 82) 
                      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sd(Intercept)            0.697     0.099    0.512    0.897 1.008      909     1347
sd(age_14)               0.368     0.095    0.148    0.530 1.015      382      470
cor(Intercept,age_14)   -0.099     0.276   -0.488    0.627 1.012      590      686

Regression Coefficients:
           Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
Intercept     0.318     0.132    0.067    0.579 1.002     2094     2538
age_14        0.294     0.086    0.127    0.467 1.000     2803     2837
coa           0.744     0.200    0.350    1.132 1.004     1967     1979
age_14:coa   -0.051     0.129   -0.314    0.203 0.999     2798     2829

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sigma    0.606     0.052    0.515    0.717 1.014      486      810

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Our <span class="math inline">\(\gamma\)</span>’s are quite similar to those presented in the text. Our <span class="math inline">\(\sigma_\epsilon\)</span> for this model is about the same as with <code>fit4.2</code>. Let’s practice with <code>conditional_effects()</code> to plot the consequences of this model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(fit4<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-48-2.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-48-3.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>This time we got back three plots. The first two were of the lower-order parameters <span class="math inline">\(\gamma_{10}\)</span> and <span class="math inline">\(\gamma_{01}\)</span>. Note how the plot for <code>coa</code> treated it as a continuous variable. This is because the variable was saved as an integer in the original data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.3</span><span class="sc">$</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 246
Columns: 5
$ alcuse    &lt;dbl&gt; 1.732051, 2.000000, 2.000000, 0.000000, 0.000000, 1.000000, 1.000000, 2.000000, 3.316625, 0.000000, 2.000000, …
$ Intercept &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age_14    &lt;dbl&gt; 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0,…
$ coa       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ id        &lt;dbl&gt; 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10, 11, 11, 11, 12, 1…</code></pre>
</div>
</div>
<p>Coding it as an integer further complicated things for the third plot returned by <code>conditional_effects()</code>, the one for the interaction of <code>age_14</code> and <code>coa</code>, <span class="math inline">\(\gamma_{11}\)</span>.</p>
<p>Since <code>coa</code> is binary, the natural way to express its interaction with <code>age_14</code> would be with <code>age_14</code> on the <span class="math inline">\(x\)</span>-axis and two separate trajectories, one for each value of <code>coa</code>. That’s what Singer and Willett very sensibly did with the middle panel of Figure 4.3. However, the <code>conditional_effects()</code>function defaults to expressing interactions such that the first variable in the term–in this case,<code>age_14</code>–is on the <span class="math inline">\(x\)</span>-axis and the second variable in the term–<code>coa</code>, treated as an integer–is depicted in three lines corresponding its mean and its mean <span class="math inline">\(\pm\)</span> one standard deviation. This is great for continuous variables, but incoherent for categorical ones. The fix is to adjust the data and refit the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  fit4<span class="fl">.3</span>,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">coa =</span> <span class="fu">factor</span>(coa)),</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.04"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We might compare the updated model with its predecessor. To get a focused look, we can use the <code>posterior_summary()</code> function with a little subsetting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(fit4<span class="fl">.3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, ] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Est.Error   Q2.5 Q97.5
b_Intercept     0.318     0.132  0.067 0.579
b_age_14        0.294     0.086  0.127 0.467
b_coa           0.744     0.200  0.350 1.132
b_age_14:coa   -0.051     0.129 -0.314 0.203</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(fit4<span class="fl">.4</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, ] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate Est.Error   Q2.5 Q97.5
b_Intercept      0.318     0.132  0.067 0.579
b_age_14         0.294     0.086  0.127 0.467
b_coa1           0.744     0.200  0.350 1.132
b_age_14:coa1   -0.051     0.129 -0.314 0.203</code></pre>
</div>
</div>
<p>The results are about the same. The payoff comes when we try again with <code>conditional_effects()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(fit4<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-51-2.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-51-3.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Much better. Now the plot for <span class="math inline">\(\gamma_{01}\)</span> treats <code>coa</code> as binary and our plot for the interaction between <code>age_14</code> and <code>coa</code> is much close to the one in Figure 4.3. Since we’re already on a <code>conditional_effects()</code> tangent, we may as well go further. When working with models like <code>fit4.3</code> where you have multiple fixed effects, sometimes you only want the plots for a subset of those effects. For example, if our main goal is to do a good job tastefully reproducing the middle plot in Figure 4.3, we only need the interaction plot. In such a case, use the <code>effects</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(fit4<span class="fl">.4</span>, <span class="at">effects =</span> <span class="st">"age_14:coa"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Earlier we discussed how <code>conditional_effects()</code> lets users adjust some of the output. But if you want an extensive overhaul, it’s better to save the output of <code>conditional_effects()</code> as an object and manipulate that object with the <code>plot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">&lt;-</span> <span class="fu">conditional_effects</span>(fit4<span class="fl">.4</span>, <span class="at">effects =</span> <span class="st">"age_14:coa"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(ce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ age_14:coa:'data.frame': 200 obs. of  12 variables:
  ..$ age_14    : num [1:200] 0 0 0.0202 0.0202 0.0404 ...
  ..$ coa       : Factor w/ 2 levels "0","1": 1 2 1 2 1 2 1 2 1 2 ...
  ..$ alcuse    : num [1:200] 0.922 0.922 0.922 0.922 0.922 ...
  ..$ Intercept : num [1:200] 1 1 1 1 1 1 1 1 1 1 ...
  ..$ id        : logi [1:200] NA NA NA NA NA NA ...
  ..$ cond__    : Factor w/ 1 level "1": 1 1 1 1 1 1 1 1 1 1 ...
  ..$ effect1__ : num [1:200] 0 0 0.0202 0.0202 0.0404 ...
  ..$ effect2__ : Factor w/ 2 levels "0","1": 1 2 1 2 1 2 1 2 1 2 ...
  ..$ estimate__: num [1:200] 0.318 1.061 0.324 1.066 0.329 ...
  ..$ se__      : num [1:200] 0.13 0.147 0.13 0.146 0.129 ...
  ..$ lower__   : num [1:200] 0.0672 0.7737 0.0743 0.7796 0.0811 ...
  ..$ upper__   : num [1:200] 0.579 1.346 0.583 1.35 0.587 ...
  ..- attr(*, "effects")= chr [1:2] "age_14" "coa"
  ..- attr(*, "response")= chr "alcuse"
  ..- attr(*, "surface")= logi FALSE
  ..- attr(*, "categorical")= logi FALSE
  ..- attr(*, "ordinal")= logi FALSE
  ..- attr(*, "points")='data.frame':   246 obs. of  6 variables:
  .. ..$ age_14   : num [1:246] 0 1 2 0 1 2 0 1 2 0 ...
  .. ..$ coa      : Factor w/ 2 levels "0","1": 2 2 2 2 2 2 2 2 2 2 ...
  .. ..$ resp__   : num [1:246] 1.73 2 2 0 0 ...
  .. ..$ cond__   : Factor w/ 1 level "1": 1 1 1 1 1 1 1 1 1 1 ...
  .. ..$ effect1__: num [1:246] 0 1 2 0 1 2 0 1 2 0 ...
  .. ..$ effect2__: Factor w/ 2 levels "0","1": 2 2 2 2 2 2 2 2 2 2 ...
 - attr(*, "class")= chr "brms_conditional_effects"</code></pre>
</div>
</div>
<p>Our <code>ce</code> is an object of class “’brms_conditional_effects” which contains a list of a single data frame. Had we omitted our <code>effects</code> argument, above, we’d have a list of 3 instead. Anyway, these data frames contain the necessary information to produce the plot. The advantage of saving <code>ce</code> this way is we can now insert it into the <code>plot()</code> function. The simple output is the same as before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>The <code>plot()</code> function will allow us to do other things, like add in the original data or omit the white grid lines.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>ce <span class="sc">%&gt;%</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">points =</span> T,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">point_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">width =</span> <span class="fl">0.05</span>, <span class="at">height =</span> <span class="fl">0.05</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>And for even more control, you can tack on typical <strong>ggplot2</strong> functions. But when you want to do so, make sure to set the <code>plot = FALSE</code> argument and then subset after the right parenthesis of the <code>plot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ce, </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()),</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">plot =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]] <span class="sc">+</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fl">2.1</span>, <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.95</span>, <span class="fl">1.55</span>),</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">"coa = "</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>),</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>) <span class="sc">+</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>) <span class="sc">+</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"age"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span>), <span class="at">labels =</span> <span class="dv">13</span><span class="sc">:</span><span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>But anyway, let’s get back on track and talk about the variance components. Singer and Willett contrasted <span class="math inline">\(\sigma_\epsilon^2\)</span> from Model B to the new one from Model C. We might use <code>VarCorr()</code> to do the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(fit4<span class="fl">.2</span>)[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$sd
  Estimate  Est.Error      Q2.5    Q97.5
 0.6066275 0.05331062 0.5138619 0.720457</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(fit4<span class="fl">.3</span>)[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$sd
  Estimate  Est.Error      Q2.5     Q97.5
 0.6059488 0.05215441 0.5146807 0.7172405</code></pre>
</div>
</div>
<p>We could have also extracted that information by subsetting <code>posterior_summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(fit4<span class="fl">.2</span>)[<span class="st">"sigma"</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Estimate  Est.Error       Q2.5      Q97.5 
0.60662753 0.05331062 0.51386186 0.72045701 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(fit4<span class="fl">.3</span>)[<span class="st">"sigma"</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Estimate  Est.Error       Q2.5      Q97.5 
0.60594880 0.05215441 0.51468065 0.71724052 </code></pre>
</div>
</div>
<p>Anyway, to get these in a variance metric, just square their posterior samples and summarize.</p>
<p>Our next task is to formally compare <code>fit4.2</code> and <code>fit4.3</code> in terms of declines in <span class="math inline">\(\sigma_0^2\)</span> and <span class="math inline">\(\sigma_1^2\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit2_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit2_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit3_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit3_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">decline~'in'~sigma[0]^2</span><span class="st">`</span> <span class="ot">=</span> (fit2_sigma_2_0 <span class="sc">-</span> fit3_sigma_2_0) <span class="sc">/</span> fit2_sigma_2_0,</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">decline~'in'~sigma[1]^2</span><span class="st">`</span> <span class="ot">=</span> (fit2_sigma_2_1 <span class="sc">-</span> fit3_sigma_2_1) <span class="sc">/</span> fit2_sigma_2_1) <span class="sc">%&gt;%</span> </span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"decline"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Here are the percents of variance declined from <code>fit4.2</code> to <code>fit4.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit2_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit2_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit3_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit3_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">decline~'in'~sigma[0]^2</span><span class="st">`</span> <span class="ot">=</span> (fit2_sigma_2_0 <span class="sc">-</span> fit3_sigma_2_0) <span class="sc">/</span> fit2_sigma_2_0,</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">decline~'in'~sigma[1]^2</span><span class="st">`</span> <span class="ot">=</span> (fit2_sigma_2_1 <span class="sc">-</span> fit3_sigma_2_1) <span class="sc">/</span> fit2_sigma_2_1) <span class="sc">%&gt;%</span> </span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"decline"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(value),</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value),</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(value),</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  name                       mean  median       sd     ll    ul
  &lt;chr&gt;                     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 decline~'in'~sigma[0]^2   0.161  0.221     0.343 -0.649 0.644
2 decline~'in'~sigma[1]^2 -56.9   -0.0318 3464.    -8.23  0.825</code></pre>
</div>
</div>
<p>In this case, we end up with massive uncertainty when working with the full posteriors. This is particularly the case with the difference in <span class="math inline">\(\sigma_1^2\)</span>, which is left skewed for days. Here are the results when we only use point estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit2_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit2_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit3_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit3_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(median) <span class="sc">%&gt;%</span> </span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="st">`</span><span class="at">% decline in sigma_2_0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">*</span> (fit2_sigma_2_0 <span class="sc">-</span> fit3_sigma_2_0) <span class="sc">/</span> fit2_sigma_2_0,</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">% decline in sigma_2_1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">*</span> (fit2_sigma_2_1 <span class="sc">-</span> fit3_sigma_2_1) <span class="sc">/</span> fit2_sigma_2_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  `% decline in sigma_2_0` `% decline in sigma_2_1`
                     &lt;dbl&gt;                    &lt;dbl&gt;
1                     21.4                    -5.06</code></pre>
</div>
</div>
<p>“These variance components are now called <em>partial</em> or <em>conditional</em> variances because they quantify the interindividual differences in change that remain unexplained by the model’s predictors” (p.&nbsp;108, emphasis in the original).</p>
</section>
<section id="model-d-the-controlled-effects-of-coa" class="level4" data-number="4.5.2.2">
<h4 data-number="4.5.2.2" class="anchored" data-anchor-id="model-d-the-controlled-effects-of-coa"><span class="header-section-number">4.5.2.2</span> Model D: The controlled effects of COA</h4>
<p>This model follows the form</p>
<p><span class="math display">\[
\begin{align}
\text{alcuse}_{ij} &amp; = \gamma_{00} + \gamma_{01} \text{coa}_i + \gamma_{02} \text{peer}_i + \gamma_{10} \text{age\_14}_{ij} \\
&amp; \;\;\; + \gamma_{11} \text{coa}_i \times \text{age\_14}_{ij} + \gamma_{12} \text{peer}_i \times \text{age\_14}_{ij} \\
&amp; \;\;\; + \zeta_{0i} + \zeta_{1i} \text{age\_14}_{ij} + \epsilon_{ij} \\
\epsilon_{ij} &amp; \sim \text{Normal} (0, \sigma_\epsilon^2) \\
\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix} &amp; \sim \text{Normal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0 \end{bmatrix},
\begin{bmatrix} \sigma_0^2 &amp; \sigma_{01} \\ \sigma_{01} &amp; \sigma_1^2 \end{bmatrix}
\end{pmatrix}.
\end{align}
\]</span></p>
<p>Fit that joint.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> coa <span class="sc">+</span> peer <span class="sc">+</span> age_14<span class="sc">:</span>coa <span class="sc">+</span> age_14<span class="sc">:</span>peer <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sd),</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sigma),</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> cor)),</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.05"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4<span class="fl">.5</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: alcuse ~ 0 + Intercept + age_14 + coa + peer + age_14:coa + age_14:peer + (1 + age_14 | id) 
   Data: alcohol1_pp (Number of observations: 246) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 82) 
                      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sd(Intercept)            0.484     0.101    0.282    0.677 1.005      620     1183
sd(age_14)               0.374     0.081    0.211    0.531 1.011      389      611
cor(Intercept,age_14)    0.089     0.336   -0.428    0.849 1.017      289      399

Regression Coefficients:
            Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
Intercept     -0.311     0.152   -0.613   -0.011 1.001     2165     2545
age_14         0.429     0.121    0.188    0.659 1.001     1929     2603
coa            0.575     0.166    0.248    0.898 1.000     2331     2428
peer           0.694     0.115    0.468    0.922 1.001     2148     2639
age_14:coa    -0.012     0.132   -0.272    0.243 1.000     2960     2787
age_14:peer   -0.152     0.089   -0.322    0.028 1.000     1895     2601

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sigma    0.604     0.047    0.516    0.700 1.005      498     1748

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>All our <span class="math inline">\(\gamma\)</span> estimates are similar to those presented in Table 4.1. Let’s compute the variances and the covariance, <span class="math inline">\(\sigma_{01}^2\)</span>. Here are the plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a> v <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_0       =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_1       =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_01        =</span> sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>And now we compute the summary statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(value),</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value),</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(value),</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  name             mean median    sd     ll    ul
  &lt;chr&gt;           &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 sigma_01        0      0.006 0.056 -0.125 0.091
2 sigma_2_0       0.244  0.236 0.098  0.079 0.459
3 sigma_2_1       0.146  0.141 0.061  0.044 0.282
4 sigma_2_epsilon 0.367  0.362 0.058  0.267 0.49 </code></pre>
</div>
</div>
<p>Like the <span class="math inline">\(\gamma\)</span>’s, our variance components are all similar to those in the text.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit4.2_sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit4.2_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit4.2_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_draws_df</span>(fit4<span class="fl">.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="at">fit4.5_sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit4.5_sigma_2_0 =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit4.5_sigma_2_1 =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(median) <span class="sc">%&gt;%</span> </span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">% decline in sigma_2_epsilon</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">*</span> (fit4<span class="fl">.2</span>_sigma_2_epsilon <span class="sc">-</span> fit4<span class="fl">.5</span>_sigma_2_epsilon) <span class="sc">/</span> fit4<span class="fl">.2</span>_sigma_2_epsilon,</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">% decline in sigma_2_0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">*</span> (fit4<span class="fl">.2</span>_sigma_2_0 <span class="sc">-</span> fit4<span class="fl">.5</span>_sigma_2_0) <span class="sc">/</span> fit4<span class="fl">.2</span>_sigma_2_0,</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">% decline in sigma_2_1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">*</span> (fit4<span class="fl">.2</span>_sigma_2_1 <span class="sc">-</span> fit4<span class="fl">.5</span>_sigma_2_1) <span class="sc">/</span> fit4<span class="fl">.2</span>_sigma_2_1) <span class="sc">%&gt;%</span> </span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"%"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  name                          value
  &lt;chr&gt;                         &lt;dbl&gt;
1 % decline in sigma_2_epsilon  0.251
2 % decline in sigma_2_0       61.8  
3 % decline in sigma_2_1       -3.36 </code></pre>
</div>
</div>
<p>The percentages in which our variance components declined relative to the unconditional growth model are of similar orders of magnitude as those presented in the text.</p>
</section>
<section id="model-e-a-tentative-final-model-for-the-controlled-effects-of-coa" class="level4" data-number="4.5.2.3">
<h4 data-number="4.5.2.3" class="anchored" data-anchor-id="model-e-a-tentative-final-model-for-the-controlled-effects-of-coa"><span class="header-section-number">4.5.2.3</span> Model E: A tentative “final model” for the controlled effects of <code>coa</code></h4>
<p>This model is just like the last, but with the simple omission of the <span class="math inline">\(\gamma_{12}\)</span> parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol1_pp, </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> coa <span class="sc">+</span> peer <span class="sc">+</span> age_14<span class="sc">:</span>peer <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sd),</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>), <span class="at">class =</span> sigma),</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> cor)),</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4<span class="fl">.6</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity 
Formula: alcuse ~ 0 + Intercept + age_14 + coa + peer + age_14:peer + (1 + age_14 | id) 
   Data: alcohol1_pp (Number of observations: 246) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 82) 
                      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sd(Intercept)            0.478     0.105    0.269    0.679 1.002      772     1234
sd(age_14)               0.360     0.081    0.204    0.516 1.002      395      910
cor(Intercept,age_14)    0.140     0.349   -0.406    0.889 1.004      385      669

Regression Coefficients:
            Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
Intercept     -0.310     0.152   -0.612   -0.007 1.000     1855     2386
age_14         0.426     0.109    0.209    0.635 1.003     2101     2090
coa            0.570     0.150    0.282    0.861 1.001     2458     2688
peer           0.692     0.115    0.462    0.923 1.000     1865     2058
age_14:peer   -0.150     0.087   -0.319    0.026 1.001     1990     2253

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI  Rhat Bulk_ESS Tail_ESS
sigma    0.608     0.048    0.520    0.705 1.002      543     1561

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>The <span class="math inline">\(\gamma\)</span>’s all look well behaved. Here are the variance component summaries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a> v <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">sigma_2_epsilon =</span> sigma<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_0       =</span> sd_id__Intercept<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_2_1       =</span> sd_id__age_14<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sigma_01        =</span> sd_id__Intercept <span class="sc">*</span> cor_id__Intercept__age_14 <span class="sc">*</span> sd_id__age_14)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>v <span class="sc">%&gt;%</span> </span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(value),</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value),</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd     =</span> <span class="fu">sd</span>(value),</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul     =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  name             mean median    sd     ll    ul
  &lt;chr&gt;           &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 sigma_01        0.008  0.014 0.054 -0.113 0.094
2 sigma_2_0       0.24   0.229 0.1    0.073 0.461
3 sigma_2_1       0.136  0.13  0.059  0.042 0.267
4 sigma_2_epsilon 0.372  0.369 0.059  0.27  0.497</code></pre>
</div>
</div>
</section>
</section>
<section id="displaying-prototypical-change-trajectories" class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="displaying-prototypical-change-trajectories"><span class="header-section-number">4.5.3</span> Displaying prototypical change trajectories</h3>
<p>On page 111, Singer and Willett computed the various levels of the <span class="math inline">\(\pi\)</span> coefficients when <code>coa == 0</code> or <code>coa == 1</code>. To follow along, we’ll want to work directly with the posterior draws from <code>fit4.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.3</span>) </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  b_Intercept b_age_14 b_coa `b_age_14:coa`
        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;
1       0.501    0.155 0.477         0.125 
2       0.265    0.434 0.929        -0.171 
3       0.452    0.184 0.682        -0.0405
4       0.626    0.286 0.734        -0.113 
5       0.154    0.319 1.06         -0.184 
6       0.217    0.238 0.778         0.0450</code></pre>
</div>
</div>
<p>Here we apply the formulas to the posterior draws and then summarize with posterior means.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">pi_0_coa0 =</span> b_Intercept <span class="sc">+</span> b_coa          <span class="sc">*</span> <span class="dv">0</span>,</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">pi_1_coa0 =</span> b_age_14    <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:coa</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">0</span>,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">pi_0_coa1 =</span> b_Intercept <span class="sc">+</span> b_coa          <span class="sc">*</span> <span class="dv">1</span>,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">pi_1_coa1 =</span> b_age_14    <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:coa</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">posterior_mean =</span> <span class="fu">mean</span>(value) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  name      posterior_mean
  &lt;chr&gt;              &lt;dbl&gt;
1 pi_0_coa0          0.318
2 pi_0_coa1          1.06 
3 pi_1_coa0          0.294
4 pi_1_coa1          0.243</code></pre>
</div>
</div>
<p>We already plotted these trajectories and their 95% intervals a few sections up. If we want to work with the full composite model to predict <span class="math inline">\(Y_{ij}\)</span> (i.e., <code>alcuse</code>) directly, we multiply the <code>b_coa</code>, <code>b_age_14</code>, and <code>b_age_14:coa</code> vectors by the appropriate values of <code>coa</code> and <code>peer</code>. For example, here’s what you’d code if you wanted the initial <code>alcuse</code> status for when <code>coa == 1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> b_Intercept <span class="sc">+</span> b_coa <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> b_age_14 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:coa</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  b_Intercept b_age_14 b_coa `b_age_14:coa`     y
        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;
1       0.501    0.155 0.477         0.125  0.978
2       0.265    0.434 0.929        -0.171  1.19 
3       0.452    0.184 0.682        -0.0405 1.13 
4       0.626    0.286 0.734        -0.113  1.36 
5       0.154    0.319 1.06         -0.184  1.21 
6       0.217    0.238 0.778         0.0450 0.995</code></pre>
</div>
</div>
<p>If you were to take the mean of that new <code>y</code> column, you’d discover it’s the same as the mean of our <code>pi_0_coa1</code>, above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> b_Intercept <span class="sc">+</span> b_coa <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> b_age_14 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:coa</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">0</span> <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pi_0_coa1 =</span> <span class="fu">mean</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  pi_0_coa1
      &lt;dbl&gt;
1      1.06</code></pre>
</div>
</div>
<p>Singer and Willett suggested four strategies to help researchers pick the prototypical values of the predictors to focus on:</p>
<ul>
<li>Substantively interesting values (e.g., typical ages, values corresponding to transition points)</li>
<li>A range of percentiles (e.g., 25<sup>th</sup>, 50<sup>th</sup>, and 75<sup>th</sup>)</li>
<li>Just the sample mean</li>
<li>The sample mean <span class="math inline">\(\pm\)</span> something like 1 standard deviation</li>
</ul>
<p>They next discuss the right panel of Figure 4.3. We could continue to work directly with the <code>as_draws_df()</code> to make our version of that figure. But it you want to accompany the posterior mean trajectories with their 95% intervals, and I hope you do, the <code>as_draws_df()</code> method will get tedious. Happily, <strong>brms</strong> offers users and alternative with the <code>fitted()</code> function. Since the right panel is somewhat complicated, it’ll behoove us to practice with the simpler left panel, first.</p>
<p>In <code>fit4.2</code> (i.e., Model C), <code>age_14</code> is the only predictor. Here we’ll specify the values along the range in the original data, ranging from 0 to 2. However, we end up specifying a bunch of values within that range in addition to the two endpoints. This is because the 95% intervals typically have a bow tie shape. To depict that shape well, we need more than a couple values. We save those values as a tibble called <code>nd</code> (i.e., new data). We make use of them within fitted with the <code>newdata = nd</code> argument.</p>
<p>Since we’re only interested in the general trajectory, the consequence of the <span class="math inline">\(\gamma\)</span>’s, we end up coding <code>re_formula = NA</code>. In so doing, we ask <code>fitted()</code> to ignore the group-level effects. In this example, that means we are ignoring the <code>id</code>-level deviations from the overall trajectories. If you’re confused by that that means, don’t worry. That part of the model should become more clear as we go along in the text.</p>
<p>Since <code>fitted()</code> returns an array, we then convert the results into a data frame for use within the <strong>tidyverse</strong> framework. For plotting, it’s handy to bind those results together with the <code>nd</code>, the predictor values we used to compute the fitted values with. In the final wrangling step, we use our <code>age_14</code> values to compute the <code>age</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">age_14 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">30</span>))</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.2</span>, </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">%&gt;%</span> </span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> age_14 <span class="sc">+</span> <span class="dv">14</span>)</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Estimate Est.Error      Q2.5     Q97.5     age_14      age
1 0.6486449 0.1080202 0.4374269 0.8552847 0.00000000 14.00000
2 0.6673945 0.1062598 0.4588409 0.8694024 0.06896552 14.06897
3 0.6861442 0.1046542 0.4815716 0.8862499 0.13793103 14.13793
4 0.7048938 0.1032104 0.5020449 0.9004389 0.20689655 14.20690
5 0.7236434 0.1019356 0.5225452 0.9160866 0.27586207 14.27586
6 0.7423931 0.1008359 0.5418554 0.9329727 0.34482759 14.34483</code></pre>
</div>
</div>
<p>Since we only had one predictor, <code>age_14</code>, for which we specified 30 specific values, we ended up with 30 rows in our output. By default, <code>fitted()</code> summarized the fitted values with posterior means (<code>Estimate</code>), standard deviations (<code>Est.Error</code>), and percentile-based 95% intervals (<code>Q2.5</code> and <code>Q97.5</code>). The other columns are the values we bound to them. Here’s how we might use these to make our <code>fitted()</code> version of the leftmost panel of Figure 4.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age)) <span class="sc">+</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey75"</span>, <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>)) <span class="sc">+</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>With <code>fit4.6</code> (i.e., Model E), we now have three predictors. We’d like to see the full range across <code>age_14</code> for four combinations of <code>coa</code> and <code>peer</code> values. To my mind, the easiest way to get those values right is with a little <code>crossing()</code> and <code>expand()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">crossing</span>(<span class="at">coa  =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">peer =</span> <span class="fu">c</span>(<span class="fl">0.655</span>, <span class="fl">1.381</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">age_14 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">30</span>))</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nd, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
     coa  peer age_14
   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     0 0.655 0     
 2     0 0.655 0.0690
 3     0 0.655 0.138 
 4     0 0.655 0.207 
 5     0 0.655 0.276 
 6     0 0.655 0.345 
 7     0 0.655 0.414 
 8     0 0.655 0.483 
 9     0 0.655 0.552 
10     0 0.655 0.621 </code></pre>
</div>
</div>
<p>Now we use <code>fitted()</code> much like before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.6</span>, </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">%&gt;%</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a little wrangling will make plotting much easier</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age  =</span> age_14 <span class="sc">+</span> <span class="dv">14</span>,</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">coa  =</span> <span class="fu">ifelse</span>(coa <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"coa = 0"</span>, <span class="st">"coa = 1"</span>),</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">peer =</span> <span class="fu">factor</span>(peer))</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 120
Columns: 8
$ Estimate  &lt;dbl&gt; 0.1434126, 0.1660213, 0.1886299, 0.2112385, 0.2338471, 0.2564557, 0.2790643, 0.3016729, 0.3242815, 0.3468901, …
$ Est.Error &lt;dbl&gt; 0.1116056, 0.1099213, 0.1084337, 0.1071511, 0.1060808, 0.1052293, 0.1046021, 0.1042030, 0.1040348, 0.1040986, …
$ Q2.5      &lt;dbl&gt; -0.078921058, -0.053915222, -0.029177931, -0.005559805, 0.020911593, 0.044099037, 0.068646061, 0.093990729, 0.…
$ Q97.5     &lt;dbl&gt; 0.3649108, 0.3848853, 0.4041290, 0.4213087, 0.4410728, 0.4662987, 0.4864363, 0.5055074, 0.5282342, 0.5505795, …
$ coa       &lt;chr&gt; "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", "coa = 0", …
$ peer      &lt;fct&gt; 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655, 0.655…
$ age_14    &lt;dbl&gt; 0.00000000, 0.06896552, 0.13793103, 0.20689655, 0.27586207, 0.34482759, 0.41379310, 0.48275862, 0.55172414, 0.…
$ age       &lt;dbl&gt; 14.00000, 14.06897, 14.13793, 14.20690, 14.27586, 14.34483, 14.41379, 14.48276, 14.55172, 14.62069, 14.68966, …</code></pre>
</div>
</div>
<p>For our version of the right panel of Figure 4.3, most of the action is in <code>ggplot()</code>, <code>geom_ribbon()</code>, <code>geom_line()</code>, and <code>facet_wrap()</code>. All the rest is cosmetic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">color =</span> peer, <span class="at">fill =</span> peer)) <span class="sc">+</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate, <span class="at">size =</span> peer)) <span class="sc">+</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue3"</span>, <span class="st">"red3"</span>)) <span class="sc">+</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue3"</span>, <span class="st">"red3"</span>)) <span class="sc">+</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"High peer values are in red; low ones are in blue."</span>) <span class="sc">+</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>)) <span class="sc">+</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> coa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="441"></p>
</figure>
</div>
</div>
</div>
<p>In my opinion, it works better to split the plot into two when you include the 95% intervals.</p>
</section>
<section id="recentering-predictors-to-improve-interpretation" class="level3" data-number="4.5.4">
<h3 data-number="4.5.4" class="anchored" data-anchor-id="recentering-predictors-to-improve-interpretation"><span class="header-section-number">4.5.4</span> Recentering predictors to improve interpretation</h3>
<blockquote class="blockquote">
<p>The easiest strategy for recentering a time-invariant predictor is to subtract its sample mean from each observed value. When we center a predictor on its sample mean, the level-2 fitted intercepts represent the average fitted values of initial status (or rate of change). We can also recenter a time-invariant predictor by subtracting another meaningful value… Recentering works best when the centering constant is substantively meaningful. (pp.&nbsp;113–114)</p>
</blockquote>
<p>As we’ll see later, centering can also make it easier to select meaningful priors on the model intercept. If you look at our <code>alcohol1_pp</code> data, you’ll see we already have centered versions of our time-invariant predictors. They’re the last two columns, <code>cpeer</code> and <code>ccoa</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 246
Columns: 9
$ id     &lt;dbl&gt; 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10, 11, 11, 11, 12, 12, …
$ age    &lt;dbl&gt; 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 1…
$ coa    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ male   &lt;dbl&gt; 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age_14 &lt;dbl&gt; 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1,…
$ alcuse &lt;dbl&gt; 1.732051, 2.000000, 2.000000, 0.000000, 0.000000, 1.000000, 1.000000, 2.000000, 3.316625, 0.000000, 2.000000, 1.7…
$ peer   &lt;dbl&gt; 1.2649111, 1.2649111, 1.2649111, 0.8944272, 0.8944272, 0.8944272, 0.8944272, 0.8944272, 0.8944272, 1.7888544, 1.7…
$ cpeer  &lt;dbl&gt; 0.2469111, 0.2469111, 0.2469111, -0.1235728, -0.1235728, -0.1235728, -0.1235728, -0.1235728, -0.1235728, 0.770854…
$ ccoa   &lt;dbl&gt; 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0.549, 0…</code></pre>
</div>
</div>
<p>If you wanted to center them by hand, you’d just execute something like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">peer_c =</span> peer <span class="sc">-</span> <span class="fu">mean</span>(peer))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 246 × 10
      id   age   coa  male age_14 alcuse  peer  cpeer  ccoa peer_c
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    14     1     0      0   1.73 1.26   0.247 0.549  0.247
 2     1    15     1     0      1   2    1.26   0.247 0.549  0.247
 3     1    16     1     0      2   2    1.26   0.247 0.549  0.247
 4     2    14     1     1      0   0    0.894 -0.124 0.549 -0.123
 5     2    15     1     1      1   0    0.894 -0.124 0.549 -0.123
 6     2    16     1     1      2   1    0.894 -0.124 0.549 -0.123
 7     3    14     1     1      0   1    0.894 -0.124 0.549 -0.123
 8     3    15     1     1      1   2    0.894 -0.124 0.549 -0.123
 9     3    16     1     1      2   3.32 0.894 -0.124 0.549 -0.123
10     4    14     1     1      0   0    1.79   0.771 0.549  0.771
# ℹ 236 more rows</code></pre>
</div>
</div>
<p>Did you notice how our <code>peer_c</code> values, above, deviated slightly from those in <code>cpeer</code>? That’s because <code>peer_c</code> was based on the exact sample mean. Those in <code>cpeer</code> are based on the sample mean as provided in the text, 1.018, which is introduces rounding error. For the sake of simplicity, we’ll go with centered variables matching up with the text.</p>
<p>Here we’ll hastily fit the models with help from the <code>update()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  fit4<span class="fl">.6</span>,</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> alcohol1_pp,</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> coa <span class="sc">+</span> cpeer <span class="sc">+</span> age_14<span class="sc">:</span>cpeer <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.07"</span>)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>  fit4<span class="fl">.6</span>,</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> alcohol1_pp,</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>  alcuse <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> age_14 <span class="sc">+</span> ccoa <span class="sc">+</span> peer <span class="sc">+</span> age_14<span class="sc">:</span>peer <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> age_14 <span class="sc">|</span> id),</span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">4</span>,</span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit04.08"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we reproduce the <span class="math inline">\(\gamma\)</span>s from <code>fit4.6</code> and compare the to the updates from <code>fit4.7</code> and <code>fit4.8</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(fit4<span class="fl">.6</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate Est.Error   Q2.5  Q97.5
Intercept     -0.310     0.152 -0.612 -0.007
age_14         0.426     0.109  0.209  0.635
coa            0.570     0.150  0.282  0.861
peer           0.692     0.115  0.462  0.923
age_14:peer   -0.150     0.087 -0.319  0.026</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(fit4<span class="fl">.7</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Est.Error   Q2.5 Q97.5
Intercept       0.390     0.108  0.183 0.601
age_14          0.272     0.064  0.148 0.397
coa             0.576     0.151  0.280 0.878
cpeer           0.692     0.112  0.463 0.905
age_14:cpeer   -0.151     0.086 -0.317 0.020</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(fit4<span class="fl">.8</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate Est.Error   Q2.5 Q97.5
Intercept     -0.054     0.140 -0.322 0.227
age_14         0.423     0.109  0.205 0.635
ccoa           0.579     0.149  0.286 0.870
peer           0.692     0.112  0.467 0.909
age_14:peer   -0.150     0.086 -0.316 0.022</code></pre>
</div>
</div>
</section>
</section>
<section id="comparing-models-using-deviance-statistics" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="comparing-models-using-deviance-statistics"><span class="header-section-number">4.6</span> Comparing models using deviance statistics</h2>
<p>As you will see, we will also make use of deviance within our Bayesian Stan-based paradigm. But we’ll do so a little differently than what Singer and Willett presented.</p>
<section id="the-deviance-statistic" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="the-deviance-statistic"><span class="header-section-number">4.6.1</span> The deviance statistic</h3>
<p>As it turns out, we Bayesians use the log-likelihood (LL), too. Recall how the numerator in the right-hand side of Bayes’ Theorem was <span class="math inline">\(p(\text{data} \mid \theta) p(\theta)\)</span>? That first part, <span class="math inline">\(p(\text{data} \mid \theta)\)</span>, is the likelihood. In words, the likelihood is the <em>probability of the data given the parameters</em>. We generally work with the log of the likelihood rather than the likelihood itself because it’s easier to work with statistically.</p>
<p>When you’re working with <strong>brms</strong>, you can extract the LL with the <code>log_lik()</code> function. Here’s an example with <code>fit4.1</code>, our unconditional means model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log_lik</span>(fit4<span class="fl">.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1:246] -0.694 -0.752 -0.984 -0.665 -0.769 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : NULL</code></pre>
</div>
</div>
<p>You may have noticed we didn’t just get a single value back. Rather, we got an array of 4,000 rows and 246 columns. The reason we got 4,000 rows is because that’s how many post-warmup iterations we drew from the posterior. I.e., we set <code>brm(..., iter = 2000, warmup = 1000, chains = 4)</code>. With respect to the 246 columns, that’s how many rows there are in the <code>alcohol1_pp</code> data. So for each case in the data, we get an entire posterior distribution of LL values.</p>
<p>With the multilevel model, we can define deviance for a given model as its LL times -2,</p>
<p><span class="math display">\[
\text{Deviance} = -2 LL_\text{current model}.
\]</span></p>
<p>Here that is in code for <code>fit4.1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> <span class="fu">log_lik</span>(fit4<span class="fl">.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">rowSums</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deviance =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll) <span class="sc">%&gt;%</span> </span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ll, deviance, <span class="fu">everything</span>())</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(ll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4000  248</code></pre>
</div>
</div>
<p>Because we used HMC, deviance is a distribution rather than a single number. Here’s what it looks like for <code>fit4.1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>ll <span class="sc">%&gt;%</span> </span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> deviance)) <span class="sc">+</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey25"</span>, <span class="at">size =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Much like the frequentists, we Bayesian generally prefer models with smaller deviance distributions.</p>
<p>The reasons frequentists multiply the LL by -2 is because after doing so, the difference in deviance values between two models follows a <span class="math inline">\(\chi^2\)</span> distribution and the old <span class="math inline">\(\chi^2\)</span>-difference test is widely-used in frequentist statistics. Bayesians often just go ahead and use the -2 multiplication, too. It’s largely out of tradition. But as we’ll see, some contemporary Bayesians are challenging that tradition.</p>
</section>
<section id="when-and-how-can-you-compare-deviance-statistics" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="when-and-how-can-you-compare-deviance-statistics"><span class="header-section-number">4.6.2</span> When and how can you compare deviance statistics?</h3>
<p>As for the frequentists, deviance values/distributions in the Bayesian context are only meaningful in the relative sense. You cannot directly interpret a single models deviance distribution by the magnitude or sign of its central tendency. But you can compare two or more models by the relative locations of their deviance distributions. When doing so, they must have been computed using the same data (i.e., no differences in missingness in the predictors) and the models must be nested.</p>
<p>However, in contemporary Bayesian practice we don’t tend to compare models with deviance. For details on why, check out Chapter 6 in McElreath’s <a href="https://xcelab.net/rm/statistical-rethinking/"><em>Statistical Rethinking</em></a>. McElreath also covered the topic in several online lectures (e.g., <a href="https://www.youtube.com/watch?v=vSjL2Zc-gEQ&amp;list=PLDcUM9US4XdMdZOhJWJJD4mDBMnbTWw_z&amp;index=8">here</a> and <a href="https://www.youtube.com/watch?v=gjrsYDJbRh0&amp;list=PLDcUM9US4XdNM4Edgs7weiyIguLSToZRI&amp;index=8">here</a>).</p>
</section>
<section id="implementing-deviance-based-hypothesis-tests" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="implementing-deviance-based-hypothesis-tests"><span class="header-section-number">4.6.3</span> Implementing deviance-based hypothesis tests</h3>
<p>In this project, we are not going to practice comparing deviance values using frequentist <span class="math inline">\(\chi^2\)</span> tests. We will, however, cover Bayesian information criteria.</p>
</section>
<section id="aic-and-bic-waic-and-loo-statistics-comparing-nonnested-models-using-information-criteria-and-cross-validation" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="aic-and-bic-waic-and-loo-statistics-comparing-nonnested-models-using-information-criteria-and-cross-validation"><span class="header-section-number">4.6.4</span> <del>AIC and BIC</del> WAIC and LOO statistics: Comparing nonnested models using information criteria [and cross validation]</h3>
<p>We do not use the AIC or the BIC within the Stan ecosystem. The AIC is frequentist and cannot handle models with priors. The BIC is interesting in it’s a double misnomer. It is neither Bayesian nor is it a proper information criterion–though it does scale like one. However, it might be useful for our purposes to walk out the AIC a bit. It’ll ground our discussion of the WAIC and LOO. From Spiegelhalter, Best, Carlin and van der Linde [@-spiegelhalterDevianceInformationCriterion2014], we read:</p>
<blockquote class="blockquote">
<p>Suppose that we have a given set of candidate models, and we would like a criterion to assess which is ‘better’ in a defined sense. Assume that a model for observed data <span class="math inline">\(y\)</span> postulates a density <span class="math inline">\(p(y \mid \theta)\)</span> (which may include covariates etc.), and call <span class="math inline">\(D(\theta) = -2 \log {p(y \mid \theta)}\)</span> the deviance, here considered as a function of <span class="math inline">\(\theta\)</span>. Classical model choice uses hypothesis testing for comparing nested models, e.g.&nbsp;the deviance (likelihood ratio) test in generalized linear models. For non nested models, alternatives include the Akaike information criterion</p>
<p><span class="math display">\[AIC = -2 \log {p(y \mid \hat{\theta})} + 2k\]</span></p>
<p>where <span class="math inline">\(\hat{\theta}\)</span> is the maximum likelihood estimate and <span class="math inline">\(k\)</span> is the number of parameters in the model (dimension of <span class="math inline">\(\Theta\)</span>).</p>
<p>AIC is built with the aim of favouring models that are likely to make good predictions. Since we generally do not have independent validation data, we can assess which model best predicts the <em>observed</em> data by using the deviance, but if parameters have been estimated we need some penalty for this double use of the data. AIC’s penalty of <em>2k</em> has been shown to be asymptotically equivalent to leave-one-out cross-validation. However, AIC does not work in models with informative prior information, such as hierarchical models, since the prior effectively acts to ‘restrict’ the freedom of the model parameters, so the appropriate ‘number of parameters’ is generally unclear. (pp.&nbsp;485–486, <em>emphasis</em> in the original)</p>
</blockquote>
<p>For the past two decades, the Deviance Information Criterion [DIC; <span class="citation" data-cites="spiegelhalterBayesianMeasuresModel2002">Spiegelhalter et al. (<a href="references.html#ref-spiegelhalterBayesianMeasuresModel2002" role="doc-biblioref">2002</a>)</span>] has been a popular information criterion among Bayesians. Let’s define <span class="math inline">\(D\)</span> as the posterior distribution of deviance values and <span class="math inline">\(\bar D\)</span> as its mean. If you compute deviance based on the posterior mean, you have <span class="math inline">\(\hat D\)</span>. Within a multi-parameter model, this would be the deviance based on the collection of the posterior mean of each parameter. With these, we define the DIC as</p>
<p><span class="math display">\[\text{DIC} = \bar D + (\bar D + \hat D) + \bar D + p_D,\]</span></p>
<p>where <span class="math inline">\(p_D\)</span> is the number of effective parameters in the model, which is also sometimes referred to as the penalty term. As McElreath pointed out in <a href="https://xcelab.net/rm/statistical-rethinking/"><em>Statistical Rethinking</em></a>, the <span class="math inline">\(p_D\)</span></p>
<blockquote class="blockquote">
<p>is just the expected distance between the deviance in-sample and the deviance out-of-sample. In the case of flat priors, DIC reduces directly to AIC, because the expected distance is just the number of parameters. But more generally, <span class="math inline">\(p_D\)</span> will be some fraction of the number of parameters, because regularizing priors constrain a model’s flexibility. (p.&nbsp;191)</p>
</blockquote>
<p>As you’ll see, you can get the <span class="math inline">\(p_D\)</span> for <code>brms::brm()</code> models. However, the DIC is limited in that it requires a multivariate Gaussian posterior and I’m not aware of a convenience function within <strong>brms</strong> that will compute the DIC. Which is fine. The DIC has been overshadowed in recent years by newer methods. But for a great talk on the DIC, check out the authoritative David Spiegelhalter’s <a href="https://www.youtube.com/watch?v=H-59eqmHuuQ&amp;frags=pl%2Cwn"><em>Retrospective read paper: Bayesian measure of model complexity and fit</em></a>.</p>
<section id="the-widely-applicable-information-criterion-waic" class="level4" data-number="4.6.4.1">
<h4 data-number="4.6.4.1" class="anchored" data-anchor-id="the-widely-applicable-information-criterion-waic"><span class="header-section-number">4.6.4.1</span> The Widely Applicable Information Criterion (WAIC)</h4>
<p>The main information criterion within our Stan ecosystem paradigm is the Widely Applicable Information Criterion [WAIC; <span class="citation" data-cites="watanabeAsymptoticEquivalenceBayes2010">Watanabe (<a href="references.html#ref-watanabeAsymptoticEquivalenceBayes2010" role="doc-biblioref">2010</a>)</span>]. From McElreath, again, we read:</p>
<blockquote class="blockquote">
<p>It does not require a multivariate Gaussian posterior, and it is often more accurate than DIC. There are types of models for which it is hard to define at all, however. We’ll discuss that issue more, after defining WAIC.</p>
<p>The distinguishing feature of WAIC is that it is <em>pointwise</em>. This means that uncertainty in prediction is considered case-by-case, or point-by-point, in the data. This is useful, because some observations are much harder to predict than others and may also have different uncertainty… You can think of WAIC as handling uncertainty where it actually matters: for each independent observation.</p>
<p>Define <span class="math inline">\(\Pr (y_i)\)</span> as the average likelihood of observation <span class="math inline">\(i\)</span> in the training sample. This means we compute the likelihood of <span class="math inline">\(y_i\)</span> for each set of parameters samples from the posterior distribution. Then we average the likelihoods for each observation <span class="math inline">\(i\)</span> and finally sum over all observations. This produces the first part of WAIC, the log-pointwise-predictive-density,</p>
<p><span class="math display">\[\text{lppd} = \sum_{i = 1}^N \log \Pr (y_i)\]</span></p>
<p>You might say this out loud as:</p>
<blockquote class="blockquote">
<p><em>The log-pointwise-predictive-density is the total across observations of the logarithm of the average likelihood of each observation.</em></p>
</blockquote>
<p>The lppd is just a pointwise analog of deviance, averaged over the posterior distribution. If you multiplied it by -2, it’d be similar to the deviance, in fact.</p>
<p>The second piece of WAIC is the effective number of parameters <span class="math inline">\(p_\text{WAIC}\)</span>. Define <span class="math inline">\(V(y_i)\)</span> as the variance in log-likelihood for observation <span class="math inline">\(i\)</span> in the training sample. This means we compute the log-likelihood of <span class="math inline">\(y_i\)</span> for each sample from the posterior distribution. Then we take the variance of those values. This is <span class="math inline">\(V(y_i)\)</span>. Now <span class="math inline">\(p_\text{WAIC}\)</span> is defined as:</p>
<p><span class="math display">\[p_\text{WAIC} = \sum_{i=1}^N V(y_i)\]</span></p>
<p>Now WAIC is defined as:</p>
<p><span class="math display">\[\text{WAIC} = -2(\text{lppd} - p_\text{WAIC})\]</span></p>
<p>And this value is yet another estimate of out-of-sample deviance. (pp.&nbsp;191–192, emphasis in the original)</p>
</blockquote>
<p>In <a href="https://bookdown.org/content/3890/overfitting-regularization-and-information-criteria.html">Chapter 6 of my ebook</a> translating McElreath’s <em>Statistical Rethinking</em> into <strong>brms</strong> and <strong>tidyverse</strong> code, I walk out how to hand compute the WAIC for a <code>brm()</code> fit. I’m not going to repeat the exercise, here. But do see the project and McElreath’s text if you’re interested. Rather, I’d like to get down to business. In <strong>brms</strong>, you can get a model’s WAIC with the <code>waic()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">waic</span>(fit4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 246 log-likelihood matrix.

          Estimate   SE
elpd_waic   -312.7 12.2
p_waic        55.7  4.9
waic         625.4 24.4

39 (15.9%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
</div>
<p>We’ll come back to that warning, later. For now, notice the main output is a <span class="math inline">\(3 \times 2\)</span> data frame with named rows. For the statistic in each row, you get a point estimate and a standard error. The WAIC is on the bottom. The effective number of parameters, the <span class="math inline">\(p_\text{WAIC}\)</span>, is in the middle. Notice the <code>elpd_waic</code> on the top. That’s what you get without the <span class="math inline">\(-2 \times \dots\)</span> in the formula. Remember how that part is just to put things in a metric amenable to <span class="math inline">\(\chi^2\)</span>-difference testing? Well, not all Bayesians like that and within the Stan ecosystem you’ll also see the WAIC expressed instead as the <span class="math inline">\(\text{elpd}_\text{WAIC}\)</span>.</p>
<p>The current recommended workflow within <strong>brms</strong> is to attach the WAIC information to the model fit. You do it with the <code>add_criterion()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4<span class="fl">.1</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now you can access that information directly with good-old <code>$</code> indexing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.1</span><span class="sc">$</span>criteria<span class="sc">$</span>waic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 246 log-likelihood matrix.

          Estimate   SE
elpd_waic   -312.7 12.2
p_waic        55.7  4.9
waic         625.4 24.4

39 (15.9%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
</div>
<p>You might notice how that value is similar to the AIC and BIC values for Model A in Table 4.1. But it’s not identical and we shouldn’t expect it to be. It was computed by a different formula that accounts for priors. For our purposes, this is much better than the frequentist AIC and BIC. We need statistics that can handle priors.</p>
</section>
<section id="leave-one-out-cross-validation-loo-cv" class="level4" data-number="4.6.4.2">
<h4 data-number="4.6.4.2" class="anchored" data-anchor-id="leave-one-out-cross-validation-loo-cv"><span class="header-section-number">4.6.4.2</span> Leave-one-out cross-validation (LOO-CV)</h4>
<p>We have another big option for model comparison within the Stan ecosystem. It involves leave-one-out cross-validation (LOO-CV). It’s often the case that we aren’t just interested in modeling the data we have in hand. The hope is our findings would generalize to other data we could have collected or may collect in the future. We’d like our findings to tell us something more general about the world at large. But unless you’re studying something highly uniform like the weights of hydrogen atoms, chances are your data have idiosyncrasies that won’t generalize well to other data. Sure, if we had all the information on all the relevant variables, we could explain the discrepancies across samples with hidden moderators and such. But we don’t have all the data and we typically don’t even know what all the relevant variables are.</p>
<p>Welcome to science.</p>
<p>To address this problem, you might recommend we collect data from two samples for each project. Starting with sample A, we’d fit a series of models and settle on one or a small subset that both speak to our scientific hypothesis and seem to fit the sample A data well. Then we’d switch to sample B and rerun our primary model(s) from A to make sure our findings generalize. In this paradigm, we might call the A data <em>in sample</em> and the B data <em>out of sample</em>–or out of sample A, anyways.</p>
<p>The problem is we often have time and funding constraints. We only have sample A and we may never collect sample B. So we’ll need to make the most out of A. Happily, tricky statisticians have our back. Instead, what we might do is divide our data into <span class="math inline">\(k\)</span> equally-sized subsets. Call those subsets <em>folds</em>. If we leave one of the folds out, we can fit the model with the remaining data and then see how well that model speaks to the left-out fold. After doing this for every fold, we can get an average performance across folds.</p>
<p>Note how as <span class="math inline">\(k\)</span> increases, the number of cases with a fold get smaller. In the extreme, <span class="math inline">\(k = N\)</span>, the number of cases within the data. At that point, <span class="math inline">\(k\)</span>-fold cross-validation turns into leave-one-out cross-validation (LOO-CV).</p>
<p>But there’s a practical difficulty with LOO-CV: it’s costly. As you may have noticed, it takes some time to fit a Bayesian multilevel model. For large data and/or complicated models, sometimes it takes hours or days. Most of us just don’t have enough time or computational resources to fit that many models. Happily, we have an approximation to pure LOO-CV. Vehtari, Gelman, and Gabry <span class="citation" data-cites="vehtariPracticalBayesianModel2017">(<a href="references.html#ref-vehtariPracticalBayesianModel2017" role="doc-biblioref">2017</a>)</span> proposed Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) as an efficient way to approximate true LOO-CV. At this point, it’s probably best to let the statisticians speak for themselves:</p>
<blockquote class="blockquote">
<p>To maintain comparability with the given dataset and to get easier interpretation of the differences in scale of effective number of parameters, we define a measure of predictive accuracy for the <span class="math inline">\(n\)</span> data points taken one at a time:</p>
<p><span class="math display">\[\begin{align}
\text{elpd} &amp; = \text{expected log pointwise predictive density for a new dataset} \\
&amp; = \sum_{i = 1}^n \int p_t (\tilde{y}_i) \log p (\tilde{y}_i \mid y) d \tilde{y}_i,
\end{align}\]</span></p>
<p>where <span class="math inline">\(p_t (\tilde{y}_i)\)</span> is the distribution representing the true data-generating process for <span class="math inline">\(\tilde{y}_i\)</span>. The <span class="math inline">\(p_t (\tilde{y}_i)\)</span>’s are unknown, and we will use cross-validation or WAIC to approximate. In a regression, these distributions are also implicitly conditioned on any predictors in the model…</p>
<p>The Bayesian LOO estimate of out-of-sample predictive fit is</p>
<p><span class="math display">\[\text{elpd}_{\text{loo}} = \sum_{i = 1}^n \log p (y_i \mid y - _i),\]</span></p>
<p>where</p>
<p><span class="math display">\[p (y_i \mid y - _i) = \int p (y_i \mid \theta) p (\theta \mid y - _i) d \theta\]</span></p>
<p>is the leave-one-out predictive density given the data without the ith data point. (pp.&nbsp;2–3)</p>
</blockquote>
<p>For the rest of the details, check out the original paper. Our goal is to practice using the PSIS-LOO. Since this is the only version of the LOO we’ll be using in this project, I’m just going to refer to it as the LOO from here on. To use the LOO to evaluate a <code>brm()</code> fit, you just use the <code>loo()</code> function. Though you don’t have to save the results as an object, we’ll be forward thinking and do so here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>l_fit4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">loo</span>(fit4<span class="fl">.1</span>)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(l_fit4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 246 log-likelihood matrix.

         Estimate   SE
elpd_loo   -316.3 12.6
p_loo        59.4  5.3
looic       632.7 25.2
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 2.5]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     241   98.0%   424     
   (0.7, 1]   (bad)        5    2.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>Remember that warning we got from the <code>waic()</code> a while back? We get more information along those lines from the <code>loo()</code>. As it turns out, a few of the cases in the data were unduly influential in the model fit. Within the <code>loo()</code> paradigm, those are indexed by the <code>pareto_k</code> values. As it turns out, the Pareto <span class="math inline">\(k\)</span> <a href="https://cran.r-project.org/web/packages/loo/vignettes/loo2-example.html#plotting-pareto-k-diagnostics">can be used as a diagnostic tool</a>. Each case in the data gets its own <span class="math inline">\(k\)</span> value and we like it when those <span class="math inline">\(k\)</span>’s are low. We typically get worried when those <span class="math inline">\(k\)</span>’s exceed 0.7 and the <code>loo()</code> function spits out a warning when they do.</p>
<p>If you didn’t know, the <strong>brms</strong> functions like the <code>waic()</code> and <code>loo()</code> actually come from the <a href="https://CRAN.R-project.org/package=loo"><strong>loo</strong> package</a> <span class="citation" data-cites="R-loo vehtariPracticalBayesianModel2017 yaoUsingStackingAverage2018">(<a href="references.html#ref-vehtariPracticalBayesianModel2017" role="doc-biblioref">Vehtari et al., 2017</a>; <a href="references.html#ref-R-loo" role="doc-biblioref">Vehtari et al., 2022</a>; <a href="references.html#ref-yaoUsingStackingAverage2018" role="doc-biblioref">Yao et al., 2018</a>)</span>. Explicitly loading <strong>loo</strong> will buy us some handy convenience functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll be leveraging those <span class="math inline">\(k\)</span> values with the <code>pareto_k_table()</code> and <code>pareto_k_ids()</code> functions. Both functions take objects created by the <code>loo()</code> or <code>psis()</code> functions. Let’s take a look at the <code>pareto_k_table()</code> function first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pareto_k_table</span>(l_fit4<span class="fl">.1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     241   98.0%   424     
   (0.7, 1]   (bad)        5    2.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;    </code></pre>
</div>
</div>
<p>This is the same table that popped out earlier after using the <code>loo()</code>. Recall that this data set has 246 observations (i.e., execute <code>count(alcohol1_pp)</code>). With <code>pareto_k_table()</code>, we see how the Pareto <span class="math inline">\(k\)</span> values have been categorized into bins ranging from “good” to “very bad”. Clearly, we like nice and low <span class="math inline">\(k\)</span>’s. In this example, most of our observations are “good” or “ok.” Two are in the “bad” <span class="math inline">\(k\)</span> range. We can take a closer look by placing our <code>loo()</code> object into <code>plot()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(l_fit4<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-89-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>We got back a nice diagnostic plot for those <span class="math inline">\(k\)</span> values, ordered by row number. We can see that our three observations with the “bad” <span class="math inline">\(k\)</span> values were earlier in the data and it appears their <span class="math inline">\(k\)</span> values are just a smidge above the recommended threshold. If we wanted to further verify to ourselves which observations those were, we’d use the <code>pareto_k_ids()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pareto_k_ids</span>(l_fit4<span class="fl">.1</span>, <span class="at">threshold =</span> <span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  27  33 132 177 229</code></pre>
</div>
</div>
<p>Note our use of the <code>threshold</code> argument. Play around with it to see how it works. In case you’re curious, here are those rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">pareto_k_ids</span>(l_fit4<span class="fl">.1</span>, <span class="at">threshold =</span> <span class="fl">0.7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 9
     id   age   coa  male age_14 alcuse  peer  cpeer   ccoa
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     9    16     1     1      2   3.46 0     -1.02   0.549
2    11    16     1     1      2   3.16 0     -1.02   0.549
3    44    16     0     1      2   3    0     -1.02  -0.451
4    59    16     0     1      2   2.65 0.894 -0.124 -0.451
5    77    14     0     1      0   0    0.894 -0.124 -0.451</code></pre>
</div>
</div>
<p>If you want an explicit look at those <span class="math inline">\(k\)</span> values, execute <code>l_fit4.1$diagnostics$pareto_k</code>. For the sake of space, I’m going to omit the output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>l_fit4<span class="fl">.1</span><span class="sc">$</span>diagnostics<span class="sc">$</span>pareto_k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>pareto_k</code> values can be used to examine cases that are overly-influential on the model parameters, something like a Cook’s <span class="math inline">\(D_i\)</span>. See, for example <a href="https://stackoverflow.com/questions/39578834/linear-model-diagnostics-for-bayesian-models-using-rstan/39595436">this discussion on stackoverflow.com</a> in which several members of the <a href="http://mc-stan.org">Stan team</a> weighed in. The issue is also discussed in <span class="citation" data-cites="vehtariPracticalBayesianModel2017">Vehtari et al. (<a href="references.html#ref-vehtariPracticalBayesianModel2017" role="doc-biblioref">2017</a>)</span> and in <a href="https://www.youtube.com/watch?v=FUROJM3u5HQ&amp;feature=youtu.be&amp;a=">this presentation by Aki Vehtari</a>.</p>
<p>Anyway, the implication of all this is these values suggest <code>fit4.1</code> (i.e., Model A) might not be the best model of the data. Happily, we have other models to compare it to. That leads into the next section:</p>
</section>
<section id="you-can-compare-bayesian-models-with-the-waic-and-loo" class="level4" data-number="4.6.4.3">
<h4 data-number="4.6.4.3" class="anchored" data-anchor-id="you-can-compare-bayesian-models-with-the-waic-and-loo"><span class="header-section-number">4.6.4.3</span> You can compare Bayesian models with the WAIC and LOO</h4>
<p>Remember how we used the <code>add_criterion()</code> function, above. That’ll work for both WAIC and the LOO. Let’s do that for Models A through E.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4<span class="fl">.1</span>, <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4<span class="fl">.2</span>, <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4<span class="fl">.3</span>, <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4<span class="fl">.5</span>, <span class="at">criterion =</span> <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And to refresh, we can pull the WAIC and LOO information with <code>$</code> indexing. Here’s how to get the LOO info for <code>fit4.2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>fit4<span class="fl">.2</span><span class="sc">$</span>criteria<span class="sc">$</span>loo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 246 log-likelihood matrix.

         Estimate   SE
elpd_loo   -289.5 12.7
p_loo        94.7  7.5
looic       578.9 25.4
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.2, 1.8]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     218   88.6%   88      
   (0.7, 1]   (bad)       27   11.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)   1    0.4%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>Sigh. Turns out there are even more overly-influential cases in the unconditional growth model. In the case of a real data analysis, this might suggest we need a more robust model. One possible solution might be switching out our Gaussian likelihood for the robust Student’s <span class="math inline">\(t\)</span>-distribution. For an introduction, you might check out my blog post on the topic, <a href="https://solomonkurz.netlify.app/blog/2019-02-02-robust-linear-regression-with-student-s-t-distribution/"><em>Robust Linear Regression with Student’s <span class="math inline">\(t\)</span>-Distribution</em></a>. But that’ll take us farther afield than I want to go, right now.</p>
<p>The point to focus on, here, is we can use the <code>loo_compare()</code> function to compare fits by their WAIC or LOO. Let’s practice with the WAIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>ws <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(fit4<span class="fl">.1</span>, fit4<span class="fl">.2</span>, fit4<span class="fl">.3</span>, fit4<span class="fl">.5</span>, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff
fit4.5   0.0       0.0  
fit4.3  -5.1       3.7  
fit4.2  -6.1       4.2  
fit4.1 -42.1       8.3  </code></pre>
</div>
</div>
<p>Remember how we said that some contemporary Bayesians aren’t fans of putting Bayesian information criteria in a <span class="math inline">\(\chi^2\)</span> metric? Well, it turns out <a href="https://users.aalto.fi/~ave/">Aki Vehtari</a>, of the Stan team and <strong>loo</strong> package fame–and also the primary author in that <a href="https://arxiv.org/abs/1507.04544">PSIS-LOO paper</a> from before–, is one of those Bayesians. So instead of getting difference scores in the WAIC metric, we get them in the <span class="math inline">\(\text{elpd}_\text{WAIC}\)</span> metric instead. But remember, if you prefer these estimates in the traditional metric, just multiply by -2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">waic_diff =</span> ws[, <span class="dv">1</span>] <span class="sc">*</span> <span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">se        =</span> ws[, <span class="dv">2</span>] <span class="sc">*</span>  <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       waic_diff        se
fit4.5   0.00000  0.000000
fit4.3  10.20884  7.354128
fit4.2  12.14385  8.391621
fit4.1  84.28362 16.638349</code></pre>
</div>
</div>
<p>The reason we multiplied the <code>se_diff</code> column (i.e., the standard errors for the difference estimates) by 2 is because you can’t have negative standard errors. That’d be silly.</p>
<p>But anyway, notice that the <code>brm()</code> fits have been rank ordered with the smallest differences at the top. Each row in the output is the difference of one of the fits compared to the best-fitting fit. Since <code>fit4.5</code> apparently had the lowest WAIC value, it was ranked at the top. And notice how its <code>waic_diff</code> is 0. That, of course, is because <span class="math inline">\(x - x = 0\)</span>. So all the other difference scores are follow the formula <span class="math inline">\(\text{Difference}_x = \text{WAIC}_\text{fit\_x} - \text{WAIC}_\text{fit\_4.5}\)</span>.</p>
<p>Concerning our <code>ws</code> object, we can get more information on our models’ WAIC information if we include a <code>simplify = F</code> argument within <code>print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ws, <span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
fit4.5    0.0       0.0  -270.5      11.1         74.5    5.6     541.1   22.2 
fit4.3   -5.1       3.7  -275.6      11.5         80.7    6.2     551.3   23.0 
fit4.2   -6.1       4.2  -276.6      11.7         81.9    6.4     553.2   23.3 
fit4.1  -42.1       8.3  -312.7      12.2         55.7    4.9     625.4   24.4 </code></pre>
</div>
</div>
<p>Their WAIC estimates and the associated standard errors are in the final two columns. In the two before that, we get the <span class="math inline">\(p_\text{WAIC}\)</span> estimates and their standard errors. We can get similar information for the LOO.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(fit4<span class="fl">.1</span>, fit4<span class="fl">.2</span>, fit4<span class="fl">.3</span>, fit4<span class="fl">.5</span>, <span class="at">criterion =</span> <span class="st">"loo"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
fit4.5    0.0       0.0  -282.3     12.0        86.3    6.8    564.5   24.1  
fit4.3   -5.5       3.9  -287.8     12.4        92.9    7.2    575.6   24.7  
fit4.2   -7.2       4.5  -289.5     12.7        94.7    7.5    578.9   25.4  
fit4.1  -34.1       8.5  -316.3     12.6        59.4    5.3    632.7   25.2  </code></pre>
</div>
</div>
<p>If you wanted a more focused comparison, say between <code>fit1</code> and <code>fit2</code>, you’d just simplify your input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(fit4<span class="fl">.1</span>, fit4<span class="fl">.2</span>, <span class="at">criterion =</span> <span class="st">"loo"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">simplify =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
fit4.2    0.0       0.0  -289.5     12.7        94.7    7.5    578.9   25.4  
fit4.1  -26.9       7.8  -316.3     12.6        59.4    5.3    632.7   25.2  </code></pre>
</div>
</div>
<p>We’ll get more practice with these methods as we go along. But for your own edification, you might check out <a href="https://CRAN.R-project.org/package=loo">the vignettes</a> put out by the <strong>loo</strong> team.</p>
</section>
</section>
</section>
<section id="using-wald-statistics-to-test-composite-hypotheses-about-fixed-effects" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="using-wald-statistics-to-test-composite-hypotheses-about-fixed-effects"><span class="header-section-number">4.7</span> Using Wald statistics to test composite hypotheses about fixed effects</h2>
<p>I’m not going to address issues of composite null-hypothesis tests using the Wald statistic. However, we can address some of these issues from a different more estimation-based perspective. Consider the initial question posed on page 123:</p>
<blockquote class="blockquote">
<p>Suppose, for example, you wanted to test whether the entire true change trajectory for a particular type of adolescent–say, a child of non-alcoholic parents with an average value of <em>PEER</em>–differs from a “null” trajectory (one with zero intercept and zero slope). This is tantamount to asking whether the average child of non-alcoholic parents drinks no alcohol at age 14 and remains abstinent over time.</p>
</blockquote>
<p>Singer and Willett then expressed their joint null hypothesis as</p>
<p><span class="math display">\[H_0: \gamma_{00} = 0 \; \text{and} \; \gamma_{10} = 0.\]</span></p>
<p>This is a substantive question we can address more informatively with <code>fitted()</code>. First, let’s provide the necessary values for our predictor variables, <code>coa</code>, <code>peer</code>, and <code>age_14</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>mu_peer <span class="ot">&lt;-</span> <span class="fu">mean</span>(alcohol1_pp<span class="sc">$</span>peer)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coa    =</span> <span class="dv">0</span>,</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">peer   =</span> mu_peer,</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_14 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">30</span>))</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
    coa  peer age_14
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     0  1.02 0     
2     0  1.02 0.0690
3     0  1.02 0.138 
4     0  1.02 0.207 
5     0  1.02 0.276 
6     0  1.02 0.345 </code></pre>
</div>
</div>
<p>Now we use <code>fitted()</code> to examine the model-implied trajectory for a child of non-alcoholic parents and average <code>peer</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.6</span>, </span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd) <span class="sc">%&gt;%</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> age_14 <span class="sc">+</span> <span class="dv">14</span>) </span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age)) <span class="sc">+</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Zero is credible for neither</span><span class="sc">\n</span><span class="st">the intercept nor the slope."</span>) <span class="sc">+</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>)) <span class="sc">+</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-101-1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Recall that the result of our Bayesian analyses are the probability of the parameters given the data, <span class="math inline">\(p(\theta \mid d)\)</span>. Based on our plot, there is much less than a .05 probability either intercept or slope for teens of this demographic are zero. If you really wanted to fixate on zero, you could even use <code>geom_hline()</code> to insert a horizontal line at zero in the figure. But all that fixating on zero detracts from what to my mind are the more important parts of the model. The intercept at <code>age = 14</code> is about 1/3 and the endpoint when <code>age = 16</code> is almost at <span class="math inline">\(1\)</span>. Those are our effect sizes. If you wanted to quantify those effect sizes more precisely, just query our <code>fitted()</code> object, <code>f</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, Estimate, Q2<span class="fl">.5</span>, Q97<span class="fl">.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">14</span>, <span class="dv">16</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(round, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  age Estimate Q2.5 Q97.5
1  14     0.39 0.18  0.61
2  16     0.94 0.67  1.21</code></pre>
</div>
</div>
<p>Works like a champ. But we haven’t fully covered part of Singer and Willett’s joint hypothesis test. They proposed a joint Null that included the <span class="math inline">\(\gamma_{10} = 0\)</span>. Though it’s clear from the plot that the trajectory increases, we can address the issue more directly with a difference score. For our difference, we’ll subtract the estimate at <code>age = 14</code> from the one at <code>age = 15</code>. But to that, we’ll have to return to <code>fitted()</code>. So far, we’ve been using the default output which returns summaries of the posterior. To compute a proper difference score, we’ll need to work with all the posterior draws in order to approximate the full distribution. We do that by setting <code>summary = F</code>. And since we’re only interested in the estimates from these two <code>age</code> values, we’ll streamline our <code>nd</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">coa    =</span> <span class="dv">0</span>,</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">peer   =</span> mu_peer,</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">age_14 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.6</span>, </span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>,</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">summary =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   4000 obs. of  2 variables:
 $ X1: num  0.376 0.368 0.246 0.262 0.507 ...
 $ X2: num  0.53 0.721 0.581 0.593 0.669 ...</code></pre>
</div>
</div>
<p>Now our <code>f</code> object has 4,000 rows and 2 columns. Each of the rows corresponds to one of the 4,000 post-warmup posterior draws. The columns correspond to the two rows in our <code>nd</code> data. To get a slope based on this combination of predictor values, we simply subtract the first column from the second.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> f <span class="sc">%&gt;%</span> </span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">difference =</span> X2 <span class="sc">-</span> X1)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> difference)) <span class="sc">+</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Based on 4,000 posterior draws, not a single one</span><span class="sc">\n</span><span class="st">suggests the slope is even close to zero. Rather, the</span><span class="sc">\n</span><span class="st">posterior mass is concentrated around 0.25."</span>,</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(gamma[<span class="dv">0</span>][<span class="dv">1</span>], <span class="st">" (i.e., the difference between the two time points)"</span>))) <span class="sc">+</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Here are the posterior mean and 95% intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(difference),</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(difference, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(difference, <span class="at">probs =</span> <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mean        ll        ul
1 0.2732853 0.1501059 0.3986967</code></pre>
</div>
</div>
<p>On page 125, Singer and Willett further mused:</p>
<blockquote class="blockquote">
<p>When we examined the OLS estimated change trajectories in figure 4.2, we noticed that among children of non-alcoholic parents, those with low values of <em>CPEER</em> tended to have a lower initial status and steeper slopes than those with high values of <em>CPEER</em>. We might therefore ask whether the former group “catches up” to the latter. This is a question about the “vertical” separation between these two groups[’] true change trajectories at some later age, say 16.</p>
</blockquote>
<p>Within their joint hypothesis testing paradigm, they pose this as testing</p>
<p><span class="math display">\[H_0: 0\gamma_{00} + 0\gamma_{01} + 1\gamma_{02} + 0\gamma_{10} + 2\gamma_{12} = 0.\]</span></p>
<p>From our perspective, this is a differences of differences analysis. That is, first we’ll compute the model implied <code>alcuse</code> estimates for the four combinations of the two levels of <code>age</code> and <code>peer</code>, holding <code>coa</code> constant at 0. Second, we’ll compute the differences between the two <code>peer</code> levels at each <code>age</code>. Third and finally, we’ll compute a difference of those differences.</p>
<p>For our first step, recall it was <code>fit4.7</code> that used the <code>cpeer</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first step</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">crossing</span>(<span class="at">age_14 =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">cpeer  =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.363</span>, <span class="fl">0.363</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">coa =</span> <span class="dv">0</span>)</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  age_14  cpeer   coa
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1      0 -0.363     0
2      0  0.363     0
3      2 -0.363     0
4      2  0.363     0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.7</span>, </span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> nd,</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">re_formula =</span> <span class="cn">NA</span>,</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">summary =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          X1        X2        X3        X4
1 0.22345772 0.7363258 0.9818732 1.2458892
2 0.09779833 0.5190283 0.6832786 1.0337496
3 0.35129959 0.7531899 0.8885316 1.2076465
4 0.30469554 0.7947526 0.7131174 1.2165299
5 0.18459360 0.7056289 0.7453610 1.1968860
6 0.11122673 0.6171796 0.6591346 0.8678888</code></pre>
</div>
</div>
<p>For our initial difference scores, we’ll subtract the estimates for the lower level of <code>cpeer</code> from the higher ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># step 2</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> f <span class="sc">%&gt;%</span> </span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="st">`</span><span class="at">difference at 14</span><span class="st">`</span> <span class="ot">=</span> X2 <span class="sc">-</span> X1,</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">difference at 16</span><span class="st">`</span> <span class="ot">=</span> X4 <span class="sc">-</span> X3)</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  difference at 14 difference at 16
1        0.5128680        0.2640160
2        0.4212300        0.3504709
3        0.4018903        0.3191149
4        0.4900571        0.5034125
5        0.5210353        0.4515251
6        0.5059529        0.2087543</code></pre>
</div>
</div>
<p>For our final difference score, we’ll subtract the first difference score from the second.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># step 3</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> f <span class="sc">%&gt;%</span> </span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">difference in differences</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">difference at 16</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">difference at 14</span><span class="st">`</span>)</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  difference at 14 difference at 16 difference in differences
1        0.5128680        0.2640160               -0.24885209
2        0.4212300        0.3504709               -0.07075906
3        0.4018903        0.3191149               -0.08277538
4        0.4900571        0.5034125                0.01335537
5        0.5210353        0.4515251               -0.06951026
6        0.5059529        0.2087543               -0.29719860</code></pre>
</div>
</div>
<p>Here we’ll plot all three.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"different differences"</span>) <span class="sc">+</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-109-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Singer and Willett concluded they could “reject the null hypothesis at any conventional level of significance” (p.&nbsp;126). If we must appeal to the Null, here are the posterior means and 95% intervals for our differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  name                        mean     ll    ul
  &lt;chr&gt;                      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 difference at 14           0.502  0.336 0.657
2 difference at 16           0.283  0.056 0.51 
3 difference in differences -0.219 -0.46  0.029</code></pre>
</div>
</div>
<p>Our results contrast a bit from Singer and Willett’s. Though the bulk of our posterior mass is concentrated around -0.22, zero is a credible value within the difference of differences density. Our best bet is the differences begin to converge over time. However, that rate of that convergence is subtle and somewhat imprecise relative to the effect size. Interpret with caution.</p>
</section>
<section id="evaluating-the-tenability-of-a-models-assumptions" class="level2" data-number="4.8">
<h2 data-number="4.8" class="anchored" data-anchor-id="evaluating-the-tenability-of-a-models-assumptions"><span class="header-section-number">4.8</span> Evaluating the tenability of a model’s assumptions</h2>
<p>“Whenever you fit a statistical model, you invoke assumptions” (p.&nbsp;127). This is the case for multilevel Bayesian models, too.</p>
<section id="checking-functional-form" class="level3" data-number="4.8.1">
<h3 data-number="4.8.1" class="anchored" data-anchor-id="checking-functional-form"><span class="header-section-number">4.8.1</span> Checking functional form</h3>
<p>We’ve already checked the functional form at level-1 with our version of Figure 4.1. When we made our version of Figure 4.1, we relied on <code>ggplot2::stat_smooth()</code> to compute the <code>id</code>-level OLS trajectories. To make our variants of Figure 4.4, we’ll have to back up and compute them externally with <code>lm()</code>. Here we’ll do so in bulk with a nested data frame. The <strong>broom</strong> package will help us extract the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="sc">-</span>id, <span class="sc">-</span>coa, <span class="sc">-</span>peer) <span class="sc">%&gt;%</span> </span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ols =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(<span class="at">data =</span> ., alcuse <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> age_14))) <span class="sc">%&gt;%</span> </span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tidy =</span> <span class="fu">map</span>(ols, tidy)) <span class="sc">%&gt;%</span> </span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(tidy) <span class="sc">%&gt;%</span> </span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is unnecessary, but will help with plotting</span></span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> <span class="fu">factor</span>(term, </span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"(Intercept)"</span>, <span class="st">"age_14"</span>),</span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"pi[0]"</span>, <span class="st">"pi[1]"</span>)))</span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
     id   coa  peer data             ols    term  estimate std.error statistic p.value
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;           &lt;list&gt; &lt;fct&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
1     1     1 1.26  &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[0]    1.78     0.0999    17.8    0.0357
2     1     1 1.26  &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[1]    0.134    0.0774     1.73   0.333 
3     2     1 0.894 &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[0]   -0.167    0.373     -0.447  0.732 
4     2     1 0.894 &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[1]    0.5      0.289      1.73   0.333 
5     3     1 0.894 &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[0]    0.947    0.118      8.03   0.0789
6     3     1 0.894 &lt;tibble [3 × 6]&gt; &lt;lm&gt;   pi[1]    1.16     0.0914    12.7    0.0501</code></pre>
</div>
</div>
<p>Now plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>o <span class="sc">%&gt;%</span> </span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(coa<span class="sc">:</span>peer, term<span class="sc">:</span>estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(coa<span class="sc">:</span>peer) <span class="sc">%&gt;%</span> </span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)) <span class="sc">+</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(term <span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">labeller =</span> label_parsed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-112-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>With a little more wrangling, we can extract the Pearson’s correlation coefficients for each panel.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>o <span class="sc">%&gt;%</span> </span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(coa<span class="sc">:</span>peer, term<span class="sc">:</span>estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(coa<span class="sc">:</span>peer) <span class="sc">%&gt;%</span> </span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(term, name) <span class="sc">%&gt;%</span> </span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r =</span> <span class="fu">map_dbl</span>(data, <span class="sc">~</span><span class="fu">cor</span>(.)[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   term, name [4]
  term  name  data                  r
  &lt;fct&gt; &lt;chr&gt; &lt;list&gt;            &lt;dbl&gt;
1 pi[0] coa   &lt;tibble [82 × 2]&gt;  0.39
2 pi[0] peer  &lt;tibble [82 × 2]&gt;  0.58
3 pi[1] coa   &lt;tibble [82 × 2]&gt; -0.04
4 pi[1] peer  &lt;tibble [82 × 2]&gt; -0.19</code></pre>
</div>
</div>
</section>
<section id="checking-normality" class="level3" data-number="4.8.2">
<h3 data-number="4.8.2" class="anchored" data-anchor-id="checking-normality"><span class="header-section-number">4.8.2</span> Checking normality</h3>
<p>The basic multilevel model of change yields three variance parameters, <span class="math inline">\(\epsilon_{ij}\)</span>, <span class="math inline">\(\zeta_{0i}\)</span>, and <span class="math inline">\(\zeta_{1i}\)</span>. Each measurement occasion in the model receives a model-implied estimate for each. Singer and Willett referred to those estimates as <span class="math inline">\(\hat{\epsilon}_{ij}\)</span>, <span class="math inline">\(\hat{\zeta}_{0i}\)</span>, and <span class="math inline">\(\hat{\zeta}_{1i}\)</span>. As with frequentist software, our Bayesian software <strong>brms</strong> will return these estimates.</p>
<p>To extract our Bayesian draws for the <span class="math inline">\(\hat{\epsilon}_{ij}\)</span>’s, we use the <code>residuals()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">residuals</span>(fit4<span class="fl">.6</span>)</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:246, 1:4] 0.3021 0.2756 -0.0456 -0.3948 -0.5975 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : chr [1:4] "Estimate" "Est.Error" "Q2.5" "Q97.5"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Estimate Est.Error      Q2.5     Q97.5
[1,]  0.30209342 0.6795717 -1.024312 1.6401410
[2,]  0.27558757 0.6884036 -1.057861 1.6419175
[3,] -0.04560829 0.7497454 -1.493929 1.4706529
[4,] -0.39483895 0.6959227 -1.755010 0.9993772
[5,] -0.59745626 0.6904301 -1.922366 0.7543355
[6,]  0.19927275 0.7512627 -1.303172 1.6979116</code></pre>
</div>
</div>
<p>For our <code>fit5</code>, the <code>residuals()</code> function returned a <span class="math inline">\(246 \times 4\)</span> numeric array. Each row corresponded to one of the rows of the original data set. The four vectors are the familiar summaries <code>Estimate</code>, <code>Est.Error</code>, <code>Q2.5</code>, and <code>Q97.5</code>. If we’d like to work with these in a <strong>ggplot2</strong>-made plot, we’ll have to convert our <code>e</code> object to a data frame.</p>
<p>After we make the conversion, we then make the top left panel of Figure 4.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> e <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>e <span class="sc">%&gt;%</span> </span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Normal score"</span>,</span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(epsilon)[<span class="fu">italic</span>(ij)])) <span class="sc">+</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>For the right plot on the top, we need to add an <code>id</code> index. That’s as easy as appending the one from the original data. If you followed closely with the text, you may have also noticed this panel is of the standardized residuals. That just means we’ll have to hand-standardize ours before plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>e <span class="sc">%&gt;%</span> </span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">select</span>(id)) <span class="sc">%&gt;%</span> </span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z =</span> (Estimate <span class="sc">-</span> <span class="fu">mean</span>(Estimate)) <span class="sc">/</span> <span class="fu">sd</span>(Estimate)) <span class="sc">%&gt;%</span> </span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> z)) <span class="sc">+</span></span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">italic</span>(std)<span class="sc">~</span><span class="fu">hat</span>(epsilon)[<span class="fu">italic</span>(ij)]), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-116-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>We’ll need to use the <code>ranef()</code> function to return the estimates for the <span class="math inline">\(\zeta\)</span>’s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fit4<span class="fl">.6</span>)</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ id: num [1:82, 1:4, 1:2] 0.297 -0.481 0.328 -0.348 -0.557 ...
  ..- attr(*, "dimnames")=List of 3
  .. ..$ : chr [1:82] "1" "2" "3" "4" ...
  .. ..$ : chr [1:4] "Estimate" "Est.Error" "Q2.5" "Q97.5"
  .. ..$ : chr [1:2] "Intercept" "age_14"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>z[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, , <span class="st">"Intercept"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Estimate Est.Error       Q2.5      Q97.5
1  0.2968669 0.3245855 -0.3265067 0.96412445
2 -0.4813291 0.3421962 -1.2102704 0.13077958
3  0.3281245 0.3394782 -0.3744580 0.97867224
4 -0.3476118 0.3655476 -1.1069642 0.30492671
5 -0.5573537 0.3355308 -1.2333489 0.06851604
6  0.8233490 0.3731296  0.1552689 1.61484139</code></pre>
</div>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>z[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, , <span class="st">"age_14"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate Est.Error        Q2.5     Q97.5
1  0.07333257 0.2510269 -0.43441739 0.5662414
2 -0.08818017 0.2525496 -0.56208490 0.4384224
3  0.44834735 0.2579810 -0.03282577 0.9795671
4  0.14511723 0.2718540 -0.33298032 0.7234516
5 -0.31561059 0.2491656 -0.81192164 0.1687735
6  0.25432863 0.2669678 -0.28539765 0.7742281</code></pre>
</div>
</div>
<p>For our <code>fit5</code>, the <code>ranef()</code> function returned a list of 1, indexed by <code>id</code>. Therein lay a 3-dimensional array. The first two dimensions are the same as what we got from <code>residuals()</code>, above. The third dimension had two levels: <code>Intercept</code> and <code>age_14</code>. In other words, the third dimension is the one that differentiated between <span class="math inline">\(\hat{\zeta}_{0i}\)</span> and <span class="math inline">\(\hat{\zeta}_{1i}\)</span>. to make this thing a little more useful, let’s convert it to a long-formatted data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rbind</span>(z[[<span class="dv">1</span>]][ , , <span class="st">"Intercept"</span>],</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>           z[[<span class="dv">1</span>]][ , , <span class="st">"age_14"</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranef =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"hat(zeta)[0][italic(i)]"</span>, <span class="st">"hat(zeta)[1][italic(i)]"</span>), <span class="at">each =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 164
Columns: 5
$ Estimate  &lt;dbl&gt; 0.29686688, -0.48132911, 0.32812451, -0.34761177, -0.55735369, 0.82334901, 0.20920524, -0.28069831, 0.17368335…
$ Est.Error &lt;dbl&gt; 0.3245855, 0.3421962, 0.3394782, 0.3655476, 0.3355308, 0.3731296, 0.3241401, 0.3272219, 0.3604507, 0.3289889, …
$ Q2.5      &lt;dbl&gt; -0.32650672, -1.21027045, -0.37445803, -1.10696425, -1.23334893, 0.15526886, -0.39075089, -0.92943890, -0.5750…
$ Q97.5     &lt;dbl&gt; 0.96412445, 0.13077958, 0.97867224, 0.30492671, 0.06851604, 1.61484139, 0.87662914, 0.36928980, 0.84902139, 0.…
$ ranef     &lt;chr&gt; "hat(zeta)[0][italic(i)]", "hat(zeta)[0][italic(i)]", "hat(zeta)[0][italic(i)]", "hat(zeta)[0][italic(i)]", "h…</code></pre>
</div>
</div>
<p>Now we’re ready to plot the remaining panels on the left of Figure 4.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Normal score"</span>,</span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ranef, <span class="at">labeller =</span> label_parsed, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-119-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Here are the ones on the right.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id),</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id)</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ranef =</span> <span class="fu">str_c</span>(<span class="st">"italic(std)~"</span>, ranef)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note we have to group them before standardizing</span></span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ranef) <span class="sc">%&gt;%</span> </span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z =</span> (Estimate <span class="sc">-</span> <span class="fu">mean</span>(Estimate)) <span class="sc">/</span> <span class="fu">sd</span>(Estimate)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> z)) <span class="sc">+</span></span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ranef, <span class="at">labeller =</span> label_parsed, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-120-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>If you were paying close attention, you may have noticed that for all three of our <code>id</code>-level deviation estimates, they were summarized not only by a posterior mean but by standard deviations and 95% intervals, too. To give a sense of what that means, here are those last two plots, again, but this time including vertical bars defined by the 95% intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id),</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id)</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> Estimate, <span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>)) <span class="sc">+</span></span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="at">shape =</span> <span class="dv">20</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> ranef, <span class="at">labeller =</span> label_parsed, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-121-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>When you go Bayesian, even your residuals get full posterior distributions.</p>
</section>
<section id="checking-homoscedasticity" class="level3" data-number="4.8.3">
<h3 data-number="4.8.3" class="anchored" data-anchor-id="checking-homoscedasticity"><span class="header-section-number">4.8.3</span> Checking homoscedasticity</h3>
<p>Here we examine the homoscedasticity assumption by plotting the residual estimates against our predictors. We’ll start with the upper left panel of Figure 4.6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>e <span class="sc">%&gt;%</span> </span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(alcohol1_pp) <span class="sc">%&gt;%</span> </span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">hat</span>(epsilon)[<span class="fu">italic</span>(ij)])) <span class="sc">+</span></span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">13</span>, <span class="dv">17</span>),</span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-122-1.png" class="img-fluid figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>Here’s a quick way to get the remaining four panels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id, coa, peer),</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>      alcohol1_pp <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(id, coa, peer)</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Estimate, ranef, coa, peer) <span class="sc">%&gt;%</span> </span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(Estimate, ranef)) <span class="sc">%&gt;%</span> </span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"covariate value"</span>,</span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(ranef <span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-based-empirical-bayes-estimates-of-the-individual-growth-parameters" class="level2" data-number="4.9">
<h2 data-number="4.9" class="anchored" data-anchor-id="model-based-empirical-bayes-estimates-of-the-individual-growth-parameters"><span class="header-section-number">4.9</span> Model-based (Empirical Bayes) estimates of the individual growth parameters</h2>
<p>In this section, the authors discussed two methods for constructing <code>id</code>-level trajectories: a) use a weighted average of the OLS and multilevel estimates and b) rely solely on the multilevel model by making use of the three sources of residual variation. Our method will be the latter.</p>
<p>Here are the data for <code>id == 23</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id<span class="sc">:</span>coa, cpeer, alcuse) <span class="sc">%&gt;%</span> </span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">23</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
     id   age   coa cpeer alcuse
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1    23    14     1 -1.02   1   
2    23    15     1 -1.02   1   
3    23    16     1 -1.02   1.73</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make our pis</span></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">pi[0][",23"]</span><span class="st">`</span> <span class="ot">=</span> b_Intercept <span class="sc">+</span> b_coa <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> b_cpeer <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.018</span>,</span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">pi[1][",23"]</span><span class="st">`</span> <span class="ot">=</span> b_age_14 <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:cpeer</span><span class="st">`</span> <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.018</span>)</span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(draws_23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  b_Intercept b_age_14 b_coa b_cpeer `b_age_14:cpeer` `pi[0][",23"]` `pi[1][",23"]`
        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;
1       0.480    0.317 0.480   0.706         -0.171            0.240          0.491
2       0.308    0.275 0.645   0.580         -0.0487           0.363          0.325
3       0.552    0.248 0.475   0.554         -0.0570           0.463          0.306
4       0.550    0.208 0.390   0.675          0.00920          0.253          0.198
5       0.445    0.263 0.410   0.718         -0.0479           0.124          0.312
6       0.364    0.200 0.563   0.697         -0.205            0.218          0.408</code></pre>
</div>
</div>
<p>It doesn’t help us much now, but the reason we’ve formatted the names for our two <span class="math inline">\(\pi\)</span> columns so oddly is because those names will work much nicer in the figure we’ll make, below. Just wait and see.</p>
<p>Anyways, more than a couple point estimates, we returned the draws from the full posterior distribution. We might summarize them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="sc">%&gt;%</span> </span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"pi"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  name              mean     ll    ul
  &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 "pi[0][\",23\"]" 0.262 -0.071 0.604
2 "pi[1][\",23\"]" 0.426  0.216 0.63 </code></pre>
</div>
</div>
<p>Or we could plot them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="sc">%&gt;%</span> </span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"pi"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"participant-specific parameter estimates"</span>) <span class="sc">+</span></span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Yet this approach neglects the <span class="math inline">\(\zeta\)</span>’s. We’ve been extracting the <span class="math inline">\(\zeta\)</span>’s with <code>ranef()</code>. We also get them when we use <code>as_draws_df()</code>. Here we’ll extract both the <span class="math inline">\(\gamma\)</span>’s as well as the <span class="math inline">\(\zeta\)</span>’s for <code>id == 23</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4<span class="fl">.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>), <span class="fu">contains</span>(<span class="st">"23"</span>))</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws_23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 7
$ b_Intercept          &lt;dbl&gt; 0.4798917, 0.3084133, 0.5522447, 0.5497241, 0.4451113, 0.3642032, 0.2128283, 0.3048192, 0.4732113, …
$ b_age_14             &lt;dbl&gt; 0.3169947, 0.2750504, 0.2479222, 0.2075498, 0.2630061, 0.1996543, 0.3126289, 0.2732347, 0.3046803, …
$ b_coa                &lt;dbl&gt; 0.4797408, 0.6453055, 0.4747504, 0.3904525, 0.4099225, 0.5630397, 0.5889189, 0.5730423, 0.5522002, …
$ b_cpeer              &lt;dbl&gt; 0.7064298, 0.5802066, 0.5535679, 0.6750098, 0.7176795, 0.6969048, 0.8433452, 0.7544907, 0.5425816, …
$ `b_age_14:cpeer`     &lt;dbl&gt; -0.171385734, -0.048732134, -0.057007839, 0.009197917, -0.047872082, -0.204682233, -0.156986925, -0…
$ `r_id[23,Intercept]` &lt;dbl&gt; 0.12410832, 0.26418171, 0.21847831, 0.41720673, 0.60980181, 0.39750613, 0.46508962, 0.18603794, -0.…
$ `r_id[23,age_14]`    &lt;dbl&gt; 0.410808538, 0.027602206, 0.298144537, 0.002121383, 0.036973660, 0.023954961, 0.262958592, 0.409140…</code></pre>
</div>
</div>
<p>With the <code>r_id</code> prefix, <strong>brms</strong> tells you these are residual estimates for the levels in the <code>id</code> grouping variable. Within the brackets, we learn these particular columns are for <code>id == 23</code>, the first with respect to the <code>Intercept</code> and second with respect to the <code>age_14</code> parameter. Let’s put them to use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="ot">&lt;-</span> draws_23 <span class="sc">%&gt;%</span> </span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">pi[0][",23"]</span><span class="st">`</span> <span class="ot">=</span> b_Intercept <span class="sc">+</span> b_coa <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> b_cpeer <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.018</span> <span class="sc">+</span> <span class="st">`</span><span class="at">r_id[23,Intercept]</span><span class="st">`</span>,</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">pi[1][",23"]</span><span class="st">`</span> <span class="ot">=</span> b_age_14 <span class="sc">+</span> <span class="st">`</span><span class="at">b_age_14:cpeer</span><span class="st">`</span> <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.018</span> <span class="sc">+</span> <span class="st">`</span><span class="at">r_id[23,age_14]</span><span class="st">`</span>)</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws_23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,000
Columns: 9
$ b_Intercept          &lt;dbl&gt; 0.4798917, 0.3084133, 0.5522447, 0.5497241, 0.4451113, 0.3642032, 0.2128283, 0.3048192, 0.4732113, …
$ b_age_14             &lt;dbl&gt; 0.3169947, 0.2750504, 0.2479222, 0.2075498, 0.2630061, 0.1996543, 0.3126289, 0.2732347, 0.3046803, …
$ b_coa                &lt;dbl&gt; 0.4797408, 0.6453055, 0.4747504, 0.3904525, 0.4099225, 0.5630397, 0.5889189, 0.5730423, 0.5522002, …
$ b_cpeer              &lt;dbl&gt; 0.7064298, 0.5802066, 0.5535679, 0.6750098, 0.7176795, 0.6969048, 0.8433452, 0.7544907, 0.5425816, …
$ `b_age_14:cpeer`     &lt;dbl&gt; -0.171385734, -0.048732134, -0.057007839, 0.009197917, -0.047872082, -0.204682233, -0.156986925, -0…
$ `r_id[23,Intercept]` &lt;dbl&gt; 0.12410832, 0.26418171, 0.21847831, 0.41720673, 0.60980181, 0.39750613, 0.46508962, 0.18603794, -0.…
$ `r_id[23,age_14]`    &lt;dbl&gt; 0.410808538, 0.027602206, 0.298144537, 0.002121383, 0.036973660, 0.023954961, 0.262958592, 0.409140…
$ `pi[0][",23"]`       &lt;dbl&gt; 0.36459536, 0.62725025, 0.68194134, 0.67022340, 0.73423783, 0.61529988, 0.40831143, 0.29582792, 0.4…
$ `pi[1][",23"]`       &lt;dbl&gt; 0.9022739, 0.3522619, 0.6041007, 0.2003077, 0.3487136, 0.4319757, 0.7354002, 0.8093491, 0.4672463, …</code></pre>
</div>
</div>
<p>Here are our updated summaries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="sc">%&gt;%</span> </span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"pi"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value),</span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ll   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul   =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  name              mean     ll    ul
  &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 "pi[0][\",23\"]" 0.566 -0.022 1.22 
2 "pi[1][\",23\"]" 0.512  0.016 0.961</code></pre>
</div>
</div>
<p>And here are the updated density plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>draws_23 <span class="sc">%&gt;%</span> </span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>(<span class="st">"pi"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">0</span>, <span class="at">fill =</span> <span class="st">"grey25"</span>) <span class="sc">+</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"participant-specific parameter estimates"</span>) <span class="sc">+</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">labeller =</span> label_parsed, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-131-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We’ve been focusing on the <span class="math inline">\(\pi\)</span> parameters. Notice that when we turn our attention to Figure 4.7, we’re now shifting focus slightly to the consequences of those parameters. We’re not attending to trajectories. It’s important to pick up on this distinction because it has consequences for our programming workflow. If you wanted to keep a parameter-centric workflow, we could continue to expand on our <code>as_draws_df()</code> by applying the full composite formula to explicitly add in predictions for various levels of <code>age_14</code>. And we could do that separately or in bulk for the eight participants highlighted in the figure.</p>
<p>However pedagogically useful that might be, it’d be very tedious. If we instead take a trajectory-centric perspective, it’ll be more natural and efficient to work with a <code>fitted()</code>-based workflow. Let’s define our <code>nd</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id<span class="sc">:</span>coa, age_14<span class="sc">:</span>alcuse, cpeer) <span class="sc">%&gt;%</span> </span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">14</span>, <span class="dv">23</span>, <span class="dv">32</span>, <span class="dv">41</span>, <span class="dv">56</span>, <span class="dv">65</span>, <span class="dv">82</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these next two lines will make plotting easier</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_label =</span> <span class="fu">ifelse</span>(id <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="fu">str_c</span>(<span class="st">"0"</span>, id), id)) <span class="sc">%&gt;%</span> </span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_label =</span> <span class="fu">str_c</span>(<span class="st">"id = "</span>, id_label))</span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(nd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 24
Columns: 7
$ id       &lt;dbl&gt; 4, 4, 4, 14, 14, 14, 23, 23, 23, 32, 32, 32, 41, 41, 41, 56, 56, 56, 65, 65, 65, 82, 82, 82
$ age      &lt;dbl&gt; 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16
$ coa      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
$ age_14   &lt;dbl&gt; 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2
$ alcuse   &lt;dbl&gt; 0.000000, 2.000000, 1.732051, 2.828427, 3.605551, 2.828427, 1.000000, 1.000000, 1.732051, 1.732051, 1.414214, 1…
$ cpeer    &lt;dbl&gt; 0.7708544, 0.7708544, 0.7708544, 0.9820000, 0.9820000, 0.9820000, -1.0180000, -1.0180000, -1.0180000, -1.018000…
$ id_label &lt;chr&gt; "id = 04", "id = 04", "id = 04", "id = 14", "id = 14", "id = 14", "id = 23", "id = 23", "id = 23", "id = 32", "…</code></pre>
</div>
</div>
<p>We’ve isolated the relevant predictor variables for our eight focal participants. Next we’ll pump them through <code>fitted()</code> and wrangle as usual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.7</span>, <span class="at">newdata =</span> nd) <span class="sc">%&gt;%</span> </span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd)</span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 24
Columns: 11
$ Estimate  &lt;dbl&gt; 1.1478486, 1.4523890, 1.7569293, 2.3695322, 2.7069877, 3.0444432, 0.5655661, 1.0771762, 1.5887864, 0.7802236, …
$ Est.Error &lt;dbl&gt; 0.3566131, 0.2964612, 0.4476232, 0.3549815, 0.3047143, 0.4412486, 0.3223901, 0.2934049, 0.4309445, 0.3784683, …
$ Q2.5      &lt;dbl&gt; 0.39914377, 0.87386730, 0.89772990, 1.71848914, 2.08821839, 2.20584449, -0.02161133, 0.49193914, 0.75113194, 0…
$ Q97.5     &lt;dbl&gt; 1.792636, 2.046117, 2.644994, 3.094280, 3.304657, 3.908907, 1.223698, 1.665103, 2.432485, 1.564490, 1.693071, …
$ id        &lt;dbl&gt; 4, 4, 4, 14, 14, 14, 23, 23, 23, 32, 32, 32, 41, 41, 41, 56, 56, 56, 65, 65, 65, 82, 82, 82
$ age       &lt;dbl&gt; 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16
$ coa       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
$ age_14    &lt;dbl&gt; 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2
$ alcuse    &lt;dbl&gt; 0.000000, 2.000000, 1.732051, 2.828427, 3.605551, 2.828427, 1.000000, 1.000000, 1.732051, 1.732051, 1.414214, …
$ cpeer     &lt;dbl&gt; 0.7708544, 0.7708544, 0.7708544, 0.9820000, 0.9820000, 0.9820000, -1.0180000, -1.0180000, -1.0180000, -1.01800…
$ id_label  &lt;chr&gt; "id = 04", "id = 04", "id = 04", "id = 14", "id = 14", "id = 14", "id = 23", "id = 23", "id = 23", "id = 32", …</code></pre>
</div>
</div>
<p>Notice how this time we omitted the <code>re_formula = NA</code> argument. By default, <code>re_formula = NULL</code>, the consequence of which is the output is based on all the parameters in the multilevel model, not just the <span class="math inline">\(\gamma\)</span>’s. Here are what they look like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">13</span>, <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id_label, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-134-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Now we’ve warmed up, let’s add in the data and the other lines so make the full version of Figure 4.7. Before we do so, we’ll revisit <code>fitted()</code>. Notice the return of the <code>re_formula = NA</code> argument. The trajectories in our <code>f_gamma_only</code> data frame will only be sensitive to the <span class="math inline">\(\gamma\)</span>s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>f_gamma_only <span class="ot">&lt;-</span> <span class="fu">fitted</span>(</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>  fit4<span class="fl">.7</span>,</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> nd,</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd)</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(f_gamma_only)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 24
Columns: 11
$ Estimate  &lt;dbl&gt; 1.4998088, 1.6557380, 1.8116671, 1.6459337, 1.7700162, 1.8940987, 0.2618197, 0.6875579, 1.1132961, 0.2618197, …
$ Est.Error &lt;dbl&gt; 0.1389740, 0.1371476, 0.1898794, 0.1533788, 0.1514247, 0.2139575, 0.1693999, 0.1649239, 0.2191853, 0.1693999, …
$ Q2.5      &lt;dbl&gt; 1.21982890, 1.38552999, 1.43774048, 1.33736623, 1.47845805, 1.47884062, -0.07120761, 0.37517331, 0.69487737, -…
$ Q97.5     &lt;dbl&gt; 1.7759306, 1.9233227, 2.1935770, 1.9519514, 2.0701747, 2.3253841, 0.6037027, 1.0154950, 1.5497587, 0.6037027, …
$ id        &lt;dbl&gt; 4, 4, 4, 14, 14, 14, 23, 23, 23, 32, 32, 32, 41, 41, 41, 56, 56, 56, 65, 65, 65, 82, 82, 82
$ age       &lt;dbl&gt; 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16, 14, 15, 16
$ coa       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
$ age_14    &lt;dbl&gt; 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 1, 2
$ alcuse    &lt;dbl&gt; 0.000000, 2.000000, 1.732051, 2.828427, 3.605551, 2.828427, 1.000000, 1.000000, 1.732051, 1.732051, 1.414214, …
$ cpeer     &lt;dbl&gt; 0.7708544, 0.7708544, 0.7708544, 0.9820000, 0.9820000, 0.9820000, -1.0180000, -1.0180000, -1.0180000, -1.01800…
$ id_label  &lt;chr&gt; "id = 04", "id = 04", "id = 04", "id = 14", "id = 14", "id = 14", "id = 23", "id = 23", "id = 23", "id = 32", …</code></pre>
</div>
</div>
<p>Let’s plot!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age)) <span class="sc">+</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `id`-specific lines</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Estimate),</span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gamma-centric lines</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> f_gamma_only,</span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> Estimate),</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OLS lines</span></span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">data =</span> nd,</span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> alcuse),</span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> F,</span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data points</span></span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> nd,</span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> alcuse)) <span class="sc">+</span></span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">13</span>, <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id_label, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-136-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Though our purpose was largely to reproduce Figure 4.7, we might push ourselves a little further. Our Bayesian estimates came with measures of uncertainty, the posterior standard deviations and the 95% intervals. Whenever possible, it’s good form to include some expression of our uncertainty in our plots. Here let’s focus on the <code>id</code>-specific trajectories.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `id`-specific 95% intervals</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey75"</span>) <span class="sc">+</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `id`-specific lines</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data points</span></span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> nd,</span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> alcuse)) <span class="sc">+</span></span>
<span id="cb251-11"><a href="#cb251-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb251-12"><a href="#cb251-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">13</span>, <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb251-13"><a href="#cb251-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb251-14"><a href="#cb251-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb251-15"><a href="#cb251-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id_label, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-137-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>This also clarifies an important visualization point. If you only care about plotting straight lines, you only need two points. However, if you want to express shapes with curves, such as the typically-bowtie-shaped 95% intervals, you need estimates over a larger number of predictor values. Back to <code>fitted()</code>!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we need an expanded version of the `nd`</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>nd_expanded <span class="ot">&lt;-</span> alcohol1_pp <span class="sc">%&gt;%</span> </span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, coa, cpeer) <span class="sc">%&gt;%</span> </span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">14</span>, <span class="dv">23</span>, <span class="dv">32</span>, <span class="dv">41</span>, <span class="dv">56</span>, <span class="dv">65</span>, <span class="dv">82</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this part is important!</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand</span>(<span class="fu">nesting</span>(id, coa, cpeer),</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">age_14 =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">30</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_label =</span> <span class="fu">ifelse</span>(id <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="fu">str_c</span>(<span class="st">"0"</span>, id), id)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_label =</span> <span class="fu">str_c</span>(<span class="st">"id = "</span>, id_label),</span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">age      =</span> age_14 <span class="sc">+</span> <span class="dv">14</span>)</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a><span class="co"># pump our `nd_expanded` into `fitted()`</span></span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit4<span class="fl">.7</span>, <span class="at">newdata =</span> nd_expanded) <span class="sc">%&gt;%</span> </span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(nd_expanded)</span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 240
Columns: 10
$ Estimate  &lt;dbl&gt; 1.147849, 1.168851, 1.189854, 1.210857, 1.231860, 1.252863, 1.273865, 1.294868, 1.315871, 1.336874, 1.357876, …
$ Est.Error &lt;dbl&gt; 0.3566131, 0.3458200, 0.3357556, 0.3264874, 0.3180849, 0.3106184, 0.3041569, 0.2987655, 0.2945031, 0.2914191, …
$ Q2.5      &lt;dbl&gt; 0.3991438, 0.4419543, 0.4889595, 0.5358052, 0.5876218, 0.6237729, 0.6558085, 0.6990207, 0.7377322, 0.7633090, …
$ Q97.5     &lt;dbl&gt; 1.792636, 1.797907, 1.801834, 1.809506, 1.824976, 1.836936, 1.854064, 1.872640, 1.893665, 1.915683, 1.936258, …
$ id        &lt;dbl&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 14, 14, 14, 14, 14, …
$ coa       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ cpeer     &lt;dbl&gt; 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, 0.7708544, …
$ age_14    &lt;dbl&gt; 0.00000000, 0.06896552, 0.13793103, 0.20689655, 0.27586207, 0.34482759, 0.41379310, 0.48275862, 0.55172414, 0.…
$ id_label  &lt;chr&gt; "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", "id = 04", …
$ age       &lt;dbl&gt; 14.00000, 14.06897, 14.13793, 14.20690, 14.27586, 14.34483, 14.41379, 14.48276, 14.55172, 14.62069, 14.68966, …</code></pre>
</div>
</div>
<p>Notice how we now have many more rows. Let’s plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>f <span class="sc">%&gt;%</span> </span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `id`-specific 95% intervals</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>),</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"grey75"</span>) <span class="sc">+</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `id`-specific lines</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data points</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> nd,</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> alcuse)) <span class="sc">+</span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">"alcuse"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">13</span>, <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id_label, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_files/figure-html/unnamed-chunk-139-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Singer and Willett pointed out that one of the ways in which the multilevel model is more parsimonious than a series of <code>id</code>-specific single-level models is that all <code>id</code> levels share the same <span class="math inline">\(\sigma_\epsilon\)</span> parameter. For now, we should just point out that it’s possible to relax this assumption with modern Bayesian software, such as <strong>brms</strong>. For ideas on how, check out <a href="https://donaldrwilliams.github.io/">Donald Williams</a>’ work <span class="citation" data-cites="williamsSurfaceUnearthingWithinperson2019">(e.g., <a href="references.html#ref-williamsSurfaceUnearthingWithinperson2019" role="doc-biblioref">Williams et al., 2019</a>)</span>.</p>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] broom_1.0.10    loo_2.9.0.9000  ggdist_3.3.3    brms_2.23.0     Rcpp_1.1.0      lubridate_1.9.4 forcats_1.0.1  
 [8] stringr_1.6.0   dplyr_1.1.4     purrr_1.2.1     readr_2.1.5     tidyr_1.3.2     tibble_3.3.1    ggplot2_4.0.1  
[15] tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        farver_2.1.2            S7_0.2.1                fastmap_1.2.0           TH.data_1.1-4          
 [6] tensorA_0.36.2.1        digest_0.6.39           timechange_0.3.0        estimability_1.5.1      lifecycle_1.0.5        
[11] StanHeaders_2.36.0.9000 survival_3.8-3          magrittr_2.0.4          posterior_1.6.1.9000    compiler_4.5.1         
[16] rlang_1.1.7             tools_4.5.1             utf8_1.2.6              knitr_1.51              labeling_0.4.3         
[21] bridgesampling_1.2-1    htmlwidgets_1.6.4       curl_7.0.0              bit_4.6.0               pkgbuild_1.4.8         
[26] plyr_1.8.9              RColorBrewer_1.1-3      abind_1.4-8             multcomp_1.4-29         withr_3.0.2            
[31] grid_4.5.1              stats4_4.5.1            xtable_1.8-4            inline_0.3.21           emmeans_1.11.2-8       
[36] scales_1.4.0            MASS_7.3-65             cli_3.6.5               mvtnorm_1.3-3           rmarkdown_2.30         
[41] crayon_1.5.3            generics_0.1.4          RcppParallel_5.1.11-1   rstudioapi_0.17.1       reshape2_1.4.5         
[46] tzdb_0.5.0              rstan_2.36.0.9000       splines_4.5.1           bayesplot_1.15.0.9000   parallel_4.5.1         
[51] matrixStats_1.5.0       vctrs_0.7.0             V8_8.0.1                Matrix_1.7-3            sandwich_3.1-1         
[56] jsonlite_2.0.0          hms_1.1.4               bit64_4.6.0-1           glue_1.8.0              codetools_0.2-20       
[61] distributional_0.5.0    stringi_1.8.7           gtable_0.3.6            QuickJSR_1.8.1          pillar_1.11.1          
[66] htmltools_0.5.9         Brobdingnag_1.2-9       R6_2.6.1                vroom_1.6.6             evaluate_1.0.5         
[71] lattice_0.22-7          backports_1.5.0         rstantools_2.5.0.9000   coda_0.19-4.1           gridExtra_2.3          
[76] nlme_3.1-168            checkmate_2.3.3         mgcv_1.9-3              xfun_0.55               zoo_1.8-14             
[81] pkgconfig_2.0.3        </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-brms2021RM" class="csl-entry" role="listitem">
Bürkner, P.-C. (2021). <em><span class="nocase">brms</span> reference manual, <span>Version</span> 2.15.0</em>. <a href="https://CRAN.R-project.org/package=brms/brms.pdf">https://CRAN.R-project.org/package=brms/brms.pdf</a>
</div>
<div id="ref-gelman2013bayesian" class="csl-entry" role="listitem">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., &amp; Rubin, D. B. (2013). <em>Bayesian data analysis</em> (Third Edition). CRC press. <a href="https://stat.columbia.edu/~gelman/book/">https://stat.columbia.edu/~gelman/book/</a>
</div>
<div id="ref-jaegerR2StatisticFixed2017" class="csl-entry" role="listitem">
Jaeger, B. C., Edwards, L. J., Das, K., &amp; Sen, P. K. (2017). An <span>R2</span> statistic for fixed effects in the generalized linear mixed model. <em>Journal of Applied Statistics</em>, <em>44</em>(6), 1086–1105. <a href="https://doi.org/10.1080/02664763.2016.1193725">https://doi.org/10.1080/02664763.2016.1193725</a>
</div>
<div id="ref-R-ggdist" class="csl-entry" role="listitem">
Kay, M. (2021). <em><span class="nocase">ggdist</span>: <span>Visualizations</span> of distributions and uncertainty</em> [Manual]. <a href="https://CRAN.R-project.org/package=ggdist">https://CRAN.R-project.org/package=ggdist</a>
</div>
<div id="ref-kreftIntroducingMultilevelModeling1998" class="csl-entry" role="listitem">
Kreft, I. G., &amp; de Leeuw, J. (1998). <em>Introducing multilevel modeling</em>. SAGE Publications, Inc. https://doi.org/<a href="https://dx.doi.org/10.4135/9781849209366">https://dx.doi.org/10.4135/9781849209366</a>
</div>
<div id="ref-kruschkeDoingBayesianData2015" class="csl-entry" role="listitem">
Kruschke, J. K. (2015). <em>Doing <span>Bayesian</span> data analysis: <span>A</span> tutorial with <span>R</span>, <span>JAGS</span>, and <span>Stan</span></em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a>
</div>
<div id="ref-lambertAStudentsGuidetoBayes2018" class="csl-entry" role="listitem">
Lambert, B. (2018). <em>A student’s guide to <span>Bayesian</span> statistics</em>. SAGE Publications, Inc. <a href="https://ben-lambert.com/a-students-guide-to-bayesian-statistics/">https://ben-lambert.com/a-students-guide-to-bayesian-statistics/</a>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2015" class="csl-entry" role="listitem">
McElreath, R. (2015). <em>Statistical rethinking: <span>A Bayesian</span> course with examples in <span>R</span> and <span>Stan</span></em>. CRC press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry" role="listitem">
McElreath, R. (2020). <em>Statistical rethinking: <span>A Bayesian</span> course with examples in <span>R</span> and <span>Stan</span></em> (Second Edition). CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>
</div>
<div id="ref-nosekPreregistrationRevolution2018" class="csl-entry" role="listitem">
Nosek, B. A., Ebersole, C. R., DeHaven, A. C., &amp; Mellor, D. T. (2018). The preregistration revolution. <em>Proceedings of the National Academy of Sciences</em>, <em>115</em>(11), 2600–2606. <a href="https://doi.org/10.1073/pnas.1708274114">https://doi.org/10.1073/pnas.1708274114</a>
</div>
<div id="ref-pearlCausalInferenceStatistics2016" class="csl-entry" role="listitem">
Pearl, J., Glymour, M., &amp; Jewell, N. P. (2016). <em>Causal <span>Inference</span> in <span>Statistics</span> - <span>A Primer</span></em> (1st Edition). Wiley. <a href="https://www.wiley.com/en-us/Causal+Inference+in+Statistics%3A+A+Primer-p-9781119186847">https://www.wiley.com/en-us/Causal+Inference+in+Statistics%3A+A+Primer-p-9781119186847</a>
</div>
<div id="ref-rightsEffectSizeMeasures2018" class="csl-entry" role="listitem">
Rights, Jason D., &amp; Cole, D. A. (2018). Effect size measures for multilevel models in clinical child and adolescent research: <span class="nocase">New R-squared</span> methods and recommendations. <em>Journal of Clinical Child &amp; Adolescent Psychology</em>, <em>47</em>(6), 863–873. <a href="https://doi.org/10.1080/15374416.2018.1528550">https://doi.org/10.1080/15374416.2018.1528550</a>
</div>
<div id="ref-rights2020NewRecommendations" class="csl-entry" role="listitem">
Rights, Jason D., &amp; Sterba, S. K. (2020). New recommendations on the use of <span class="nocase">R-squared</span> differences in multilevel model comparisons. <em>Multivariate Behavioral Research</em>, <em>55</em>(4), 568–599. <a href="https://doi.org/10.1080/00273171.2019.1660605">https://doi.org/10.1080/00273171.2019.1660605</a>
</div>
<div id="ref-singerAppliedLongitudinalData2003" class="csl-entry" role="listitem">
Singer, J. D., &amp; Willett, J. B. (2003). <em>Applied longitudinal data analysis: <span>Modeling</span> change and event occurrence</em>. Oxford University Press, USA. <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968">https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968</a>
</div>
<div id="ref-snijdersModeledVarianceTwolevel1994" class="csl-entry" role="listitem">
Snijders, T. A. B., &amp; Bosker, R. J. (1994). Modeled variance in two-level models. <em>Sociological Methods &amp; Research</em>, <em>22</em>(3), 342–363. <a href="https://doi.org/10.1177/0049124194022003004">https://doi.org/10.1177/0049124194022003004</a>
</div>
<div id="ref-spiegelhalterBayesianMeasuresModel2002" class="csl-entry" role="listitem">
Spiegelhalter, D. J., Best, N. G., Carlin, B. P., &amp; Linde, A. V. D. (2002). Bayesian measures of model complexity and fit. <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em>, <em>64</em>(4), 583–639. <a href="https://doi.org/10.1111/1467-9868.00353">https://doi.org/10.1111/1467-9868.00353</a>
</div>
<div id="ref-steegen2016increasing" class="csl-entry" role="listitem">
Steegen, S., Tuerlinckx, F., Gelman, A., &amp; Vanpaemel, W. (2016). Increasing transparency through a multiverse analysis. <em>Perspectives on Psychological Science</em>, <em>11</em>(5), 702–712. <a href="https://doi.org/10.1177/1745691616658637">https://doi.org/10.1177/1745691616658637</a>
</div>
<div id="ref-R-loo" class="csl-entry" role="listitem">
Vehtari, A., Gabry, J., Magnusson, M., Yao, Y., &amp; Gelman, A. (2022). <em><span class="nocase">loo</span>: <span>Efficient</span> leave-one-out cross-validation and <span>WAIC</span> for bayesian models</em>. <a href="https://CRAN.R-project.org/package=loo/">https://CRAN.R-project.org/package=loo/</a>
</div>
<div id="ref-vehtariPracticalBayesianModel2017" class="csl-entry" role="listitem">
Vehtari, A., Gelman, A., &amp; Gabry, J. (2017). Practical <span>Bayesian</span> model evaluation using leave-one-out cross-validation and <span>WAIC</span>. <em>Statistics and Computing</em>, <em>27</em>(5), 1413–1432. <a href="https://doi.org/10.1007/s11222-016-9696-4">https://doi.org/10.1007/s11222-016-9696-4</a>
</div>
<div id="ref-watanabeAsymptoticEquivalenceBayes2010" class="csl-entry" role="listitem">
Watanabe, S. (2010). Asymptotic equivalence of <span>Bayes</span> cross validation and widely applicable information criterion in singular learning theory. <em>Journal of Machine Learning Research</em>, <em>11</em>(116), 3571–3594. <a href="http://jmlr.org/papers/v11/watanabe10a.html">http://jmlr.org/papers/v11/watanabe10a.html</a>
</div>
<div id="ref-williamsSurfaceUnearthingWithinperson2019" class="csl-entry" role="listitem">
Williams, D. R., Rouder, J., &amp; Rast, P. (2019). <em>Beneath the surface: <span>Unearthing</span> within-<span>Person</span> variability and mean relations with <span>Bayesian</span> mixed models</em>. <a href="https://doi.org/10.31234/osf.io/gwatq">https://doi.org/10.31234/osf.io/gwatq</a>
</div>
<div id="ref-yaoUsingStackingAverage2018" class="csl-entry" role="listitem">
Yao, Y., Vehtari, A., Simpson, D., &amp; Gelman, A. (2018). Using stacking to average <span>Bayesian</span> predictive distributions (with discussion). <em>Bayesian Analysis</em>, <em>13</em>(3), 917–1007. <a href="https://doi.org/10.1214/17-BA1091">https://doi.org/10.1214/17-BA1091</a>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/solomon\.quarto\.pub\/alda\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse";
    script.dataset.repoId = "MDEwOlJlcG9zaXRvcnkxODg5MTU1MTM=";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOC0KfOc4C1eQu";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03.html" class="pagination-link" aria-label="Introducing the Multilevel Model for Change">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introducing the Multilevel Model for Change</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05.html" class="pagination-link" aria-label="Treating Time More Flexibly">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Treating Time More Flexibly</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>