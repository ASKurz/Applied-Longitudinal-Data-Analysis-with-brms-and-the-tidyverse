<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Describing Continuous-Time Event Occurrence Data – *Applied longitudinal data analysis* in brms and the tidyverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./12.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d082c015fa132ca880f975003d7bf2f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="13&nbsp; Describing Continuous-Time Event Occurrence Data – Applied longitudinal data analysis in brms and the tidyverse">
<meta property="og:description" content="">
<meta property="og:image" content="https://solomon.quarto.pub/alda/13_files/figure-html/unnamed-chunk-3-1.png">
<meta property="og:site_name" content="*Applied longitudinal data analysis* in brms and the tidyverse">
<meta property="og:image:height" content="576">
<meta property="og:image:width" content="1152">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Describing Continuous-Time Event Occurrence Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"><em>Applied longitudinal data analysis</em> in brms and the tidyverse</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What and why</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">A Framework for Investigating Change over Time</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploring Longitudinal Data on Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introducing the Multilevel Model for Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Doing Data Analysis with the Multilevel Model for Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Treating Time More Flexibly</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modeling Discontinuous and Nonlinear Change</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Examining the Multilevel Model’s Error Covariance Structure</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modeling Change Using Covariance Structure Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">A Framework for Investigating Event Occurrence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Describing Discrete-Time Event Occurrence Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fitting Basic Discrete-Time Hazard Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Extending the Discrete-Time Hazard Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Describing Continuous-Time Event Occurrence Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-framework-for-characterizing-the-distribution-of-continuous-time-event-data" id="toc-a-framework-for-characterizing-the-distribution-of-continuous-time-event-data" class="nav-link active" data-scroll-target="#a-framework-for-characterizing-the-distribution-of-continuous-time-event-data"><span class="header-section-number">13.1</span> A framework for characterizing the distribution of continuous-time event data</a>
  <ul>
  <li><a href="#salient-features-of-continuous-time-event-occurrence-data" id="toc-salient-features-of-continuous-time-event-occurrence-data" class="nav-link" data-scroll-target="#salient-features-of-continuous-time-event-occurrence-data"><span class="header-section-number">13.1.1</span> Salient features of continuous-time event occurrence data</a></li>
  <li><a href="#the-survivor-function" id="toc-the-survivor-function" class="nav-link" data-scroll-target="#the-survivor-function"><span class="header-section-number">13.1.2</span> The survivor function</a></li>
  <li><a href="#the-hazard-function" id="toc-the-hazard-function" class="nav-link" data-scroll-target="#the-hazard-function"><span class="header-section-number">13.1.3</span> The hazard function</a></li>
  </ul></li>
  <li><a href="#grouped-methods-for-estimating-continuous-time-survivor-and-hazard-functions" id="toc-grouped-methods-for-estimating-continuous-time-survivor-and-hazard-functions" class="nav-link" data-scroll-target="#grouped-methods-for-estimating-continuous-time-survivor-and-hazard-functions"><span class="header-section-number">13.2</span> Grouped methods for estimating continuous-time survivor and hazard functions</a>
  <ul>
  <li><a href="#constructing-a-grouped-life-table" id="toc-constructing-a-grouped-life-table" class="nav-link" data-scroll-target="#constructing-a-grouped-life-table"><span class="header-section-number">13.2.1</span> Constructing a grouped life table</a></li>
  <li><a href="#the-discrete-time-method" id="toc-the-discrete-time-method" class="nav-link" data-scroll-target="#the-discrete-time-method"><span class="header-section-number">13.2.2</span> The discrete-time method</a></li>
  <li><a href="#the-actuarial-method" id="toc-the-actuarial-method" class="nav-link" data-scroll-target="#the-actuarial-method"><span class="header-section-number">13.2.3</span> The actuarial method</a></li>
  </ul></li>
  <li><a href="#the-kaplan-meier-method-of-estimating-the-continuous-time-survivor-function" id="toc-the-kaplan-meier-method-of-estimating-the-continuous-time-survivor-function" class="nav-link" data-scroll-target="#the-kaplan-meier-method-of-estimating-the-continuous-time-survivor-function"><span class="header-section-number">13.3</span> The Kaplan-Meier method of estimating the continuous-time survivor function</a>
  <ul>
  <li><a href="#fitting-a-bayesian-kaplan-meier-model" id="toc-fitting-a-bayesian-kaplan-meier-model" class="nav-link" data-scroll-target="#fitting-a-bayesian-kaplan-meier-model"><span class="header-section-number">13.3.1</span> Fitting a Bayesian Kaplan-Meier model</a></li>
  </ul></li>
  <li><a href="#the-cumulative-hazard-function" id="toc-the-cumulative-hazard-function" class="nav-link" data-scroll-target="#the-cumulative-hazard-function"><span class="header-section-number">13.4</span> The cumulative hazard function</a>
  <ul>
  <li><a href="#understanding-the-meaning-of-cumulative-hazard" id="toc-understanding-the-meaning-of-cumulative-hazard" class="nav-link" data-scroll-target="#understanding-the-meaning-of-cumulative-hazard"><span class="header-section-number">13.4.1</span> Understanding the meaning of cumulative hazard</a></li>
  <li><a href="#estimating-the-cumulative-hazard-function" id="toc-estimating-the-cumulative-hazard-function" class="nav-link" data-scroll-target="#estimating-the-cumulative-hazard-function"><span class="header-section-number">13.4.2</span> Estimating the cumulative hazard function</a></li>
  </ul></li>
  <li><a href="#kernel-smoothed-estimates-of-the-hazard-function" id="toc-kernel-smoothed-estimates-of-the-hazard-function" class="nav-link" data-scroll-target="#kernel-smoothed-estimates-of-the-hazard-function"><span class="header-section-number">13.5</span> Kernel-smoothed estimates of the hazard function</a></li>
  <li><a href="#developing-an-intuition-about-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions" id="toc-developing-an-intuition-about-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions" class="nav-link" data-scroll-target="#developing-an-intuition-about-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions"><span class="header-section-number">13.6</span> Developing an intuition about continuous-time survivor, cumulative hazard, and kernel-smoothed hazard functions</a>
  <ul>
  <li><a href="#bonus-bayesians-can-compare-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions-too" id="toc-bonus-bayesians-can-compare-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions-too" class="nav-link" data-scroll-target="#bonus-bayesians-can-compare-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions-too"><span class="header-section-number">13.6.1</span> Bonus: Bayesians can compare continuous-time survivor, cumulative hazard, and kernel-smoothed hazard functions, too</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Describing Continuous-Time Event Occurrence Data</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>In this chapter, we present strategies for describing continuous-time event data. Although survivor and hazard functions continue to form the cornerstone of our work, the challenge in the time scale from discrete to continuous demands that we revise our fundamental definitions and modify estimation strategies….</p>
<p>In the [second half of the chapter], we offer solutions to the core conundrum embedded in contentious-time event data: our inability to estimate the hazard function well. This is a concern as it leads some researchers to conclude that they should not even <em>try</em> to ascertain the pattern of risk over time. <span class="citation" data-cites="singerAppliedLongitudinalData2003">(<a href="references.html#ref-singerAppliedLongitudinalData2003" role="doc-biblioref">Singer &amp; Willett, 2003</a>, pp, 468–469, <em>emphasis</em> in the original)</span></p>
</blockquote>
<section id="a-framework-for-characterizing-the-distribution-of-continuous-time-event-data" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="a-framework-for-characterizing-the-distribution-of-continuous-time-event-data"><span class="header-section-number">13.1</span> A framework for characterizing the distribution of continuous-time event data</h2>
<blockquote class="blockquote">
<p>Variables measured with greater precision contain more information than those measured with less precision… Finer distinctions, as long as they can be made reliably, lead to more subtle interpretations and more powerful analyses.</p>
<p>Unfortunately, a switch from discrete- to continuous-time survival analysis is not as trivial as you might hope. In discrete time, the definition of the hazard function is intuitive, its values are easily estimated, and simple graphic displays can illuminate its behavior. In continuous time, although the survivor function is easily defined and estimated, the hazard function is not. As explained below, we must revise its definition and develop new methods for its estimation and exploration. (p.&nbsp;469)</p>
</blockquote>
<section id="salient-features-of-continuous-time-event-occurrence-data" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="salient-features-of-continuous-time-event-occurrence-data"><span class="header-section-number">13.1.1</span> Salient features of continuous-time event occurrence data</h3>
<blockquote class="blockquote">
<p>Because continuous time is infinitely divisible, the distribution of event times displays two highly salient properties:</p>
<ul>
<li><em>The probability of observing</em> any particular event time <em>is infinitesimally small</em>. In continuous time, the probability that an event will occur <em>at any specific instant</em> approaches 0. The probability may nor reach 0, but as time’s divisions become finer and finer, it becomes smaller and smaller.</li>
<li><em>The probability that two or more individuals will share the same event time is also infinitesimally small</em>. If the probability of event occurrence at each instant is infinitesimally small, the probability of <em>co</em>occurrence (a tie) must be smaller still. (p.&nbsp;470, <em>emphasis</em> in the original)</li>
</ul>
</blockquote>
<p>Load the horn honking data from Diekmann, Jungbauer-Gans, Krassing, and Lorenz <span class="citation" data-cites="diekmann1996social">(<a href="references.html#ref-diekmann1996social" role="doc-biblioref">1996</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>honking <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/honking.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make all names lower case</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(str_to_lower) <span class="sc">%&gt;%</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">censor_1 =</span> <span class="fu">abs</span>(censor <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(honking)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 57
Columns: 4
$ id       &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 31, …
$ seconds  &lt;dbl&gt; 2.88, 4.63, 2.36, 2.68, 2.50, 4.30, 1.86, 4.01, 1.41, 9.59, 4.44, 3.14, 2.83, 12.29, 4.96, 5.88, 2.12, 6.03, 4.…
$ censor   &lt;dbl&gt; 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, …
$ censor_1 &lt;dbl&gt; 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, …</code></pre>
</div>
</div>
<p>Here’s a quick way to arrange the <code>seconds</code> values and <code>censor</code> status of each case in a similar way to how they appear in Table 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>honking <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(seconds) <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">seconds =</span> <span class="fu">ifelse</span>(censor <span class="sc">==</span> <span class="dv">0</span>, seconds, <span class="fu">str_c</span>(seconds, <span class="st">"*"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 × 1
   seconds
   &lt;chr&gt;  
 1 1.41   
 2 1.41*  
 3 1.51   
 4 1.67   
 5 1.68   
 6 1.86   
 7 2.12   
 8 2.19   
 9 2.36*  
10 2.48   
# ℹ 47 more rows</code></pre>
</div>
</div>
<p>For kicks, here’s a tile-plot version of Table 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>honking <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(seconds) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `formatC()` allows us to retain the trailing zeros when converting the numbers to text</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">text =</span> <span class="fu">formatC</span>(seconds, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">format =</span> <span class="st">"f"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">ifelse</span>(censor <span class="sc">==</span> <span class="dv">0</span>, text, <span class="fu">str_c</span>(text, <span class="st">"*"</span>)),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">row  =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">times =</span> <span class="dv">9</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">col  =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">times =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">6</span>, <span class="at">times =</span> <span class="dv">9</span>), <span class="dv">3</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> col, <span class="at">y =</span> row)) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> seconds)) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> time, <span class="at">color =</span> seconds <span class="sc">&lt;</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"B"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"white"</span>)) <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>() <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Table 13.1: Known and censored (*) event times for 57 motorists blocked by another</span><span class="sc">\n</span><span class="st">automobile (reaction times are recorded to the nearest hundredth of a second)"</span>) <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-survivor-function" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="the-survivor-function"><span class="header-section-number">13.1.2</span> The survivor function</h3>
<p>“In continuous time, the survival probability for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t_j\)</span> is the probability that his or her event time, <span class="math inline">\(T_i\)</span> will exceed <span class="math inline">\(t_j\)</span>” (p.&nbsp;472). This follows the equation</p>
<p><span class="math display">\[S(t_{ij}) = \Pr [T_i &gt; t_j].\]</span></p>
<p>Heads up: When Singer and Willett “do not distinguish individuals on the basis of predictors, [they] remove the subscript <span class="math inline">\(i\)</span>, letting <span class="math inline">\(S(t_j)\)</span> represent the survivor function for a randomly selected member of the population” (p.&nbsp;472).</p>
</section>
<section id="the-hazard-function" class="level3" data-number="13.1.3">
<h3 data-number="13.1.3" class="anchored" data-anchor-id="the-hazard-function"><span class="header-section-number">13.1.3</span> The hazard function</h3>
<blockquote class="blockquote">
<p>The hazard function assesses the <em>risk</em>–at a particular moment–that an individual who has not yet done so will experience the target event. In discrete time, the moments are time periods, which allows us to express hazard as a conditional probability. In continuous time, the moments are the infinite numbers of infinitesimally small instants of time that exist within any finite time period, a change that requires us to alter our definition. (pp.&nbsp;472–473, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Singer and Willett the went on to demonstrate the notion of “infinitesimally small instants of time” by dividing a year into days, hours, minutes, and seconds. Here’s how we might use <strong>R</strong> to practice dividing up a year into smaller and smaller units.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>year    <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>days    <span class="ot">&lt;-</span> <span class="dv">365</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>hours   <span class="ot">&lt;-</span> <span class="dv">24</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>minutes <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>seconds <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>year <span class="sc">*</span> days</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 365</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>year <span class="sc">*</span> days <span class="sc">*</span> hours</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8760</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>year <span class="sc">*</span> days <span class="sc">*</span> hours <span class="sc">*</span> minutes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 525600</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>year <span class="sc">*</span> days <span class="sc">*</span> hours <span class="sc">*</span> minutes <span class="sc">*</span> seconds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 31536000</code></pre>
</div>
</div>
<p>Building, we define the continuous-time hazard function as</p>
<p><span class="math display">\[h(t_{ij}) = \text{limit as } \Delta t \rightarrow 0 \left \{ \frac{\Pr[T_i \text{ is in the interval } (t_j, t_j + \Delta t) | T_i \geq t_j]}{\Delta t} \right \},\]</span></p>
<p>where <span class="math inline">\([t_j, t_j + \Delta t)\)</span> is the <span class="math inline">\(j\)</span>th time interval and “the opening phrase ‘<span class="math inline">\(\text{limit as } \Delta t \rightarrow 0\)</span>’ indicates that we evaluate the conditional probability in brackets as the interval width modes closer and closer to 0” (p.&nbsp;474).</p>
<blockquote class="blockquote">
<p>Because the definitions of hazard differ in continuous and discrete time, their interpretations differ as well. Most important, <em>continuous-time hazard is not a probability</em>. Instead, it is a <em>rate</em>, assessing the conditional probability of event occurrence <em>per unit of time</em>. No matter how tempted you might be to use the nomenclature of probability to describe rates in continuous time, please resist the urge. Rates and probabilities are not the same, and so the interpretive language is not interchangeable. (p.&nbsp;474, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Closing out this section, we read:</p>
<blockquote class="blockquote">
<p>An important difference between continuous-time hazard rates and discrete-time hazard probabilities is that rates are not bounded from above. Although neither can be negative, rates can easily exceed 1.0…. The possibility that continuous-time hazard rate can exceed 1 has serious consequences because it requires that we revise the statistical models that incorporate the effects of predictors. We cannot posit a model in terms of <em>logit</em> hazard (as in discrete time) because that transformation is defined only for values of hazard between 0 and 1. As a result, when we specify continuous-time hazard models in chapter 14, our specification will focus on the <em>logarithm</em> of hazard, a transformation that is defines for all values of hazard greater than 0. (p.&nbsp;475, <em>emphasis</em> in the original)</p>
</blockquote>
</section>
</section>
<section id="grouped-methods-for-estimating-continuous-time-survivor-and-hazard-functions" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="grouped-methods-for-estimating-continuous-time-survivor-and-hazard-functions"><span class="header-section-number">13.2</span> Grouped methods for estimating continuous-time survivor and hazard functions</h2>
<blockquote class="blockquote">
<p>In principle, in continuous time, we would like to estimate a value for the survivor and hazard functions at every possible instant when an event could occur. In practice, we can do so only if we are willing to adopt constraining parametric assumptions about the distribution of event times. To support this approach, statisticians have identified dozens of different distributions–Weibull, Gompertz, gamma, and log-logistic, to name a few–that event times might follow, and in some fields—industrial product testing, for example–parametric estimation is the dominant mode of analysis <span class="citation" data-cites="lawless1982StatisticalModels">(see, e.g., <a href="references.html#ref-lawless1982StatisticalModels" role="doc-biblioref">Lawless, 1982</a>)</span>.</p>
<p>In many other fields, including most of the social, behavioral, and medical sciences, nonparametric methods are more popular. The fundamental advantage of nonparametric methods is that we need not make constraining assumptions about the distribution of event times. This flexibility is important because: (1) few researchers have a sound basis for preferring one distribution over another; and (2) adopting an <em>incorrect</em> assumption can lead to erroneous conclusions. With a nonparametric approach, you essentially trade the <em>possibility</em> of a minor increase in efficiency if a particular assumption holds for the guarantee of doing nearly as well for most data sets, regardless of its tenability.</p>
<p>For decades, in a kind of mathematic irony, statisticians obtained nonparametric estimates of the continuous-time survivor and hazard functions by grouping event times into a small number of intervals, constructing a life table, and applying the discrete-time strategies of chapter 10 (with some minor revisions noted below). In this section we describe two of the most popular of these grouped strategies: the <em>discrete-time</em> method (section 13.2.1) and the <em>actuarial</em> method (section 13.2.2). (pp.&nbsp;475–476, <em>emphasis</em> in the original)</p>
</blockquote>
<p>As we’ll see, <strong>brms</strong> supports parametric and nonparametric continuous-time survival models. In the sections and chapters to come, we will make extensive use of the Cox model, which is nonparametric. However, if you look through the <em>Time-to-event models</em> section of Bürkner’s <span class="citation" data-cites="Bürkner2021Parameterization">(<a href="references.html#ref-Bürkner2021Parameterization" role="doc-biblioref">2021</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_families.html"><em>Parameterization of response distributions in brms</em></a>, you’ll see <strong>brms</strong> supports survival models with the exponential, inverse-Gaussian, gamma, log-normal, and Weibull likelihoods.</p>
<section id="constructing-a-grouped-life-table" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="constructing-a-grouped-life-table"><span class="header-section-number">13.2.1</span> Constructing a grouped life table</h3>
<blockquote class="blockquote">
<p>Grouped estimation strategies begin with a life table that partitions continuous time into a manageable number of contiguous intervals. When choosing a partition, you should seek one that is: (1) substantively meaningful; (2) coarse enough to yield stable estimates; and (3) fine enough to reveal discernible patterns. (p.&nbsp;476)</p>
</blockquote>
<p>For the first step in making the life table of Table 13.2, we’ll make variables that partition the <code>seconds</code> column of the <code>honking</code> data into lower and upper bounds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>honking <span class="ot">&lt;-</span> honking <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lb =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">6</span> <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="dv">6</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&lt;</span> <span class="dv">8</span> <span class="sc">~</span> <span class="dv">7</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    seconds <span class="sc">&gt;=</span> <span class="dv">8</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ub =</span> <span class="fu">if_else</span>(lb <span class="sc">==</span> <span class="dv">8</span>, <span class="dv">18</span>, lb <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_interval =</span> <span class="fu">str_c</span>(<span class="st">"["</span>, lb, <span class="st">", "</span>, ub, <span class="st">")"</span>))</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>honking <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     id seconds censor censor_1    lb    ub time_interval
  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;        
1     1    2.88      0        1     2     3 [2, 3)       
2     2    4.63      1        0     4     5 [4, 5)       
3     3    2.36      1        0     2     3 [2, 3)       
4     4    2.68      0        1     2     3 [2, 3)       
5     5    2.5       0        1     2     3 [2, 3)       
6     6    4.3       1        0     4     5 [4, 5)       </code></pre>
</div>
</div>
<p>Now we’ll transform the data into a life-table format, which we’ll save as <code>honking_aggregated</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a> honking_aggregated <span class="ot">&lt;-</span> honking <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">ifelse</span>(censor <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"n_events"</span>, <span class="st">"n_censored"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(lb, event) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> event,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ub =</span> <span class="fu">if_else</span>(lb <span class="sc">==</span> <span class="dv">8</span>, <span class="dv">18</span>, lb <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_interval =</span> <span class="fu">str_c</span>(<span class="st">"["</span>, lb, <span class="st">", "</span>, ub, <span class="st">")"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_censored =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(n_censored), <span class="dv">0</span>, n_censored)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> n_censored <span class="sc">+</span> n_events) <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_at_risk =</span> <span class="fu">sum</span>(total) <span class="sc">-</span> <span class="fu">cumsum</span>(<span class="fu">lag</span>(total, <span class="at">default =</span> <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lb, ub, time_interval, n_at_risk, n_events, n_censored) <span class="sc">%&gt;%</span> </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">p(t)</span><span class="st">`</span> <span class="ot">=</span> n_events <span class="sc">/</span> n_at_risk)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>honking_aggregated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 7
     lb    ub time_interval n_at_risk n_events n_censored `p(t)`
  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt;
1     1     2 [1, 2)               57        5          1 0.0877
2     2     3 [2, 3)               51       14          3 0.275 
3     3     4 [3, 4)               34        9          2 0.265 
4     4     5 [4, 5)               23        6          4 0.261 
5     5     6 [5, 6)               13        2          2 0.154 
6     6     7 [6, 7)                9        2          2 0.222 
7     7     8 [7, 8)                5        1          0 0.2   
8     8    18 [8, 18)               4        3          1 0.75  </code></pre>
</div>
</div>
</section>
<section id="the-discrete-time-method" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="the-discrete-time-method"><span class="header-section-number">13.2.2</span> The discrete-time method</h3>
<p>Here we simply apply the discrete-time hazard model to our discretized continuous-time data. Before we fit the model, we’ll define a new term, <span class="math inline">\(\hat p(t_j)\)</span>. Recall back to Section 10.2 where we defined the hazard function <span class="math inline">\(\hat h(t_{j})\)</span> as</p>
<p><span class="math display">\[\hat h(t_{j}) = \frac{n \text{ events}_j}{n \text{ at risk}_j}.\]</span></p>
<p>Now we’re working with continuous-time data (even if they’re momentarily discretized), we focus instead on <span class="math inline">\(\hat p(t_{j})\)</span>. In words, <span class="math inline">\(\hat p(t_{j})\)</span> is the conditional probability that a member of the risk set at the beginning of the interval <span class="math inline">\(j\)</span> will experience the target event during that interval. In discrete time we labeled this quantity “hazard,” but now we use the term “<em>conditional probability</em>” to distinguish it from a continuous time <em>hazard rate</em>. Our conditional probability follows the formula</p>
<p><span class="math display">\[\hat p(t_{j}) = \frac{n \text{ events}_j}{n \text{ at risk}_j},\]</span></p>
<p>where <span class="math inline">\(n \text{ events}_j\)</span> is the number of individuals who experienced the event in the <span class="math inline">\(j^{th}\)</span> period and <span class="math inline">\(n \text{ at risk}_j\)</span> is the number of those at risk at the beginning of the interval <span class="math inline">\(j\)</span>.</p>
<p>Time to fire up <strong>brms</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For our first model, we will use the binomial likelihood with the aggregated version of the <code>honking</code> data, <code>honking_aggregated</code>. The main time variable in those data is <code>time_interval</code>, the lower and upper bounds for which are identified in the <code>lb</code> and <code>ub</code> columns, respectively. In anticipation of the upcoming plots, we’ll use the <code>ub</code> variable for time. But to make fitting the model easier with the <code>brm()</code> function, we’ll first save a factor version of the variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>honking_aggregated <span class="ot">&lt;-</span> honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ub_f =</span> <span class="fu">factor</span>(ub))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the last chapter, we used the <code>normal(0, 4)</code> prior, which was permissive in the log-odds metric. Here we’ll be more conservative and use <code>normal(0, 1.5)</code>, which is weakly-regularizing on the log-odds metric, but flat in the probability metric. A plot might help show this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">`</span><span class="at">log odds</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fl">1e6</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probability =</span> <span class="fu">plogis</span>(<span class="st">`</span><span class="at">log odds</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_histinterval</span>(<span class="at">normalize =</span> <span class="st">"panels"</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"prior predictive distribution"</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Otherwise, this model is just like any of the other unconditional discrete-time models we’ve fit with <code>brm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> honking_aggregated,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_at_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> ub_f,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">1.5</span>), <span class="at">class =</span> b),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">1</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the parameter summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: n_events | trials(n_at_risk) ~ 0 + ub_f 
   Data: honking_aggregated (Number of observations: 8) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
ub_f2     -2.21      0.43    -3.13    -1.44 1.00     7509     2887
ub_f3     -0.95      0.31    -1.59    -0.38 1.00     7866     2857
ub_f4     -0.99      0.39    -1.78    -0.27 1.00     8305     2956
ub_f5     -1.00      0.47    -1.98    -0.12 1.00     6816     3079
ub_f6     -1.48      0.66    -2.89    -0.29 1.00     8041     2611
ub_f7     -1.08      0.69    -2.47     0.20 1.00     8507     3266
ub_f8     -1.02      0.84    -2.77     0.49 1.00     7275     3188
ub_f18     0.79      0.91    -0.87     2.71 1.00     7497     2610

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>As will become apparent in a bit, our <code>normal(0, 1.5)</code> prior was not inconsequential. Our aggregated data were composed of the event/censoring information of 57 cases, spread across 8 time periods. This left little information in the likelihood, particularly for the later time periods. As a consequence, the prior left clear marks in the posterior.</p>
<p>As with the discrete-time model, we can formally define the survivor function for the continuous-time model as</p>
<p><span class="math display">\[\hat S(t_j) =  \big(1 - \hat p(t_1)\big) \big(1 - \hat p(t_2)\big)... \big(1 - \hat p(t_j)\big).\]</span></p>
<p>It’ll take a little wrangling effort to transform the output from <code>as_draws_df(fit13.1)</code> into a useful form for plotting and summarizing <span class="math inline">\(\hat S(t_j)\)</span>. We’ll save it as <code>s</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit13<span class="fl">.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(plogis) <span class="sc">%&gt;%</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">b_ub_f0 =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b_ub_f0, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">18</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>iter,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"time"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(iter) <span class="sc">%&gt;%</span> </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">survivor =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> p)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can make the first 6 columns of Table 13.2 by combining a subset of the <code>honking_aggregated</code> data with a summary of our <code>s</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the first 5 columns for Table 13.2</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(time_interval<span class="sc">:</span><span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the 6th column</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  s <span class="sc">%&gt;%</span> </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span> </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">median =</span> <span class="fu">median</span>(survivor),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd     =</span> <span class="fu">sd</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="st">`</span><span class="at">S(t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">str_c</span>(median, <span class="st">" ("</span>, sd, <span class="st">")"</span>))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 6
  time_interval n_at_risk n_events n_censored `p(t)` `S(t)`         
  &lt;chr&gt;             &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;          
1 [1, 2)               57        5          1 0.0877 0.8989 (0.0386)
2 [2, 3)               51       14          3 0.275  0.6442 (0.0625)
3 [3, 4)               34        9          2 0.265  0.4633 (0.0662)
4 [4, 5)               23        6          4 0.261  0.3322 (0.0638)
5 [5, 6)               13        2          2 0.154  0.262 (0.0611) 
6 [6, 7)                9        2          2 0.222  0.1892 (0.0555)
7 [7, 8)                5        1          0 0.2    0.1308 (0.05)  
8 [8, 18)               4        3          1 0.75   0.0405 (0.0311)</code></pre>
</div>
</div>
<p>You’ll note that our posterior summary values in <code>S(t)</code> differ a little from those in the text. Remember, the likelihood was weak and we used a regularizing prior. If we had more cases spread across fewer discretized time periods, the likelihood would have done a better job updating the prior.</p>
<p>Now let’s take a look at the posterior of our survivor function, <span class="math inline">\(\hat S(t_j)\)</span>, in our version of the upper left panel of Figure 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>s <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> survivor)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the ML-based survival estimates</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> honking_aggregated <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">s =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>)),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> ub, <span class="at">y =</span> s),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="st">"CI level"</span>, <span class="at">start =</span> <span class="fl">0.7</span>, <span class="at">end =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>For a little context, we superimposed the sample (ML) estimates of the survivor function in red. Based on the posterior median, our median lifetime appears to be between the time intervals of <span class="math inline">\([2, 3)\)</span> and <span class="math inline">\([3, 4)\)</span>. Sticking with those medians, here’s the exact number using Miller’s <span class="citation" data-cites="miller1981SurvivalAnalysis">(<a href="references.html#ref-miller1981SurvivalAnalysis" role="doc-biblioref">1981</a>)</span> interpolation approach from <a href="10.html#sec-Median-lifetime" class="quarto-xref"><span>Section 10.2.2</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>s_medians <span class="ot">&lt;-</span> s <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lb =</span> time <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">ub =</span> time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_interval =</span> <span class="fu">str_c</span>(<span class="st">"["</span>, lb, <span class="st">", "</span>, ub, <span class="st">")"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ub <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time_interval) <span class="sc">%&gt;%</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median =</span> <span class="fu">median</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(median)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="sc">+</span> (s_medians[<span class="dv">1</span>] <span class="sc">-</span> .<span class="dv">5</span>) <span class="sc">/</span> (s_medians[<span class="dv">1</span>] <span class="sc">-</span> s_medians[<span class="dv">2</span>]) <span class="sc">*</span> (<span class="dv">4</span> <span class="sc">-</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.797289</code></pre>
</div>
</div>
<p>Here’s how we might convert the output of <code>as_draws_df(fit13.1)</code> into a useful format for our hazard function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit13<span class="fl">.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(plogis) <span class="sc">%&gt;%</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">18</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>iter,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"time"</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>())</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 32,000 × 3
    iter  time      p
   &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;
 1     1     2 0.120 
 2     1     3 0.331 
 3     1     4 0.493 
 4     1     5 0.113 
 5     1     6 0.0781
 6     1     7 0.437 
 7     1     8 0.142 
 8     1    18 0.900 
 9     2     2 0.110 
10     2     3 0.226 
# ℹ 31,990 more rows</code></pre>
</div>
</div>
<p>For continuous-time data, hazard is a rate, which is</p>
<blockquote class="blockquote">
<p>the limit of the conditional probability of event occurrence in a (vanishingly small) interval divided by the interval’s width. A logical estimator is thus the ratio of the conditional probability of event occurrence in an interval to the interval’s width. (p.&nbsp;479)</p>
</blockquote>
<p>Thus, our new definition of hazard is</p>
<p><span class="math display">\[\hat h(t_j) = \frac{\hat p(t_j)}{\text{width}_j},\]</span></p>
<p>where <span class="math inline">\(\text{width}_j\)</span> denotes the width of the <span class="math inline">\(j\)</span>th interval. The widths of most of our intervals were 1 (seconds). The final interval, <span class="math inline">\([8, 18)\)</span>, had a width of ten. Once we add that information to the <code>h</code> data, we can use the formula above to convert <span class="math inline">\(\hat p(t_j)\)</span> to <span class="math inline">\(\hat h(t_j)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> h <span class="sc">%&gt;%</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">width =</span> <span class="fu">if_else</span>(time <span class="sc">&lt;=</span> <span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">10</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hazard =</span> p <span class="sc">/</span> width)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can make the first 7 columns of Table 13.2 by adding an cleaned-up version of our <code>h</code> object to what we had before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the first 5 columns for Table 13.2</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(time_interval<span class="sc">:</span><span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the 6th column</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  s <span class="sc">%&gt;%</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">median =</span> <span class="fu">median</span>(survivor),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd     =</span> <span class="fu">sd</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="st">`</span><span class="at">S(t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">str_c</span>(median, <span class="st">" ("</span>, sd, <span class="st">")"</span>)),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the 7th column</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  h <span class="sc">%&gt;%</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span> </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">median =</span> <span class="fu">median</span>(hazard),</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd     =</span> <span class="fu">sd</span>(hazard)) <span class="sc">%&gt;%</span> </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(<span class="st">`</span><span class="at">h(t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">str_c</span>(median, <span class="st">" ("</span>, sd, <span class="st">")"</span>))</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 7
  time_interval n_at_risk n_events n_censored `p(t)` `S(t)`          `h(t)`         
  &lt;chr&gt;             &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;          
1 [1, 2)               57        5          1 0.0877 0.8989 (0.0386) 0.1011 (0.0386)
2 [2, 3)               51       14          3 0.275  0.6442 (0.0625) 0.279 (0.0616) 
3 [3, 4)               34        9          2 0.265  0.4633 (0.0662) 0.2742 (0.0756)
4 [4, 5)               23        6          4 0.261  0.3322 (0.0638) 0.2729 (0.0902)
5 [5, 6)               13        2          2 0.154  0.262 (0.0611)  0.1924 (0.0978)
6 [6, 7)                9        2          2 0.222  0.1892 (0.0555) 0.2569 (0.1245)
7 [7, 8)                5        1          0 0.2    0.1308 (0.05)   0.2719 (0.1518)
8 [8, 18)               4        3          1 0.75   0.0405 (0.0311) 0.0676 (0.0175)</code></pre>
</div>
</div>
<p>Perhaps even more so than with our estimates for the survivor function, our hazard estimates show the influence of our prior on the posterior. For example, note how our posterior standard deviations tend to be a bit smaller than the standard errors reported in the text. To my mind, plotting the marginal posteriors for the intervals of our hazard function really helps hit this home.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>h <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">factor</span>(time)) <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hazard, <span class="at">y =</span> time)) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">normalize =</span> <span class="st">"xy"</span>) <span class="sc">+</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>As wide and sloppy as those distributions look, they’re more precise than the estimates returned by Maximum Likelihood (ML). To finish this section out with the lower left panel of Figure 13.1, here’s what our hazard function looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>h <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hazard)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="st">"CI level"</span>, <span class="at">start =</span> <span class="fl">0.7</span>, <span class="at">end =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">h</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>)) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-actuarial-method" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="the-actuarial-method"><span class="header-section-number">13.2.3</span> The actuarial method</h3>
<p>I’m not going to dive into a full explanation of the actuarial method. For that, read the book. However, the actuarial method presents a challenge for our <strong>brms</strong> paradigm. To appreciate the challenge, we’ll need a couple block quotes:</p>
<blockquote class="blockquote">
<p>For the survivor function, we ask: What does it mean to be “at risk of surviving” past the end of an interval? Because a censored individual is no longer “at risk of surviving” once censoring occurs, we redefine each interval’s risk set to account for the censoring we assume to occur equally throughout. This implies that half the censored individuals would no longer be at risk half-way through, so we redefine the number of individuals “at risk of surviving past interval <span class="math inline">\(j\)</span>” to be:</p>
<p><span class="math display">\[n' \; at \; risk_j = n \; at \; risk_j - \frac{n \; censored_j}{2}.\]</span></p>
<p>The actuarial estimate of the survivor function is obtained by substituting <span class="math inline">\(n' \; at \; risk_j\)</span> for <span class="math inline">\(n \; at \; risk_j\)</span> in the discrete-time formulas just presented in section 13.2.2 (equations 13.3 and 13.4). (pp.&nbsp;480–481, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Further:</p>
<blockquote class="blockquote">
<p>To estimate the hazard function using the actuarial approach, we again redefine what it means to be “at risk.” Now, however, we ask about the “risk of event occurrence” <em>during</em> the interval, not the “risk of survival” <em>past</em> the interval. This change of definition suggests that each interval’s risk set should be diminished not just by censoring but also by event occurrence, because either eliminates the possibility of subsequent event occurrence. Because categorization continues to prevent us from knowing precisely when people leave the risk set, we assume that exits are scattered at random throughout the interval. This implies that half these individuals are no longer at risk of event occurrence halfway through, so we redefine the number of individuals “at risk of event occurrence” in interval <span class="math inline">\(j\)</span> to be:</p>
<p><span class="math display">\[n'' \; at \; risk_j = n \; at \; risk_j - \frac{n \; censored_j}{2} - \frac{n \; events_j}{2}.\]</span></p>
<p>The actuarial estimator of the continuous-time hazard function is then obtained by substituting <span class="math inline">\(n'' \; at \; risk_j\)</span> for <span class="math inline">\(n \; at \; risk_j\)</span> in discrete-time formulas of section 13.2.2 (equations 13.3 and 13.5). (pp.&nbsp;481–481, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Here’s how we might implement the equations for <span class="math inline">\(n' \; at \; risk_j\)</span> and <span class="math inline">\(n'' \; at \; risk_j\)</span> in our <code>honking_aggregated</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>honking_aggregated <span class="ot">&lt;-</span> honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_p_at_risk_a  =</span> n_at_risk <span class="sc">-</span> (n_censored <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">n_pp_at_risk_a =</span> n_at_risk <span class="sc">-</span> (n_censored <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">-</span> (n_events <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>honking_aggregated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 10
     lb    ub time_interval n_at_risk n_events n_censored `p(t)` ub_f  n_p_at_risk_a n_pp_at_risk_a
  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;         &lt;dbl&gt;          &lt;dbl&gt;
1     1     2 [1, 2)               57        5          1 0.0877 2              56.5           54  
2     2     3 [2, 3)               51       14          3 0.275  3              49.5           42.5
3     3     4 [3, 4)               34        9          2 0.265  4              33             28.5
4     4     5 [4, 5)               23        6          4 0.261  5              21             18  
5     5     6 [5, 6)               13        2          2 0.154  6              12             11  
6     6     7 [6, 7)                9        2          2 0.222  7               8              7  
7     7     8 [7, 8)                5        1          0 0.2    8               5              4.5
8     8    18 [8, 18)               4        3          1 0.75   18              3.5            2  </code></pre>
</div>
</div>
<p>The essence of our problem is we’ve been using the binomial likelihood to fit discrete-time hazard functions with <strong>brms</strong>. In this paradigm, we feed in data composed of the number of <em>successes</em> and the corresponding number of trials to compute probability <span class="math inline">\(p\)</span> of a <em>success</em> within a given trial. Although <span class="math inline">\(p\)</span> is a continuous value ranging from 0 to 1, the binomial likelihood takes the numbers of successes and trials to be non-negative integers. If you try to feed our actuarial <span class="math inline">\(n'' \; at \; risk_j\)</span> variable, <code>n_at_risk_pp</code> into the <code>formula</code> argument for <code>brms::brm()</code> (e.g., <code>n_events | trials(n_at_risk_pp) ~ 0 + ub_f</code>), <strong>brms</strong> will return the warning:</p>
<blockquote class="blockquote">
<p>Error: Number of trials must be positive integers.</p>
</blockquote>
<p>We can, however, follow along and compute the ML estimates by hand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>honking_aggregated <span class="ot">&lt;-</span> honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> n_events <span class="sc">/</span> n_p_at_risk_a),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">p(t)_a</span><span class="st">`</span> <span class="ot">=</span> n_events <span class="sc">/</span> n_pp_at_risk_a,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">width    =</span> <span class="fu">if_else</span>(lb <span class="sc">==</span> <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">h(t)_a</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">p(t)_a</span><span class="st">`</span> <span class="sc">/</span> width)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>honking_aggregated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 14
     lb    ub time_interval n_at_risk n_events n_censored `p(t)` ub_f  n_p_at_risk_a n_pp_at_risk_a `S(t)_a` `p(t)_a` width
  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;         &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
1     1     2 [1, 2)               57        5          1 0.0877 2              56.5           54     0.912    0.0926     1
2     2     3 [2, 3)               51       14          3 0.275  3              49.5           42.5   0.654    0.329      1
3     3     4 [3, 4)               34        9          2 0.265  4              33             28.5   0.475    0.316      1
4     4     5 [4, 5)               23        6          4 0.261  5              21             18     0.340    0.333      1
5     5     6 [5, 6)               13        2          2 0.154  6              12             11     0.283    0.182      1
6     6     7 [6, 7)                9        2          2 0.222  7               8              7     0.212    0.286      1
7     7     8 [7, 8)                5        1          0 0.2    8               5              4.5   0.170    0.222      1
8     8    18 [8, 18)               4        3          1 0.75   18              3.5            2     0.0243   1.5       10
# ℹ 1 more variable: `h(t)_a` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Before we make our version of the right-hand side of Figure 13.1, we’ll need to augment the data a little. Then <code>geom_step()</code> will do most of the magic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add `S(t)_a` values for `lb = c(0, 18)`</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lb, <span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">lb       =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">18</span>),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, honking_aggregated<span class="sc">$</span><span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span>[<span class="dv">8</span>]))) <span class="sc">%&gt;%</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorder</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(lb) <span class="sc">%&gt;%</span> </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot!</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lb, <span class="at">y =</span> <span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j])))), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># add `h(t)_a` values for `lb = 18`</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> honking_aggregated <span class="sc">%&gt;%</span> </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lb, <span class="st">`</span><span class="at">h(t)_a</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">lb       =</span> <span class="dv">18</span>, </span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">h(t)_a</span><span class="st">`</span> <span class="ot">=</span> honking_aggregated<span class="sc">$</span><span class="st">`</span><span class="at">h(t)_a</span><span class="st">`</span>[<span class="dv">8</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(lb) <span class="sc">%&gt;%</span> </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lb, <span class="at">y =</span> <span class="st">`</span><span class="at">h(t)_a</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">h</span>(t[j])))), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Combine the subplots and make our version of the right-hand side of Figure 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">/</span> p2) <span class="sc">&amp;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>I’m not going to bother with computing the ML standard errors for the actuarial survivor and hazard estimates. You can reference page 482 in the text for more on those.</p>
</section>
</section>
<section id="the-kaplan-meier-method-of-estimating-the-continuous-time-survivor-function" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="the-kaplan-meier-method-of-estimating-the-continuous-time-survivor-function"><span class="header-section-number">13.3</span> The Kaplan-Meier method of estimating the continuous-time survivor function</h2>
<blockquote class="blockquote">
<p>A fundamental problem with grouped estimation methods is that they artificially categorize what is now, by definition, a continuous variable…. Shouldn’t it be possible to use the <em>observed</em> data–the actual event times–to describe the distribution of event occurrences? This compelling idea underlies the Kaplan-Meier method, named for the statisticians who demonstrated <span class="citation" data-cites="kaplan1958NonparametricEstimation">(in <a href="references.html#ref-kaplan1958NonparametricEstimation" role="doc-biblioref">1958</a>)</span> that the intuitive approach–also known as the <em>product-limit method</em>–has maximum likelihood properties as well. Below, we explain how this approach works and why it is preferable.</p>
<p>The Kaplan-Meier method is a simple extension of the discrete-time method with a fundamental change: instead of rounding event times to construct the intervals, capitalize on the raw event times and construct intervals so that each contains just <em>one observed event time</em> (as shown in table 13.3). Each Kaplan-Meier interval begins at one observed event time and ends just before the next. (p.&nbsp;483, <em>emphasis</em> in the original)</p>
</blockquote>
<p>As discussed in the prose in the middle of page 483, here are the first three event times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>honking <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(censor <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="sc">-</span><span class="dv">3</span>, seconds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
     id seconds censor censor_1    lb    ub time_interval
  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;        
1     9    1.41      0        1     1     2 [1, 2)       
2    40    1.51      0        1     1     2 [1, 2)       
3    50    1.67      0        1     1     2 [1, 2)       </code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>The Kaplan-Meier estimate of the survivor function is obtained by applying the discrete-time estimator of section 13.2.2 to the data of these intervals. [Most] statistical packages include a routine for computing and plotting the estimates. Numerically, the process is simple: first compute the conditional probability of event occurrence (column 7) and then successively multiply the complements of these probabilities together to obtain the Kaplan-Meier estimate of the survivor function (column 8). Because the Kaplan-Meier estimator of the survivor function is identical to the discrete-time estimator of chapter 10, its standard errors (column 9) are estimated using the same formula (pp.&nbsp;483–485).</p>
</blockquote>
<p>To walk this out, we’ll first use the frequentist <strong>survival</strong> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the <code>survival::survfit()</code> function to fit the unconditional model with the Kaplan-Meier estimator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a> fit13<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">data =</span> honking,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">Surv</span>(seconds, censor_1) <span class="sc">~</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>summary()</code> returns a lot of output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit13<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(seconds, censor_1) ~ 1, data = honking)

  time n.risk n.event survival std.err lower 95% CI upper 95% CI
  1.41     57       1   0.9825  0.0174      0.94896        1.000
  1.51     55       1   0.9646  0.0246      0.91758        1.000
  1.67     54       1   0.9467  0.0299      0.88985        1.000
  1.68     53       1   0.9289  0.0343      0.86405        0.999
  1.86     52       1   0.9110  0.0380      0.83950        0.989
  2.12     51       1   0.8931  0.0412      0.81587        0.978
  2.19     50       1   0.8753  0.0441      0.79296        0.966
  2.48     48       1   0.8570  0.0468      0.77004        0.954
  2.50     47       1   0.8388  0.0492      0.74765        0.941
  2.53     46       1   0.8206  0.0514      0.72572        0.928
  2.54     45       1   0.8023  0.0534      0.70418        0.914
  2.56     44       1   0.7841  0.0552      0.68299        0.900
  2.62     43       1   0.7659  0.0569      0.66212        0.886
  2.68     42       1   0.7476  0.0584      0.64154        0.871
  2.83     39       1   0.7285  0.0599      0.61996        0.856
  2.88     38       1   0.7093  0.0614      0.59868        0.840
  2.89     37       1   0.6901  0.0626      0.57769        0.824
  2.92     36       1   0.6710  0.0637      0.55695        0.808
  2.98     35       1   0.6518  0.0647      0.53648        0.792
  3.14     33       1   0.6320  0.0657      0.51549        0.775
  3.17     32       1   0.6123  0.0666      0.49477        0.758
  3.21     31       1   0.5925  0.0673      0.47429        0.740
  3.22     30       1   0.5728  0.0679      0.45405        0.723
  3.24     29       1   0.5530  0.0684      0.43404        0.705
  3.56     27       1   0.5325  0.0688      0.41338        0.686
  3.57     26       1   0.5121  0.0692      0.39297        0.667
  3.58     25       1   0.4916  0.0694      0.37282        0.648
  3.78     24       1   0.4711  0.0694      0.35291        0.629
  4.10     22       1   0.4497  0.0695      0.33217        0.609
  4.18     21       1   0.4283  0.0694      0.31172        0.588
  4.44     19       1   0.4057  0.0693      0.29028        0.567
  4.51     18       1   0.3832  0.0690      0.26919        0.545
  4.52     17       1   0.3606  0.0686      0.24847        0.523
  4.96     14       1   0.3349  0.0683      0.22451        0.500
  5.39     12       1   0.3070  0.0681      0.19875        0.474
  5.73     11       1   0.2791  0.0674      0.17386        0.448
  6.03      9       1   0.2481  0.0666      0.14651        0.420
  6.30      7       1   0.2126  0.0659      0.11585        0.390
  7.20      5       1   0.1701  0.0650      0.08044        0.360
  9.59      4       1   0.1276  0.0611      0.04991        0.326
 12.29      3       1   0.0851  0.0535      0.02478        0.292
 13.18      2       1   0.0425  0.0403      0.00665        0.272</code></pre>
</div>
</div>
<p>Taking a cue from the good folks at <a href="https://stats.idre.ucla.edu/r/examples/alda/r-applied-longitudinal-data-analysis-ch-13/">IDRE</a>, saving the summary results as an object will make it easy to subset and augment that information into our version of Table 13.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the summary as t</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit13<span class="fl">.2</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># subset, augment, and save as honking_km</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>honking_km <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">seconds  =</span> t<span class="sc">$</span>time,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n_risk   =</span> t<span class="sc">$</span>n.risk,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n_events =</span> t<span class="sc">$</span>n.event) <span class="sc">%&gt;%</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>     <span class="ot">=</span> n_events <span class="sc">/</span> n_risk,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">n_censored =</span> n_risk <span class="sc">-</span> n_events <span class="sc">-</span> <span class="fu">lead</span>(n_risk, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">interval   =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">interval_f =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">start      =</span> seconds,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">end        =</span> <span class="fu">lead</span>(seconds, <span class="at">default =</span> <span class="cn">Inf</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interval<span class="sc">:</span>interval_f, seconds, start<span class="sc">:</span>end, n_risk<span class="sc">:</span>n_events, n_censored, <span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>honking_km</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 42 × 9
   interval interval_f seconds start   end n_risk n_events n_censored `p(t)`
      &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;
 1        1 1             1.41  1.41  1.51     57        1          1 0.0175
 2        2 2             1.51  1.51  1.67     55        1          0 0.0182
 3        3 3             1.67  1.67  1.68     54        1          0 0.0185
 4        4 4             1.68  1.68  1.86     53        1          0 0.0189
 5        5 5             1.86  1.86  2.12     52        1          0 0.0192
 6        6 6             2.12  2.12  2.19     51        1          0 0.0196
 7        7 7             2.19  2.19  2.48     50        1          1 0.02  
 8        8 8             2.48  2.48  2.5      48        1          0 0.0208
 9        9 9             2.5   2.5   2.53     47        1          0 0.0213
10       10 10            2.53  2.53  2.54     46        1          0 0.0217
# ℹ 32 more rows</code></pre>
</div>
</div>
<p>We haven’t bothered adding the top <code>interval == 0</code> row, but one could add that information with a little <code>bind_rows()</code> labor. Note how we slipped in a few extra columns (e.g., <code>interval_f</code>) because they’ll come in handy, later. We compute the Kaplan-Meier estimates for the survivor function by serially multiplying the compliments for the estimates of the conditional probability values, <span class="math inline">\(\hat p(t)\)</span>. As in other examples, that’s just a little <code>cumprod()</code> code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>honking_km <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">S(t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead of doing that by hand, we could have just subset the <code>surv</code> vector within <code>t</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>t<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.98245614 0.96459330 0.94673046 0.92886762 0.91100478 0.89314195 0.87527911 0.85704413 0.83880914 0.82057416 0.80233918
[12] 0.78410420 0.76586922 0.74763424 0.72846413 0.70929402 0.69012391 0.67095380 0.65178369 0.63203267 0.61228165 0.59253063
[23] 0.57277961 0.55302859 0.53254605 0.51206351 0.49158097 0.47109843 0.44968486 0.42827130 0.40573070 0.38319011 0.36064951
[34] 0.33488883 0.30698143 0.27907403 0.24806580 0.21262783 0.17010227 0.12757670 0.08505113 0.04252557</code></pre>
</div>
</div>
<p>Here we subset the standard errors for <span class="math inline">\(\hat S(t)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>honking_km <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">se[S(t)]</span><span class="st">`</span> <span class="ot">=</span> t<span class="sc">$</span>std.err)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(honking_km)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  interval interval_f seconds start   end n_risk n_events n_censored `p(t)` `S(t)` `se[S(t)]`
     &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
1        1 1             1.41  1.41  1.51     57        1          1 0.0175  0.982     0.0174
2        2 2             1.51  1.51  1.67     55        1          0 0.0182  0.965     0.0246
3        3 3             1.67  1.67  1.68     54        1          0 0.0185  0.947     0.0299
4        4 4             1.68  1.68  1.86     53        1          0 0.0189  0.929     0.0343
5        5 5             1.86  1.86  2.12     52        1          0 0.0192  0.911     0.0380
6        6 6             2.12  2.12  2.19     51        1          0 0.0196  0.893     0.0412</code></pre>
</div>
</div>
<p>We can plot the fitted <span class="math inline">\(\hat S(t)\)</span> values with `geom_step() to make our version of the top half of Figure 13.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seconds, <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">seconds =</span> <span class="fl">17.15</span>, </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>  <span class="ot">=</span> <span class="fl">0.04252557</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now add the actuarial and discrete-time estimates to make our version of the lower panel of Figure 13.2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>arrow <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x    =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="fl">8.7</span>, <span class="fl">2.7</span>),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y    =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>, <span class="fl">0.23</span>),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xend =</span> <span class="fu">c</span>(<span class="fl">2.6</span>, <span class="dv">7</span>, <span class="fl">3.9</span>),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">yend =</span> <span class="fu">c</span>(<span class="fl">0.875</span>, <span class="fl">0.25</span>, <span class="fl">0.33</span>))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x     =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="fl">8.7</span>, <span class="fl">2.7</span>),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">y     =</span> <span class="fu">c</span>(<span class="fl">0.77</span>, <span class="fl">0.43</span>, <span class="fl">0.2</span>),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="fu">c</span>(<span class="st">"Kaplan Meier"</span>, <span class="st">"Discrete-time"</span>, <span class="st">"Actuarial"</span>))</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seconds, <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">seconds =</span> <span class="fl">17.15</span>, </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>  <span class="ot">=</span> <span class="fl">0.04252557</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data =</span> honking_aggregated,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> ub, <span class="at">y =</span> <span class="st">`</span><span class="at">S(t)_a</span><span class="st">`</span>), </span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">3</span>, <span class="at">direction =</span> <span class="st">"vh"</span>) <span class="sc">+</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> honking_aggregated <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">s =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="st">`</span><span class="at">p(t)</span><span class="st">`</span>)),</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> ub, <span class="at">y =</span> s),</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> arrow,</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">xend =</span> xend,</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y, <span class="at">yend =</span> yend),</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.15</span>,<span class="st">"cm"</span>), <span class="at">type =</span> <span class="st">"closed"</span>)) <span class="sc">+</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">label =</span> label)) <span class="sc">+</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Combine and plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">/</span> p2) <span class="sc">&amp;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j])))), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">&amp;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Did you notice how in both subplots we used <code>bind_rows()</code> to add in an <code>S(t)</code> value for <code>seconds = 17.15</code>? In the text, we read:</p>
<blockquote class="blockquote">
<p>As for actuarial estimates, we plot Kaplan-Meier estimates as a step function that associates the estimated probability with the entire interval. If the largest event time is censored, as it is here (17.15), we extend the step for the last estimate out to that largest censored value. (pp.&nbsp;485–486)</p>
</blockquote>
<p>Those <code>bind_rows()</code> lines are what extended “the step for the last estimate.” Since that last estimate for <span class="math inline">\(\hat S(t_j)  = 0.04252557\)</span>, we set <code>S(t) = 0.04252557</code> in the plot data.</p>
<p>We can get the median lifetime by executing <code>print(fit13.2)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(seconds, censor_1) ~ 1, data = honking)

      n events median 0.95LCL 0.95UCL
[1,] 57     42   3.58    3.17    4.96</code></pre>
</div>
</div>
<p>Like in the text, it’s 3.58.</p>
<p>Even though there is no Kaplan-Meier estimate for hazard, we can compute a Kaplan-Meier type hazard with the formula</p>
<p><span class="math display">\[\hat h_\text{KM} (t_j) = \frac{\hat p_\text{KM} (t_j)}{\text{width}_j}.\]</span></p>
<p>Here we compute both the <span class="math inline">\(\text{width}_j\)</span> and <span class="math inline">\(\hat h_\text{KM} (t_j)\)</span> values by hand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>honking_km <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">width =</span> end <span class="sc">-</span> start) <span class="sc">%&gt;%</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">width =</span> <span class="fu">if_else</span>(end <span class="sc">==</span> <span class="cn">Inf</span>, <span class="fl">17.15</span> <span class="sc">-</span> start, width)) <span class="sc">%&gt;%</span>  <span class="co"># this might be wrong</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">h[km](t)</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">p(t)</span><span class="st">`</span> <span class="sc">/</span> width)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>honking_km</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 42 × 13
   interval interval_f seconds start   end n_risk n_events n_censored `p(t)` `S(t)` `se[S(t)]`  width `h[km](t)`
      &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
 1        1 1             1.41  1.41  1.51     57        1          1 0.0175  0.982     0.0174 0.100      0.175 
 2        2 2             1.51  1.51  1.67     55        1          0 0.0182  0.965     0.0246 0.16       0.114 
 3        3 3             1.67  1.67  1.68     54        1          0 0.0185  0.947     0.0299 0.0100     1.85  
 4        4 4             1.68  1.68  1.86     53        1          0 0.0189  0.929     0.0343 0.180      0.105 
 5        5 5             1.86  1.86  2.12     52        1          0 0.0192  0.911     0.0380 0.26       0.0740
 6        6 6             2.12  2.12  2.19     51        1          0 0.0196  0.893     0.0412 0.0700     0.280 
 7        7 7             2.19  2.19  2.48     50        1          1 0.02    0.875     0.0441 0.29       0.0690
 8        8 8             2.48  2.48  2.5      48        1          0 0.0208  0.857     0.0468 0.0200     1.04  
 9        9 9             2.5   2.5   2.53     47        1          0 0.0213  0.839     0.0492 0.0300     0.709 
10       10 10            2.53  2.53  2.54     46        1          0 0.0217  0.821     0.0514 0.0100     2.17  
# ℹ 32 more rows</code></pre>
</div>
</div>
<p>Singer and Willett remarked that “because the interval width varies widely (and is itself a function of the distribution of event times), the resulting estimates vary from one interval to the next. Their values are usually so erratic that pattern identification is nearly impossible” (p.&nbsp;487). That sounds fun. Let’s explore them in a plot!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> start, <span class="at">y =</span> <span class="st">`</span><span class="at">h[km](t)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="fu">italic</span>(h))[KM](<span class="fu">italic</span>(t[j])))) <span class="sc">+</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Erratic, indeed.</p>
<section id="fitting-a-bayesian-kaplan-meier-model" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="fitting-a-bayesian-kaplan-meier-model"><span class="header-section-number">13.3.1</span> Fitting a Bayesian Kaplan-Meier model</h3>
<p>It’s worth repeating one of the quotes from earlier:</p>
<blockquote class="blockquote">
<p>The Kaplan-Meier method is a simple extension of the discrete-time method with a fundamental change: instead of rounding event times to construct the intervals, capitalize on the raw event times and construct intervals so that each contains just <em>one observed event time</em> (as shown in table 13.3). Each Kaplan-Meier interval begins at one observed event time and ends just before the next. (p.&nbsp;483, <em>emphasis</em> in the original)</p>
</blockquote>
<p>Whether we’re working with one event occurrence at a time or binning them in intervals, the basic product of the model is a conditional probability. The binomial likelihood served us well when we binned the event occurrences into largish time intervals, and it will work just the same when we work them in serial fashion. The biggest obstacle is properly setting up the data. After some experimentation, the easiest way to format the data properly is to just use the summary results from <code>survfit(data = honking, Surv(seconds, censor_1) ~ 1)</code>, which we saved as <code>honking_km</code>. Take another look.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(honking_km)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 42
Columns: 13
$ interval   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30…
$ interval_f &lt;fct&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30…
$ seconds    &lt;dbl&gt; 1.41, 1.51, 1.67, 1.68, 1.86, 2.12, 2.19, 2.48, 2.50, 2.53, 2.54, 2.56, 2.62, 2.68, 2.83, 2.88, 2.89, 2.92, 2…
$ start      &lt;dbl&gt; 1.41, 1.51, 1.67, 1.68, 1.86, 2.12, 2.19, 2.48, 2.50, 2.53, 2.54, 2.56, 2.62, 2.68, 2.83, 2.88, 2.89, 2.92, 2…
$ end        &lt;dbl&gt; 1.51, 1.67, 1.68, 1.86, 2.12, 2.19, 2.48, 2.50, 2.53, 2.54, 2.56, 2.62, 2.68, 2.83, 2.88, 2.89, 2.92, 2.98, 3…
$ n_risk     &lt;dbl&gt; 57, 55, 54, 53, 52, 51, 50, 48, 47, 46, 45, 44, 43, 42, 39, 38, 37, 36, 35, 33, 32, 31, 30, 29, 27, 26, 25, 2…
$ n_events   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ n_censored &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 2, 1, 0, 1, 1…
$ `p(t)`     &lt;dbl&gt; 0.01754386, 0.01818182, 0.01851852, 0.01886792, 0.01923077, 0.01960784, 0.02000000, 0.02083333, 0.02127660, 0…
$ `S(t)`     &lt;dbl&gt; 0.98245614, 0.96459330, 0.94673046, 0.92886762, 0.91100478, 0.89314195, 0.87527911, 0.85704413, 0.83880914, 0…
$ `se[S(t)]` &lt;dbl&gt; 0.01738929, 0.02459209, 0.02992911, 0.03428307, 0.03799347, 0.04123439, 0.04410945, 0.04680819, 0.04923621, 0…
$ width      &lt;dbl&gt; 0.10, 0.16, 0.01, 0.18, 0.26, 0.07, 0.29, 0.02, 0.03, 0.01, 0.02, 0.06, 0.06, 0.15, 0.05, 0.01, 0.03, 0.06, 0…
$ `h[km](t)` &lt;dbl&gt; 0.17543860, 0.11363636, 1.85185185, 0.10482180, 0.07396450, 0.28011204, 0.06896552, 1.04166667, 0.70921986, 2…</code></pre>
</div>
</div>
<p>In the <code>n_events</code> column we have the number of cases that experienced the event in a given moment in continuous time. In the <code>n_risk</code> column we have the number of possible cases that could have experienced the event at that moment. In the <code>interval_f</code> column we’ve saved each moment as a factor, conveniently named <span class="math inline">\(1, 2,..., 42\)</span>. Thus we can fit a simple Bayesian Kaplan-Meier model with <code>brms::brm()</code> by specifying <code>formula = n_events | trials(n_risk) ~ 0 + interval_f</code>.</p>
<p>Consider the implications for our priors. Because we’re treating each instance in time as a factor, that means the number of cases experiencing the event in one of those factors will always be 1 or some other small number in the unusual case of a tie. But the number in the denominator, <code>n_risk</code>, will tend to be relatively large, which means the probabilities will tend to be small. The weakly regularizing prior approach centered on zero might not make sense in this context.</p>
<p>In earlier models, we used <code>normal(0, 4)</code> and <code>normal(0, 1.5)</code>. Here’s what those look like when we convert them to the probability metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="fl">1.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior    =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"normal(0, "</span>, sd, <span class="st">")"</span>),</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">levels =</span> <span class="fu">str_c</span>(<span class="st">"normal(0, "</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">4</span>), <span class="st">")"</span>)),</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_odds =</span> <span class="fu">map</span>(sd, rnorm, <span class="at">n =</span> <span class="fl">1e5</span>, <span class="at">mean =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(log_odds) <span class="sc">%&gt;%</span> </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p  =</span> <span class="fu">plogis</span>(log_odds)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p, <span class="at">y =</span> prior)) <span class="sc">+</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_histinterval</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">normalize =</span> <span class="st">"xy"</span>) <span class="sc">+</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(p)),</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"prior (log-odds scale)"</span>) <span class="sc">+</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">2.5</span>)) <span class="sc">+</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>The <code>normal(0, 4)</code> prior does not reflect our expectation that the probabilities will tend to be small. Interestingly, <code>normal(0, 4)</code> pushes a lot of the prior mass to the edges. What we want is a prior that pushed the mass to the left. Here are some options:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crossing</span>(<span class="at">mean =</span> <span class="sc">-</span><span class="dv">4</span><span class="sc">:-</span><span class="dv">1</span>,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd   =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_odds =</span> <span class="fu">map2</span>(mean, sd, rnorm, <span class="at">n =</span> <span class="fl">1e5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(log_odds) <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p    =</span> <span class="fu">plogis</span>(log_odds),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> <span class="fu">factor</span>(<span class="fu">str_c</span>(<span class="st">"mean = "</span>, mean),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="fu">str_c</span>(<span class="st">"mean = "</span>, <span class="sc">-</span><span class="dv">4</span><span class="sc">:-</span><span class="dv">1</span>)),</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd   =</span> <span class="fu">str_c</span>(<span class="st">"sd = "</span>, sd)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_histinterval</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">normalize =</span> <span class="st">"panels"</span>) <span class="sc">+</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="fu">italic</span>(p))) <span class="sc">+</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(sd <span class="sc">~</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>As you decrease the prior mean, the mass in the probability metric heads to zero. Increasing or shrinking the prior standard deviation accelerates or attenuates that leftward concentration. To my way of thinking, we want a prior that, while concentrating the mass toward zero, still offers a good spread toward the middle. Let’s try <code>normal(-4, 3)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> honking_km,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> interval_f,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">3</span>), <span class="at">class =</span> b),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">1</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.03"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: n_events | trials(n_risk) ~ 0 + interval_f 
   Data: honking_km (Number of observations: 42) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
interval_f1     -4.43      1.06    -6.87    -2.73 1.00     4702     2535
interval_f2     -4.40      1.09    -7.00    -2.66 1.00     4766     2223
interval_f3     -4.41      1.12    -6.98    -2.62 1.00     4743     2019
interval_f4     -4.38      1.11    -7.01    -2.60 1.00     4670     2208
interval_f5     -4.34      1.08    -6.92    -2.65 1.00     5038     2567
interval_f6     -4.31      1.08    -6.79    -2.55 1.00     4539     2323
interval_f7     -4.34      1.12    -6.92    -2.57 1.00     4474     2234
interval_f8     -4.28      1.10    -6.83    -2.55 1.00     5000     2210
interval_f9     -4.20      1.07    -6.67    -2.47 1.00     4409     2205
interval_f10    -4.22      1.09    -6.73    -2.53 1.00     4663     2672
interval_f11    -4.22      1.08    -6.72    -2.50 1.00     4237     2001
interval_f12    -4.18      1.05    -6.56    -2.50 1.00     4414     2528
interval_f13    -4.19      1.13    -6.89    -2.44 1.00     3817     1869
interval_f14    -4.15      1.14    -6.81    -2.35 1.00     4949     2442
interval_f15    -4.09      1.10    -6.60    -2.31 1.00     4734     2400
interval_f16    -4.09      1.10    -6.54    -2.34 1.00     4090     2072
interval_f17    -4.03      1.09    -6.56    -2.30 1.00     4762     2707
interval_f18    -4.01      1.10    -6.66    -2.26 1.00     4102     2326
interval_f19    -3.99      1.13    -6.50    -2.20 1.00     4819     2441
interval_f20    -3.93      1.13    -6.46    -2.11 1.00     4249     2175
interval_f21    -3.92      1.12    -6.46    -2.11 1.00     4958     2248
interval_f22    -3.87      1.10    -6.30    -2.13 1.00     4583     2740
interval_f23    -3.84      1.08    -6.31    -2.11 1.00     4713     2566
interval_f24    -3.83      1.14    -6.45    -2.06 1.00     4189     2520
interval_f25    -3.76      1.14    -6.31    -1.91 1.00     5006     2450
interval_f26    -3.75      1.18    -6.56    -1.88 1.00     4858     2151
interval_f27    -3.67      1.15    -6.31    -1.84 1.00     4339     2513
interval_f28    -3.66      1.15    -6.24    -1.79 1.00     4569     2145
interval_f29    -3.58      1.17    -6.34    -1.72 1.00     4551     2312
interval_f30    -3.55      1.17    -6.33    -1.65 1.00     4747     2605
interval_f31    -3.43      1.16    -6.13    -1.58 1.00     4962     2645
interval_f32    -3.37      1.16    -6.10    -1.53 1.00     4005     2352
interval_f33    -3.32      1.15    -6.06    -1.47 1.00     5168     2233
interval_f34    -3.14      1.19    -5.90    -1.22 1.00     4470     1738
interval_f35    -3.02      1.20    -5.83    -1.08 1.00     4831     2127
interval_f36    -2.91      1.19    -5.69    -1.00 1.00     4191     2105
interval_f37    -2.75      1.25    -5.65    -0.69 1.00     5563     2597
interval_f38    -2.48      1.28    -5.35    -0.40 1.00     5155     2789
interval_f39    -2.13      1.33    -5.12     0.07 1.00     5380     2287
interval_f40    -1.87      1.34    -4.85     0.42 1.00     4906     2834
interval_f41    -1.55      1.42    -4.74     0.94 1.00     4980     2405
interval_f42    -0.99      1.55    -4.27     1.83 1.00     5196     2581

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Our parameter diagnostics look excellent. It might be helpful to inspect their posteriors in a plot. Here we show them in both the log-odds and probability metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit13<span class="fl">.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">42</span>) </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"parameter"</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"log_odds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">parameter   =</span> <span class="fu">factor</span>(parameter, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">42</span>),</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">probability =</span> <span class="fu">plogis</span>(log_odds)) <span class="sc">%&gt;%</span> </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(probability<span class="sc">:</span>log_odds) <span class="sc">%&gt;%</span> </span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> parameter)) <span class="sc">+</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(<span class="at">.width =</span> <span class="fl">0.95</span>, <span class="at">normalize =</span> <span class="st">"xy"</span>, <span class="at">size =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(<span class="fu">italic</span>(p))[Bayes](<span class="fu">italic</span>(t[j]))),</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">italic</span>(j))) <span class="sc">+</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">scales =</span> <span class="st">"free_x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Let’s wrangle our <code>draws</code> object a little to put it in a more useful format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(plogis) <span class="sc">%&gt;%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>iter,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"interval"</span>,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">interval =</span> interval <span class="sc">%&gt;%</span> <span class="fu">as.double</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(interval) <span class="sc">%&gt;%</span> </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(iter) <span class="sc">%&gt;%</span> </span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">survivor =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> p)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(draws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 172,000
Columns: 4
$ iter     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, …
$ interval &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ p        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ survivor &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</code></pre>
</div>
</div>
<p>We might want to compare our Bayesian <span class="math inline">\(\hat p(t_j)\)</span> estimates with their Maximum Likelihood counterparts. Since the Bayesian marginal posteriors are rather asymmetrical, we’ll summarize <span class="math inline">\(\hat p_\text{Bayes} (t_j)\)</span> with means, medians, and modes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">interval =</span> <span class="fu">factor</span>(interval, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">42</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval) <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(survivor),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(survivor),</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">mode   =</span> <span class="fu">Mode</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>interval,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"posterior estimate"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> interval, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">`</span><span class="at">posterior estimate</span><span class="st">`</span>),</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">interval =</span> <span class="fu">factor</span>(interval, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">42</span>)),</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"D"</span>, <span class="at">begin =</span> <span class="fl">0.1</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="fu">italic</span>(p))(<span class="fu">italic</span>(t[j])))) <span class="sc">+</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>),</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.8</span>),</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The black dots were the ML estimates and the colored circles were the Bayesian counterparts. Overall, it looks like they matched up pretty well! Building on those sensibilities, here’s an alternative version of the top panel from Figure 13.2, this time comparing the frequentist <span class="math inline">\(\hat S (t_j)\)</span> with our Bayesian counterpart.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval) <span class="sc">%&gt;%</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean   =</span> <span class="fu">mean</span>(survivor),</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(survivor),</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">mode   =</span> <span class="fu">Mode</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>interval,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"posterior estimate"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">distinct</span>(interval, seconds),</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"interval"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seconds =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(seconds), <span class="dv">0</span>, seconds)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">`</span><span class="at">posterior estimate</span><span class="st">`</span>),</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data =</span> honking_km,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"D"</span>, <span class="at">begin =</span> <span class="fl">0.1</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"time"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>),</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.8</span>),</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Again, we showed the ML <span class="math inline">\(\hat S (t_j)\)</span> in black and the Bayesian counterpart as summarized by three alternative measures of central tendency in color. Overall, the results were very similar across methods. What this plot makes clear is that it’s the last few estimates for that where our Bayesian estimates diverge from ML. If you compare this plot with the previous one, it appears that the nature of the divergence is our Bayesian estimates are shrunk a bit toward <span class="math inline">\(p = .5\)</span>, though the modes shrank less than the medians and means. Also recall how uncertain our posteriors were for the last few intervals. This is because the likelihoods for those intervals were incredibly weak. Take a glance at the last few rows in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(honking_km)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
  interval interval_f seconds start    end n_risk n_events n_censored `p(t)` `S(t)` `se[S(t)]` width `h[km](t)`
     &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1       37 37            6.03  6.03   6.3       9        1          1  0.111 0.248      0.0666 0.270     0.412 
2       38 38            6.3   6.3    7.2       7        1          1  0.143 0.213      0.0659 0.9       0.159 
3       39 39            7.2   7.2    9.59      5        1          0  0.2   0.170      0.0650 2.39      0.0837
4       40 40            9.59  9.59  12.3       4        1          0  0.25  0.128      0.0611 2.7       0.0926
5       41 41           12.3  12.3   13.2       3        1          0  0.333 0.0851     0.0535 0.890     0.375 
6       42 42           13.2  13.2  Inf         2        1          1  0.5   0.0425     0.0403 3.97      0.126 </code></pre>
</div>
</div>
<p>Based on the <code>n_risk</code> column, the number of trials ranged from <span class="math inline">\(n = 9\)</span> at <code>interval == 37</code> to <span class="math inline">\(n = 2\)</span> for <code>interval == 42</code>. With so little information informing the likelihood, you largely get back the prior. Moving forward, here’s another version of the survivor function of Figure 13.2, but this time using posterior intervals to highlight uncertainty in the estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># augment draws</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    draws <span class="sc">%&gt;%</span> </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(interval <span class="sc">==</span> <span class="dv">42</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">interval =</span> <span class="dv">43</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(honking_km, interval, seconds),</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">interval =</span> <span class="dv">43</span>, <span class="at">seconds =</span> <span class="fl">17.15</span>)),</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"interval"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seconds =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(seconds), <span class="dv">0</span>, seconds)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> survivor)) <span class="sc">+</span> </span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">linewidth =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fl">5.3</span>, <span class="at">y =</span> <span class="fl">0.54</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"This time the black line is the Bayesian posterior median,</span><span class="sc">\n</span><span class="st">which is the `stat_lineribbon()` default."</span>) <span class="sc">+</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">x =</span> <span class="fl">5.3</span>, <span class="at">xend =</span> <span class="fl">4.2</span>,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="fl">0.55</span>, <span class="at">yend =</span> <span class="fl">0.475</span>,</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.15</span>,<span class="st">"cm"</span>), <span class="at">type =</span> <span class="st">"closed"</span>),</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="st">"CI"</span>, <span class="at">start =</span> <span class="fl">0.8</span>, <span class="at">end =</span> <span class="fl">0.6</span>,</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"95%"</span>, <span class="st">"50%"</span>)) <span class="sc">+</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"time"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>),</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.925</span>, <span class="fl">0.85</span>),</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Just for giggles, here’s how you might depict our <span class="math inline">\(\hat S_\text{Bayes} (t_j)\)</span> with more of a 3D approach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(honking_km, interval, seconds),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">interval =</span> <span class="dv">43</span>, <span class="at">seconds =</span> <span class="fl">17.15</span>)),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"interval"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seconds =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(seconds), <span class="dv">0</span>, seconds)) <span class="sc">%&gt;%</span> </span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> survivor)) <span class="sc">+</span> </span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">.width =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.01</span>, <span class="at">to =</span> <span class="fl">0.99</span>, <span class="at">by =</span> <span class="fl">0.01</span>),</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">step =</span> <span class="st">"hv"</span>, <span class="at">linewidth =</span> <span class="dv">0</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="at">start =</span> <span class="fl">0.89</span>, <span class="at">end =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"time"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-cumulative-hazard-function" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="the-cumulative-hazard-function"><span class="header-section-number">13.4</span> The cumulative hazard function</h2>
<blockquote class="blockquote">
<p>Kaplan-Meier type estimates of hazard are simply too erratic to be meaningful.</p>
<p>This is where the <em>cumulative hazard function</em> comes in. Denoted <span class="math inline">\(H (t_{ij})\)</span>, the cumulative hazard function assesses, at each point in time, the <em>total amount of accumulated risk</em> that individual <span class="math inline">\(i\)</span> has faced from the beginning of time until the present. (p.&nbsp;488, <em>emphasis</em> in the original)</p>
</blockquote>
<p>The cumulative hazard function follows the equation</p>
<p><span class="math display">\[H (t_{ij}) = \underset{\text{between } t_0 \text{ and } t_j}{\text{cumulation}} [h(t_{ij})],\]</span></p>
<p>“where the phrase ‘cumulation between <span class="math inline">\(t_0\)</span> and <span class="math inline">\(t_j\)</span>’ indicates that cumulative hazard totals the infinite number of specific values of <span class="math inline">\(h(t_{ij})\)</span> that exist between <span class="math inline">\(t_0\)</span> and <span class="math inline">\(t_j\)</span>” (p.&nbsp;488).</p>
<section id="understanding-the-meaning-of-cumulative-hazard" class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="understanding-the-meaning-of-cumulative-hazard"><span class="header-section-number">13.4.1</span> Understanding the meaning of cumulative hazard</h3>
<p>Although the absolute values of the cumulative hazard function aren’t particularly illuminating, the overall shape is. Figure 13.3 gives several examples. We don’t have the data or the exact specifications for the functions expressed in Figure 13.3. But if you’re okay with a little imprecision, we can make a few good guesses. Before diving in, it’ll help simplify our subplot code if we make two custom geoms. We’ll call them <code>geom_h()</code> and <code>geom_H()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>geom_h <span class="ot">&lt;-</span> <span class="cf">function</span>(subtitle, ...) {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(...),</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>),</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">italic</span>(h)(<span class="fu">italic</span>(t[ij]))),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">*</span> <span class="fl">0.02</span>),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> subtitle),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>geom_H <span class="ot">&lt;-</span> <span class="cf">function</span>(y_ul, ...) {</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(...),</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">italic</span>(H)(<span class="fu">italic</span>(t[ij])))),</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, y_ul))</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have our custom geoms, here’s the code to make Figure 13.3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a: constant hazard</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">h =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">H =</span> <span class="fu">cumsum</span>(h))</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> h)) <span class="sc">+</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">subtitle =</span> <span class="st">"A: Constant hazard"</span>)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">y_ul =</span> <span class="dv">6</span>)</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co"># b: increasing hazard</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">h =</span> <span class="fl">0.001</span> <span class="sc">*</span> time) <span class="sc">%&gt;%</span>  </span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">H =</span> <span class="fu">cumsum</span>(h))</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> h)) <span class="sc">+</span> </span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">subtitle =</span> <span class="st">"B: Increasing hazard"</span>)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">y_ul =</span> <span class="dv">5</span>)</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="co"># decreasing hazard</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.2</span>, <span class="at">to =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="fl">0.1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note out use of the gamma distribution (see )</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">h =</span> <span class="fu">dgamma</span>(time, <span class="at">shape =</span> <span class="fl">0.02</span>, <span class="at">rate =</span> <span class="fl">0.001</span>)) <span class="sc">%&gt;%</span>  </span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">H =</span> <span class="fu">cumsum</span>(h))</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> h)) <span class="sc">+</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">subtitle =</span> <span class="st">"C: Decreasing hazard"</span>)</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">y_ul =</span> <span class="fl">1.2</span>)</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a><span class="co"># increasing &amp; decreasing hazard</span></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">1</span>, <span class="at">to =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note our use of the Fréchet distribution</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">h =</span> <span class="fu">dfrechet</span>(time, <span class="at">loc =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="dv">250</span>, <span class="at">shape =</span> <span class="fl">0.5</span>) <span class="sc">*</span> <span class="dv">25</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">H =</span> <span class="fu">cumsum</span>(h))</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> h)) <span class="sc">+</span></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">subtitle =</span> <span class="st">"D: Increasing &amp;</span><span class="sc">\n</span><span class="st"> decreasing hazard"</span>)</span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">y_ul =</span> <span class="dv">5</span>)</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a><span class="co"># combine with patchwork and plot!</span></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>((p1 <span class="sc">/</span> p2) <span class="sc">|</span> (p3 <span class="sc">/</span> p4) <span class="sc">|</span> (p5 <span class="sc">/</span> p6) <span class="sc">|</span> (p7 <span class="sc">/</span> p8)) <span class="sc">&amp;</span></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>Did you notice our use of the gamma and Fréchet distributions? Both are supported for continuous-time survival models in <strong>brms</strong> (see Bürkner’s vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_families.html#time-to-event-models"><em>Parameterization of response distributions in brms</em></a>).</p>
</section>
<section id="estimating-the-cumulative-hazard-function" class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="estimating-the-cumulative-hazard-function"><span class="header-section-number">13.4.2</span> Estimating the cumulative hazard function</h3>
<p>The two methods to estimate the cumulative hazard function are the Nelson-Aalen method and the negative log survivor function method. The Nelson-Aalen method used Kaplan-Meier-type hazard estimates as follows:</p>
<p><span class="math display">\[\hat H_\text{NA} (t_j) = \hat h_\text{KM} (t_1) \text{width}_1 + \hat h_\text{KM} (t_2) \text{width}_2 + \dots + \hat h_\text{KM} (t_j) \text{width}_j,\]</span></p>
<p>where <span class="math inline">\(\hat h_\text{KM} (t_j) \text{width}_j\)</span> is the total hazard during the <span class="math inline">\(j\)</span>th interval. The negative log survivor function method makes use of the estimates of the Kaplan-Meier survivor function with the formula</p>
<p><span class="math display">\[\hat H_{- \text{LS}} (t_j) = - \log \hat S_\text{KM} (t_{ij}),\]</span></p>
<p>where <span class="math inline">\(\hat S_\text{KM} (t_{ij})\)</span>, recall, is the cumulative survivor function for the Kaplan-Meier estimator. Here we put both formulas to use and make our version of Figure 13.4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for annotation</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">seconds =</span> <span class="fu">c</span>(<span class="fl">13.15</span>, <span class="fl">13.4</span>),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y       =</span> <span class="fu">c</span>(<span class="fl">3.275</span>, <span class="fl">2.65</span>),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">label   =</span> <span class="fu">c</span>(</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Negative~log~survivor*','*~hat(italic(H))[-LS](italic(t[j]))"</span>, </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nelson-Aalen*','*~hat(italic(H))[N][A](italic(t[j]))"</span>))</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co"># top plot</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> honking_km <span class="sc">%&gt;%</span> </span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">width =</span> <span class="fu">if_else</span>(width <span class="sc">==</span> <span class="cn">Inf</span>, <span class="fl">17.15</span> <span class="sc">-</span> start, width)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">H[na](t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="st">`</span><span class="at">h[km](t)</span><span class="st">`</span> <span class="sc">*</span> width),</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">H[ls](t)</span><span class="st">`</span> <span class="ot">=</span> <span class="sc">-</span> <span class="fu">log</span>(<span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seconds, <span class="st">`</span><span class="at">H[na](t)</span><span class="st">`</span>, <span class="st">`</span><span class="at">H[ls](t)</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">seconds    =</span> <span class="fl">17.15</span>, </span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">H[na](t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">2.78499694</span>, </span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">H[ls](t)</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">3.15764982</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add a line index</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">line =</span> <span class="fu">rep</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">21</span>, <span class="dv">7</span>, <span class="dv">3</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds)) <span class="sc">+</span></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">H[ls](t)</span><span class="st">`</span>),</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">H[na](t)</span><span class="st">`</span>),</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> text,</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">label =</span> label),</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">parse =</span> T) <span class="sc">+</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"time"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(H)(<span class="fu">italic</span>(t[j])))), </span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fl">3.5</span>, <span class="at">by =</span> <span class="fl">0.5</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">3.5</span>)) <span class="sc">+</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a><span class="co"># bottom plot</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p1 <span class="sc">+</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(line <span class="sc">!=</span> <span class="st">"d"</span>),</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">y =</span> (<span class="st">`</span><span class="at">H[ls](t)</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">H[na](t)</span><span class="st">`</span>) <span class="sc">/</span> <span class="dv">2</span>, <span class="at">color =</span> line, <span class="at">fill =</span> line),</span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">"A"</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"A"</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>)</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>))) <span class="sc">/</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Visualizing the cumulative hazard function from our Bayesian <code>fit13.3</code> is a minor extension to the approach we used for the survivor function, above. As an example, here’s our plot for <span class="math inline">\(\hat H_{- \text{LS}} (t_j)\)</span>. The biggest change in the code is the last line in the second <code>mutate()</code> statement, <code>hazard = -log(survivor)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>draws <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(honking_km, interval, seconds),</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">interval =</span> <span class="dv">43</span>, <span class="at">seconds =</span> <span class="fl">17.15</span>)),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"interval"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seconds =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(seconds), <span class="dv">0</span>, seconds),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>         <span class="co"># convert S to H</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">hazard =</span> <span class="sc">-</span><span class="fu">log</span>(survivor)) <span class="sc">%&gt;%</span> </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> seconds, <span class="at">y =</span> hazard)) <span class="sc">+</span> </span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>), <span class="at">linewidth =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="st">"CI"</span>, <span class="at">start =</span> <span class="fl">0.85</span>, <span class="at">end =</span> <span class="fl">0.6</span>,</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"95%"</span>, <span class="st">"80%"</span>, <span class="st">"50%"</span>)) <span class="sc">+</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"time"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(H)[<span class="sc">-</span>LS](<span class="fu">italic</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey92"</span>),</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.925</span>, <span class="fl">0.73</span>),</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="kernel-smoothed-estimates-of-the-hazard-function" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="kernel-smoothed-estimates-of-the-hazard-function"><span class="header-section-number">13.5</span> Kernel-smoothed estimates of the hazard function</h2>
<blockquote class="blockquote">
<p>The idea behind kernel smoothing is simple. At each of many distinct points in time, estimate a function’s average value by aggregating together all the point estimates available within the focal time’s temporal vicinity. Conceptually, kernel-smoothed estimates are a type of moving average. They do not identify precise values of hazard at each point in time but rather approximate values based on the estimates nearby. Even though each smoothed value only approximates the underlying true value, a plot over time can help reveal the underlying function’s shape.</p>
<p>Kernel smoothing requires a set of point estimates to smooth. For the hazard function, one way of obtaining these point estimates is by computing successive differences in the estimated cumulative hazard function from each observed even time until the next. Each difference acts as a pseudo-slope, a measure of the local rate of change in cumulative hazard during that period. Either Nelson-Aalen estimates or negative log survivor function estimates of cumulative hazard can be used. (pp.&nbsp;495–496)</p>
</blockquote>
<p>Singer and Willett showed examples of this smoothing in Figure 13.5, in which they applied a smoothing algorithm to the <span class="math inline">\(H_{- \text{LS}} (t_j)\)</span> estimates. The good folks at <a href="https://stats.idre.ucla.edu/r/examples/alda/r-applied-longitudinal-data-analysis-ch-13/">IDRE</a> have already worked out the code to reproduce Singer and Willette’s smoothing algorithm. The IDRE folks called their custom function <code>smooth()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>my_smooth <span class="ot">&lt;-</span> <span class="cf">function</span>(width, time, survive) { </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  n   <span class="ot">&lt;-</span> <span class="fu">length</span>(time)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  lo  <span class="ot">&lt;-</span> time[<span class="dv">1</span>] <span class="sc">+</span> width</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  hi  <span class="ot">&lt;-</span> time[n] <span class="sc">-</span> width</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  npt <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  inc <span class="ot">&lt;-</span> (hi <span class="sc">-</span> lo) <span class="sc">/</span> npt</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">t</span>(lo <span class="sc">+</span> <span class="fu">t</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>npt)) <span class="sc">*</span> inc)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  slag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, survive[<span class="dv">1</span><span class="sc">:</span>n <span class="sc">-</span> <span class="dv">1</span>])</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  h    <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> survive <span class="sc">/</span> slag</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  x1   <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">rep</span>(<span class="dv">1</span>, npt)) <span class="sc">%*%</span> (<span class="fu">t</span>(time))</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  x2   <span class="ot">&lt;-</span> s <span class="sc">%*%</span> <span class="fu">as.vector</span>(<span class="fu">rep</span>(<span class="dv">1</span>, n))</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  x    <span class="ot">&lt;-</span> (x1 <span class="sc">-</span> x2) <span class="sc">/</span> width</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  k    <span class="ot">&lt;-</span> .<span class="dv">75</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> x <span class="sc">*</span> x) <span class="sc">*</span> (<span class="fu">abs</span>(x) <span class="sc">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> (k <span class="sc">%*%</span> h) <span class="sc">/</span> width</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">x =</span> s, <span class="at">y =</span> lambda)</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve renamed the function <code>my_smooth()</code> to avoid overwriting the already existing <code>smooth()</code> function. The code for <code>my_smooth()</code> is a mild update from the one in the link above in that it returns its results in a data frame. Let’s give it a quick whirl.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">1</span>, </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">time =</span> honking_km<span class="sc">$</span>seconds,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">survive =</span> honking_km<span class="sc">$</span><span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 2
$ x &lt;dbl&gt; 2.6054, 2.8008, 2.9962, 3.1916, 3.3870, 3.5824, 3.7778, 3.9732, 4.1686, 4.3640, 4.5594, 4.7548, 4.9502, 5.1456, 5.3410…
$ y &lt;dbl&gt; 0.32686176, 0.36745825, 0.38958042, 0.38516865, 0.37093732, 0.34810198, 0.33956166, 0.31166618, 0.29193431, 0.27646483…</code></pre>
</div>
</div>
<p>The <code>time</code> and <code>survive</code> arguments take <code>seconds</code> and <code>S(t)</code> values, respectively. The <code>width</code> argument determines over how many values we would like to smooth over on a given point. For example, <code>width = 1</code> would, for a given point on the <code>time</code> axis, aggregate over all values <span class="math inline">\(\pm1\)</span> that point. Larger <code>width</code> values result in more aggressive smoothing. Also notice <code>my_smooth()</code> returned a data frame containing 50 rows for two columns, <code>x</code> and <code>y</code>. Those columns are the coordinates for the <em>TIME</em> and smoothed hazard, respectively. Here we put <code>my_smooth()</code> to work and make our version of Figure 13.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">width =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xy =</span> <span class="fu">map</span>(width, <span class="sc">~</span><span class="fu">my_smooth</span>(<span class="at">width =</span> ., </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">time =</span> honking_km<span class="sc">$</span>seconds, </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">survive =</span> honking_km<span class="sc">$</span><span class="st">`</span><span class="at">S(t)</span><span class="st">`</span>)),</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="fu">str_c</span>(<span class="st">"width = "</span>, width)) <span class="sc">%&gt;%</span> </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(xy) <span class="sc">%&gt;%</span> </span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"seconds after light turns green"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"smoothed hazard"</span>) <span class="sc">+</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> width, <span class="at">nrow =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="developing-an-intuition-about-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="developing-an-intuition-about-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions"><span class="header-section-number">13.6</span> Developing an intuition about continuous-time survivor, cumulative hazard, and kernel-smoothed hazard functions</h2>
<p>Buckle up and load the relapse data from Cooney and colleagues <span class="citation" data-cites="cooney1991MatchingAlcoholics">(<a href="references.html#ref-cooney1991MatchingAlcoholics" role="doc-biblioref">1991</a>)</span>; the US Supreme Court tenure data from Zorn and van Winkle <span class="citation" data-cites="zorn2000CompetingRisks">(<a href="references.html#ref-zorn2000CompetingRisks" role="doc-biblioref">2000</a>)</span>; the first depressive episode data from Sorenson, Rutter, and Aneshensel <span class="citation" data-cites="sorenson1991DepressionInTheComunity">(<a href="references.html#ref-sorenson1991DepressionInTheComunity" role="doc-biblioref">1991</a>)</span>; and the health-workers employment data from Singer and colleagues <span class="citation" data-cites="singer1998PhysicianRetention">(<a href="references.html#ref-singer1998PhysicianRetention" role="doc-biblioref">1998</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>alcohol_relapse  <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/alcohol_relapse.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">rename_all</span>(str_to_lower)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>judges           <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/judges.csv"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>first_depression <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/firstdepression.csv"</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>health_workers   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/healthworkers.csv"</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(alcohol_relapse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 89
Columns: 3
$ weeks  &lt;dbl&gt; 0.7142857, 0.7142857, 1.1428571, 1.4285714, 1.7142857, 1.7142857, 2.1428571, 2.7142857, 3.8571429, 4.1428571, 4.5…
$ censor &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(judges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 109
Columns: 7
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31…
$ tenure &lt;dbl&gt; 1, 6, 6, 9, 21, 9, 1, 13, 4, 15, 31, 4, 34, 30, 16, 19, 23, 34, 20, 2, 32, 14, 32, 5, 28, 15, 28, 19, 27, 5, 23, …
$ dead   &lt;dbl&gt; 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0,…
$ retire &lt;dbl&gt; 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1,…
$ leave  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age    &lt;dbl&gt; 50, 57, 44, 47, 57, 38, 59, 47, 51, 55, 36, 44, 45, 32, 49, 42, 58, 32, 55, 49, 44, 50, 45, 52, 59, 57, 51, 57, 5…
$ year   &lt;dbl&gt; 1789, 1789, 1789, 1789, 1789, 1790, 1791, 1793, 1796, 1796, 1798, 1799, 1801, 1804, 1806, 1807, 1811, 1811, 1823,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(first_depression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,974
Columns: 3
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31…
$ age    &lt;dbl&gt; 4, 6, 8, 8, 9, 9, 10, 10, 11, 12, 12, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 15,…
$ censor &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(health_workers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,074
Columns: 3
$ id     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31…
$ weeks  &lt;dbl&gt; 0.14, 0.42, 1.00, 1.28, 1.28, 1.71, 1.85, 1.85, 1.85, 2.00, 2.14, 2.14, 2.14, 2.28, 2.28, 2.28, 3.00, 3.00, 3.14,…
$ censor &lt;dbl&gt; 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
</div>
<p>For our first go, just fit the models with <code>survfit()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> alcohol_relapse,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(weeks, <span class="fu">abs</span>(censor <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> judges,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(tenure, leave) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> first_depression,</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(age, <span class="fu">abs</span>(censor <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> health_workers,</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(weeks, <span class="fu">abs</span>(censor <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">~</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the model from Section 13.3, we organized the Kaplan-Meier output in a tibble following the outline of Table 13.3 (p.&nbsp;484). That layout was useful for plotting the frequentist results and for fitting the Bayesian version of the model with <strong>brms</strong>. Since we’re juggling four models, let’s make a convenience function to do that with a single line of code. Call it <code>km_tibble()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>km_tibble <span class="ot">&lt;-</span> <span class="cf">function</span>(surv_fit) {</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">summary</span>(surv_fit)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  length <span class="ot">&lt;-</span> <span class="fu">length</span>(t<span class="sc">$</span>time)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">time     =</span> <span class="fu">c</span>(<span class="dv">0</span>, t<span class="sc">$</span>time),</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">n_risk   =</span> <span class="fu">c</span>(t<span class="sc">$</span>n.risk[<span class="dv">1</span>], t<span class="sc">$</span>n.risk),</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">n_events =</span> <span class="fu">c</span>(<span class="dv">0</span>, t<span class="sc">$</span>n.event)) <span class="sc">%&gt;%</span> </span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p        =</span> n_events <span class="sc">/</span> n_risk,</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">n_censored =</span> n_risk <span class="sc">-</span> n_events <span class="sc">-</span> <span class="fu">lead</span>(n_risk, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">interval   =</span> <span class="dv">0</span><span class="sc">:</span>length,</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">interval_f =</span> <span class="fu">factor</span>(<span class="dv">0</span><span class="sc">:</span>length, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">c</span>(length <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(interval<span class="sc">:</span>interval_f, time, n_risk<span class="sc">:</span>n_events, n_censored, p) <span class="sc">%&gt;%</span> </span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">S =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> p)) <span class="sc">%&gt;%</span> </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">H =</span> <span class="fu">ifelse</span>(interval <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, </span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(S <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>,</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">-</span><span class="fu">log</span>(S))),</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">p =</span> <span class="fu">ifelse</span>(interval <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, p))</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>    d, </span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">%&gt;%</span> </span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice</span>(<span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">interval   =</span> length <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">interval_f =</span> <span class="fu">factor</span>(length <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">c</span>(length <span class="sc">+</span> <span class="dv">1</span>)),</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">time       =</span> surv_fit<span class="sc">$</span>time <span class="sc">%&gt;%</span> <span class="fu">max</span>()))</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s an example of our custom <code>km_tibble()</code> function works based on our earlier model of the <code>honking</code> data, <code>fit13.2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">km_tibble</span>(fit13<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 44 × 9
   interval interval_f  time n_risk n_events n_censored       p     S       H
      &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1        0 0           0        57        0          0 NA      1     NA     
 2        1 1           1.41     57        1          1  0.0175 0.982  0.0177
 3        2 2           1.51     55        1          0  0.0182 0.965  0.0360
 4        3 3           1.67     54        1          0  0.0185 0.947  0.0547
 5        4 4           1.68     53        1          0  0.0189 0.929  0.0738
 6        5 5           1.86     52        1          0  0.0192 0.911  0.0932
 7        6 6           2.12     51        1          0  0.0196 0.893  0.113 
 8        7 7           2.19     50        1          1  0.02   0.875  0.133 
 9        8 8           2.48     48        1          0  0.0208 0.857  0.154 
10        9 9           2.5      47        1          0  0.0213 0.839  0.176 
# ℹ 34 more rows</code></pre>
</div>
</div>
<p>Now apply <code>km_tibble()</code> to our four new fits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>km <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ml_fit =</span> <span class="fu">str_c</span>(<span class="st">"fit13."</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d =</span> <span class="fu">map</span>(ml_fit, <span class="sc">~</span> <span class="fu">get</span>(.) <span class="sc">%&gt;%</span> <span class="fu">km_tibble</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we want the settings in our <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-axes to differ across subplots, good old <code>facet_wrap()</code> and <code>facet_grid()</code> aren’t going to cut it for our version of Figure 13.6. To avoid needless repetition in the settings across subplot code, we’ll make a few custom geoms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>geom_S <span class="ot">&lt;-</span> <span class="cf">function</span>(x_ul, <span class="at">y_lab =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span>),</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>(...),</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, x_ul)),</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(y_lab, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">".5"</span>, <span class="st">"1"</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>geom_H <span class="ot">&lt;-</span> <span class="cf">function</span>(x_ul, <span class="at">y_lab =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>(...),</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, x_ul)),</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(y_lab, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>geom_h <span class="ot">&lt;-</span> <span class="cf">function</span>(x_lab, x_ul, <span class="at">y_lab =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(...),</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(x_lab, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, x_ul)),</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(y_lab, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>geom_S()</code> to make and save the top row, the <span class="math inline">\(\widehat{S (t_j)}\)</span> plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.4"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Cooney et al (1991)"</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.5"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Zorn &amp;  Van Winkle (2000)"</span>)</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.6"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Sorenson et al (1991)"</span>)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.7"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Singer et al (1998)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>geom_H()</code> to make and save the middle row, the <span class="math inline">\(\widehat{H (t_j)}\)</span> plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.4"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">H</span>(t[j])))))</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.5"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.6"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> km <span class="sc">%&gt;%</span> </span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ml_fit <span class="sc">==</span> <span class="st">"fit13.7"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>geom_h()</code> to make and save the bottom row, the <span class="math inline">\(\widehat{h (t_j)}\)</span> plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>p9 <span class="ot">&lt;-</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> fit13<span class="fl">.4</span><span class="sc">$</span>time, <span class="at">survive =</span> fit13<span class="fl">.4</span><span class="sc">$</span>surv) <span class="sc">%&gt;%</span> </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"weeks after discharge"</span>, <span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">h</span>(t[j])))))</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>p10 <span class="ot">&lt;-</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">5</span>, <span class="at">time =</span> fit13<span class="fl">.5</span><span class="sc">$</span>time, <span class="at">survive =</span> fit13<span class="fl">.5</span><span class="sc">$</span>surv) <span class="sc">%&gt;%</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"years on court"</span>, <span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>p11 <span class="ot">&lt;-</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">7</span>, <span class="at">time =</span> fit13<span class="fl">.6</span><span class="sc">$</span>time, <span class="at">survive =</span> fit13<span class="fl">.6</span><span class="sc">$</span>surv) <span class="sc">%&gt;%</span> </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"age (in years)"</span>, <span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>p12 <span class="ot">&lt;-</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> fit13<span class="fl">.7</span><span class="sc">$</span>time, <span class="at">survive =</span> fit13<span class="fl">.7</span><span class="sc">$</span>surv) <span class="sc">%&gt;%</span> </span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"weeks since hired"</span>, <span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, combine the subplots and behold our version of Figure 13.6!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>((p1 <span class="sc">/</span> p5 <span class="sc">/</span> p9) <span class="sc">|</span> (p2 <span class="sc">/</span> p6 <span class="sc">/</span> p10) <span class="sc">|</span> (p3 <span class="sc">/</span> p7 <span class="sc">/</span> p11) <span class="sc">|</span> (p4 <span class="sc">/</span> p8 <span class="sc">/</span> p12)) <span class="sc">&amp;</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<section id="bonus-bayesians-can-compare-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions-too" class="level3" data-number="13.6.1">
<h3 data-number="13.6.1" class="anchored" data-anchor-id="bonus-bayesians-can-compare-continuous-time-survivor-cumulative-hazard-and-kernel-smoothed-hazard-functions-too"><span class="header-section-number">13.6.1</span> Bonus: Bayesians can compare continuous-time survivor, cumulative hazard, and kernel-smoothed hazard functions, too</h3>
<p>Now let’s repeat that process as Bayesians. Here we fit those last four models with <code>brm()</code>. Note the <code>data</code> statements. Filtering by <code>ml_fit</code> allowed us to select the correct subset of data saved in <code>km</code>. The two filtering statements by <code>interval</code> allowed us to focus on the actual data instead of including the two rows we added for plotting conveniences. Otherwise the <code>brm()</code> code is just like what we used before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">filter</span>(km, ml_fit <span class="sc">==</span> <span class="st">"fit13.4"</span> <span class="sc">&amp;</span> interval <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> interval <span class="sc">&lt;</span> <span class="dv">61</span>),</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> interval_f,</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">3</span>), <span class="at">class =</span> b),</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.08"</span>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.9</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">filter</span>(km, ml_fit <span class="sc">==</span> <span class="st">"fit13.5"</span> <span class="sc">&amp;</span> interval <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> interval <span class="sc">&lt;</span> <span class="dv">34</span>),</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> interval_f,</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">3</span>), <span class="at">class =</span> b),</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.09"</span>)</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">filter</span>(km, ml_fit <span class="sc">==</span> <span class="st">"fit13.6"</span> <span class="sc">&amp;</span> interval <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> interval <span class="sc">&lt;</span> <span class="dv">44</span>),</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> interval_f,</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">3</span>), <span class="at">class =</span> b),</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.10"</span>)</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>fit13<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">filter</span>(km, ml_fit <span class="sc">==</span> <span class="st">"fit13.7"</span> <span class="sc">&amp;</span> interval <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> interval <span class="sc">&lt;</span> <span class="dv">306</span>),</span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>  n_events <span class="sc">|</span> <span class="fu">trials</span>(n_risk) <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> interval_f,</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">3</span>), <span class="at">class =</span> b),</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">2000</span>, <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits/fit13.11"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the sake of space, I’m not going to show all the summary output. If you’re following along, I still recommend you give them a look. Spoiler alert: the parameter diagnostics look great.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.8</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.9</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.10</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13<span class="fl">.11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we’re working with four <code>brm()</code> fits, it might make sense to bundle the steps and keep the results in one place. Here we make something of a super function. With <code>wrangle_draws()</code>, we’ll extract the posterior draws from each model; add a couple interval columns; convert the results to the <span class="math inline">\(\widehat{p (t_j)}\)</span>, <span class="math inline">\(\widehat{S (t_j)}\)</span>, and <span class="math inline">\(\widehat{H (t_j)}\)</span> metrics; and join the results to the data stored in <code>km</code>. If the steps seem overwhelming, just flip back to the ends of Sections 13.3 and 13.4. This is a small extension of the data wrangling steps we took to make the <span class="math inline">\(\widehat{S (t_j)}\)</span> and <span class="math inline">\(\widehat{H (t_j)}\)</span> plots for our <strong>brms</strong> model <code>fit13.3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>wrangle_draws <span class="ot">&lt;-</span> <span class="cf">function</span>(brms, survfit) {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract the draws</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  draws <span class="ot">&lt;-</span> <span class="fu">get</span>(brms) <span class="sc">%&gt;%</span> </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"b_"</span>))</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># how many columns?</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  n_col <span class="ot">&lt;-</span> <span class="fu">ncol</span>(draws)  </span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform to the p metric, add a 0 interval, make it long, and add S</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  draws <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_names</span>(<span class="dv">1</span><span class="sc">:</span>n_col) <span class="sc">%&gt;%</span> </span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_all</span>(plogis) <span class="sc">%&gt;%</span> </span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">draw =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>draw,</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"interval"</span>,</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">interval =</span> interval <span class="sc">%&gt;%</span> <span class="fu">as.double</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(interval) <span class="sc">%&gt;%</span> </span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(draw) <span class="sc">%&gt;%</span> </span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">S =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> p)) <span class="sc">%&gt;%</span> </span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">H =</span> <span class="sc">-</span><span class="fu">log</span>(S))</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the final interval, join the data, and return()</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(draws,</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>            draws <span class="sc">%&gt;%</span> <span class="fu">filter</span>(interval <span class="sc">==</span> n_col) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">interval =</span> n_col <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(km <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ml_fit <span class="sc">==</span> survfit) <span class="sc">%&gt;%</span> <span class="fu">select</span>(interval<span class="sc">:</span>n_censored),</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="st">"interval"</span>)</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our <code>wrangle_draws()</code> function takes two arguments, <code>brms</code> and <code>survfit</code>, which indicate the desired <strong>brms</strong> model and the corresponding index within <code>km</code> that contains the associated survival data. Let’s put it to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">brms    =</span> <span class="fu">str_c</span>(<span class="st">"fit13."</span>, <span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>),</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">survfit =</span> <span class="fu">str_c</span>(<span class="st">"fit13."</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">draw =</span> <span class="fu">map2</span>(brms, survfit, wrangle_draws)) <span class="sc">%&gt;%</span> </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(draw)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>draws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,796,000 × 12
   brms    survfit  draw interval     p     S     H interval_f  time n_risk n_events n_censored
   &lt;chr&gt;   &lt;chr&gt;   &lt;int&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1 fit13.8 fit13.4     1        0     0     1     0 0              0     89        0          0
 2 fit13.8 fit13.4     2        0     0     1     0 0              0     89        0          0
 3 fit13.8 fit13.4     3        0     0     1     0 0              0     89        0          0
 4 fit13.8 fit13.4     4        0     0     1     0 0              0     89        0          0
 5 fit13.8 fit13.4     5        0     0     1     0 0              0     89        0          0
 6 fit13.8 fit13.4     6        0     0     1     0 0              0     89        0          0
 7 fit13.8 fit13.4     7        0     0     1     0 0              0     89        0          0
 8 fit13.8 fit13.4     8        0     0     1     0 0              0     89        0          0
 9 fit13.8 fit13.4     9        0     0     1     0 0              0     89        0          0
10 fit13.8 fit13.4    10        0     0     1     0 0              0     89        0          0
# ℹ 1,795,990 more rows</code></pre>
</div>
</div>
<p>Like before, we have 12 subplots to make and we can reduce redundancies in the code by working with custom geoms. To accommodate our Bayesian fits, we’ll redefine <code>geom_S()</code> and <code>geom_H()</code> to depict the step functions with <code>tidybayes::stat_lineribbon()</code>. Happily, our <code>geom_h()</code> is good to go as is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>geom_S <span class="ot">&lt;-</span> <span class="cf">function</span>(x_ul, <span class="at">y_lab =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"white"</span>),</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">show.legend =</span> F, ...),</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_grey</span>(<span class="at">start =</span> <span class="fl">0.8</span>, <span class="at">end =</span> <span class="fl">0.6</span>),</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, x_ul)),</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(y_lab, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">".5"</span>, <span class="st">"1"</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>geom_H <span class="ot">&lt;-</span> <span class="cf">function</span>(x_ul, <span class="at">y_lab =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_lineribbon</span>(<span class="at">step =</span> <span class="st">"hv"</span>, <span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), </span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linewidth =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">show.legend =</span> F, ...),</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_grey</span>(<span class="at">start =</span> <span class="fl">0.8</span>, <span class="at">end =</span> <span class="fl">0.6</span>),</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="cn">NULL</span>, <span class="at">breaks =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, x_ul)),</span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(y_lab, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make and save the subplots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use `geom_S()` to make and save the top row</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.8"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">S</span>(t[j]))))) <span class="sc">+</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Cooney et al (1991)"</span>)</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.9"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Zorn &amp;  Van Winkle (2000)"</span>)</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.10"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Sorenson et al (1991)"</span>)</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.11"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> S)) <span class="sc">+</span></span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_S</span>(<span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Singer et al (1998)"</span>)</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a><span class="co"># use `geom_H()` to make and save the middle row</span></span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.8"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">H</span>(t[j])))))</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.9"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.10"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.11"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> H)) <span class="sc">+</span></span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_H</span>(<span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a><span class="co"># use `geom_h()` to make and save the bottom row</span></span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>p9 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.8"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval, time) <span class="sc">%&gt;%</span> </span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median =</span> <span class="fu">median</span>(S)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">smooth =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> .<span class="sc">$</span>time, <span class="at">survive =</span> .<span class="sc">$</span>median))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(smooth) <span class="sc">%&gt;%</span></span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"weeks after discharge"</span>, <span class="at">x_ul =</span> <span class="dv">110</span>, <span class="at">y_lab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(<span class="fu">italic</span>(<span class="fu">h</span>(t[j])))))</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>p10 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.9"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval, time) <span class="sc">%&gt;%</span> </span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median =</span> <span class="fu">median</span>(S)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">smooth =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> .<span class="sc">$</span>time, <span class="at">survive =</span> .<span class="sc">$</span>median))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(smooth) <span class="sc">%&gt;%</span></span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"years on court"</span>, <span class="at">x_ul =</span> <span class="dv">36</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>p11 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-69"><a href="#cb112-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.10"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-70"><a href="#cb112-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval, time) <span class="sc">%&gt;%</span> </span>
<span id="cb112-71"><a href="#cb112-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median =</span> <span class="fu">median</span>(S)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-72"><a href="#cb112-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb112-73"><a href="#cb112-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">smooth =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> .<span class="sc">$</span>time, <span class="at">survive =</span> .<span class="sc">$</span>median))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-74"><a href="#cb112-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(smooth) <span class="sc">%&gt;%</span></span>
<span id="cb112-75"><a href="#cb112-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb112-76"><a href="#cb112-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"age (in years)"</span>, <span class="at">x_ul =</span> <span class="dv">102</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span>
<span id="cb112-77"><a href="#cb112-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-78"><a href="#cb112-78" aria-hidden="true" tabindex="-1"></a>p12 <span class="ot">&lt;-</span> draws <span class="sc">%&gt;%</span> </span>
<span id="cb112-79"><a href="#cb112-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(brms <span class="sc">==</span> <span class="st">"fit13.11"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-80"><a href="#cb112-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval, time) <span class="sc">%&gt;%</span> </span>
<span id="cb112-81"><a href="#cb112-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median =</span> <span class="fu">median</span>(S)) <span class="sc">%&gt;%</span> </span>
<span id="cb112-82"><a href="#cb112-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb112-83"><a href="#cb112-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">smooth =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">my_smooth</span>(<span class="at">width =</span> <span class="dv">12</span>, <span class="at">time =</span> .<span class="sc">$</span>time, <span class="at">survive =</span> .<span class="sc">$</span>median))) <span class="sc">%&gt;%</span> </span>
<span id="cb112-84"><a href="#cb112-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(smooth) <span class="sc">%&gt;%</span></span>
<span id="cb112-85"><a href="#cb112-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb112-86"><a href="#cb112-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_h</span>(<span class="at">x_lab =</span> <span class="st">"weeks since hired"</span>, <span class="at">x_ul =</span> <span class="dv">150</span>, <span class="at">y_lab =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, combine the subplots and behold our Bayesian alternative version of Figure 13.6!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>((p1 <span class="sc">/</span> p5 <span class="sc">/</span> p9) <span class="sc">|</span> (p2 <span class="sc">/</span> p6 <span class="sc">/</span> p10) <span class="sc">|</span> (p3 <span class="sc">/</span> p7 <span class="sc">/</span> p11) <span class="sc">|</span> (p4 <span class="sc">/</span> p8 <span class="sc">/</span> p12)) <span class="sc">&amp;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="13_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="session-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="session-info">Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Ventura 13.4

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] survival_3.8-3  patchwork_1.3.2 tidybayes_3.0.7 brms_2.23.0     Rcpp_1.1.0      lubridate_1.9.4 forcats_1.0.1  
 [8] stringr_1.6.0   dplyr_1.1.4     purrr_1.2.1     readr_2.1.5     tidyr_1.3.2     tibble_3.3.1    ggplot2_4.0.1  
[15] tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        svUnit_1.0.8            viridisLite_0.4.2       farver_2.1.2            loo_2.9.0.9000         
 [6] S7_0.2.1                fastmap_1.2.0           TH.data_1.1-4           tensorA_0.36.2.1        digest_0.6.39          
[11] timechange_0.3.0        estimability_1.5.1      lifecycle_1.0.5         StanHeaders_2.36.0.9000 magrittr_2.0.4         
[16] posterior_1.6.1.9000    compiler_4.5.1          rlang_1.1.7             tools_4.5.1             utf8_1.2.6             
[21] knitr_1.51              labeling_0.4.3          bridgesampling_1.2-1    htmlwidgets_1.6.4       curl_7.0.0             
[26] pkgbuild_1.4.8          bit_4.6.0               plyr_1.8.9              RColorBrewer_1.1-3      abind_1.4-8            
[31] multcomp_1.4-29         withr_3.0.2             grid_4.5.1              stats4_4.5.1            inline_0.3.21          
[36] xtable_1.8-4            emmeans_1.11.2-8        scales_1.4.0            MASS_7.3-65             cli_3.6.5              
[41] mvtnorm_1.3-3           rmarkdown_2.30          crayon_1.5.3            generics_0.1.4          RcppParallel_5.1.11-1  
[46] rstudioapi_0.17.1       reshape2_1.4.5          tzdb_0.5.0              rstan_2.36.0.9000       splines_4.5.1          
[51] bayesplot_1.15.0.9000   parallel_4.5.1          matrixStats_1.5.0       vctrs_0.6.5             V8_8.0.1               
[56] Matrix_1.7-3            sandwich_3.1-1          jsonlite_2.0.0          hms_1.1.4               arrayhelpers_1.1-0     
[61] bit64_4.6.0-1           ggdist_3.3.3            glue_1.8.0              codetools_0.2-20        distributional_0.5.0   
[66] stringi_1.8.7           gtable_0.3.6            QuickJSR_1.8.1          pillar_1.11.1           htmltools_0.5.9        
[71] Brobdingnag_1.2-9       R6_2.6.1                vroom_1.6.6             evaluate_1.0.5          lattice_0.22-7         
[76] backports_1.5.0         rstantools_2.5.0.9000   gridExtra_2.3           coda_0.19-4.1           nlme_3.1-168           
[81] checkmate_2.3.3         mgcv_1.9-3              xfun_0.55               zoo_1.8-14              pkgconfig_2.0.3        </code></pre>
</div>
</div>
</section>
<section id="comments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="comments">Comments</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-Bürkner2021Parameterization" class="csl-entry" role="listitem">
Bürkner, P.-C. (2021). <em>Parameterization of response distributions in brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_families.html">https://CRAN.R-project.org/package=brms/vignettes/brms_families.html</a>
</div>
<div id="ref-cooney1991MatchingAlcoholics" class="csl-entry" role="listitem">
Cooney, N. L., Kadden, R. M., Litt, M. D., &amp; Getter, H. (1991). Matching alcoholics to coping skills or interactional therapies: <span class="nocase">Two-year</span> follow-up results. <em>Journal of Consulting and Clinical Psychology</em>, <em>59</em>(4), 598. <a href="https://doi.org/10.1037/0022-006X.59.4.598">https://doi.org/10.1037/0022-006X.59.4.598</a>
</div>
<div id="ref-diekmann1996social" class="csl-entry" role="listitem">
Diekmann, A., Jungbauer-Gans, M., Krassnig, H., &amp; Lorenz, S. (1996). Social status and aggression: <span>A</span> field study analyzed by survival analysis. <em>The Journal of Social Psychology</em>, <em>136</em>(6), 761–768. <a href="https://doi.org/10.1080/00224545.1996.9712252">https://doi.org/10.1080/00224545.1996.9712252</a>
</div>
<div id="ref-kaplan1958NonparametricEstimation" class="csl-entry" role="listitem">
Kaplan, E. L., &amp; Meier, P. (1958). Nonparametric estimation from incomplete observations. <em>Journal of the American Statistical Association</em>, <em>53</em>(282), 457–481. <a href="https://doi.org/10.1080/01621459.1958.10501452">https://doi.org/10.1080/01621459.1958.10501452</a>
</div>
<div id="ref-lawless1982StatisticalModels" class="csl-entry" role="listitem">
Lawless, J. F. (1982). <em>Statistical models and methods for lifetime data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-miller1981SurvivalAnalysis" class="csl-entry" role="listitem">
Miller, R. G. (1981). <em>Survival analysis</em>. John Wiley &amp; Sons.
</div>
<div id="ref-singer1998PhysicianRetention" class="csl-entry" role="listitem">
Singer, J. D., Davidson, S. M., Graham, S., &amp; Davidson, H. S. (1998). Physician retention in community and migrant health centers: <span>Who</span> stays and for how long? <em>Medical Care</em>, 1198–1213. <a href="http://www.jstor.org/stable/3766886">http://www.jstor.org/stable/3766886</a>
</div>
<div id="ref-singerAppliedLongitudinalData2003" class="csl-entry" role="listitem">
Singer, J. D., &amp; Willett, J. B. (2003). <em>Applied longitudinal data analysis: <span>Modeling</span> change and event occurrence</em>. Oxford University Press, USA. <a href="https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968">https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780195152968.001.0001/acprof-9780195152968</a>
</div>
<div id="ref-sorenson1991DepressionInTheComunity" class="csl-entry" role="listitem">
Sorenson, S. B., Rutter, C. M., &amp; Aneshensel, C. S. (1991). Depression in the community: <span>An</span> investigation into age of onset. <em>Journal of Consulting and Clinical Psychology</em>, <em>59</em>(4), 541. <a href="https://doi.org/10.1037/0022-006X.59.4.541">https://doi.org/10.1037/0022-006X.59.4.541</a>
</div>
<div id="ref-zorn2000CompetingRisks" class="csl-entry" role="listitem">
Zorn, C. J., &amp; Van Winkle, S. R. (2000). A competing risks model of <span>Supreme Court</span> vacancies, 1789–1992. <em>Political Behavior</em>, <em>22</em>(2), 145–166. <a href="https://doi.org/10.1023/A:1006667601289">https://doi.org/10.1023/A:1006667601289</a>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/solomon\.quarto\.pub\/alda\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse";
    script.dataset.repoId = "";
    script.dataset.category = "General";
    script.dataset.categoryId = "";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./12.html" class="pagination-link" aria-label="Extending the Discrete-Time Hazard Model">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Extending the Discrete-Time Hazard Model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ASKurz/Applied-Longitudinal-Data-Analysis-with-brms-and-the-tidyverse/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>